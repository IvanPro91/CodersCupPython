<div class="single-editor" data-editor-id="{{ tab_id }}">
    <div class="single-header">
        <div class="single-info">
            <div class="single-icon">
                <i class="fab fa-python"></i>
            </div>
            <div class="single-title">{{ name }}</div>
            <div class="font-size-controls">
                <button class="font-btn" onclick="decreaseFontSize('{{ tab_id }}')" title="–£–º–µ–Ω—å—à–∏—Ç—å —à—Ä–∏—Ñ—Ç">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="font-size-display" id="fontSize_{{ tab_id }}">14px</span>
                <button class="font-btn" onclick="increaseFontSize('{{ tab_id }}')" title="–£–≤–µ–ª–∏—á–∏—Ç—å —à—Ä–∏—Ñ—Ç">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="header-actions">
            <button class="tab-run-btn" id="tabRunBtn_{{ tab_id }}">
                <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="editor-content-wrapper">
        <div class="code-mirror-wrapper" id="editorContainer_{{ tab_id }}">
            <!-- Monaco Editor –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∑–¥–µ—Å—å -->
        </div>

        <!-- –ë–ª–æ–∫ —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∏ –∫–ª–∞—Å—Å–∞–º–∏ -->
        <div class="code-structure-sidebar" id="structureSidebar_{{ tab_id }}">
            <div class="structure-header">
                <i class="fas fa-sitemap"></i>
                <span>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞</span>
            </div>
            <div class="structure-content">
                <!-- –§—É–Ω–∫—Ü–∏–∏ -->
                <div class="structure-section" id="functionsSection_{{ tab_id }}">
                    <div class="section-header" onclick="toggleSection('functionsSection_{{ tab_id }}')">
                        <i class="fas fa-code"></i>
                        <span>–§—É–Ω–∫—Ü–∏–∏ (<span id="functionCountDisplay_{{ tab_id }}">0</span>)</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-items" id="functionsList_{{ tab_id }}">
                        <!-- –§—É–Ω–∫—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                    </div>
                </div>

                <!-- –ö–ª–∞—Å—Å—ã -->
                <div class="structure-section" id="classesSection_{{ tab_id }}">
                    <div class="section-header" onclick="toggleSection('classesSection_{{ tab_id }}')">
                        <i class="fas fa-cube"></i>
                        <span>–ö–ª–∞—Å—Å—ã (<span id="classCountDisplay_{{ tab_id }}">0</span>)</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-items" id="classesList_{{ tab_id }}">
                        <!-- –ö–ª–∞—Å—Å—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                    </div>
                </div>

                <!-- –ò–º–ø–æ—Ä—Ç—ã -->
                <div class="structure-section" id="importsSection_{{ tab_id }}">
                    <div class="section-header" onclick="toggleSection('importsSection_{{ tab_id }}')">
                        <i class="fas fa-file-import"></i>
                        <span>–ò–º–ø–æ—Ä—Ç—ã</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-items" id="importsList_{{ tab_id }}">
                        <!-- –ò–º–ø–æ—Ä—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å –±–∞—Ä -->
    <div class="editor-status-bar" id="statusBar_{{ tab_id }}">
        <div class="status-stats">
            <!-- –í—Å–µ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ -->
            <div class="stat-item" data-tooltip="–í—Å–µ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤">
                <i class="fas fa-font"></i>
                <span id="nonSpaceChars_{{ tab_id }}">0</span>
            </div>

            <!-- –í—Å–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–π -->
            <div class="stat-item" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—É–Ω–∫—Ü–∏–π">
                <i class="fas fa-code"></i>
                <span id="functionCount_{{ tab_id }}">0</span>
            </div>

            <!-- –í—Å–µ–≥–æ –∫–ª–∞—Å—Å–æ–≤ -->
            <div class="stat-item" data-tooltip="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∞—Å—Å–æ–≤">
                <i class="fas fa-cube"></i>
                <span id="classCount_{{ tab_id }}">0</span>
            </div>

            <!-- –í—ã–¥–µ–ª–µ–Ω–æ —Å–∏–º–≤–æ–ª–æ–≤ -->
            <div class="stat-item" data-tooltip="–í—ã–¥–µ–ª–µ–Ω–æ —Å–∏–º–≤–æ–ª–æ–≤">
                <i class="fas fa-highlighter"></i>
                <span id="selectedChars_{{ tab_id }}">0</span>
            </div>

            <!-- –û—à–∏–±–∫–∏ PEP8 -->
            <div class="stat-item error-stat" id="pep8Errors_{{ tab_id }}" data-tooltip="–û—à–∏–±–∫–∏ PEP8">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorCount_{{ tab_id }}">0</span>
            </div>
        </div>
    </div>
</div>

<div class="console-container" data-console-id="{{ tab_id }}" id="consoleContainer_{{ tab_id }}">
    <div class="console-header">
        <div class="console-title">
            <i class="fas fa-terminal"></i> –ö–æ–Ω—Å–æ–ª—å
            <span class="console-status" id="consoleStatus_{{ tab_id }}"></span>
        </div>
        <div class="console-actions">
            <button class="console-btn" id="clearConsoleBtn_{{ tab_id }}" title="–û—á–∏—Å—Ç–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å">
                <i class="fas fa-broom"></i>
            </button>
            <button class="console-btn" id="expandConsoleBtn_{{ tab_id }}" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Å–æ–ª—å">
                <i class="fas fa-expand-alt"></i>
            </button>
            <button class="console-btn" id="collapseConsoleBtn_{{ tab_id }}" title="–°–≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Å–æ–ª—å"
                    style="display: none;">
                <i class="fas fa-compress-alt"></i>
            </button>
        </div>
    </div>

    <!-- –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ -->
    <div class="console-resize-handle" id="consoleResize_{{ tab_id }}"></div>

    <div class="console-output" id="consoleOutput_{{ tab_id }}">
        <div class="console-line info">–ì–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥–∞</div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—à–∏–±–æ–∫ PEP8 -->
<div class="pep8-errors-modal" id="pep8ErrorsModal_{{ tab_id }}" style="display: none;">
    <div class="pep8-modal-header">
        <h4><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∏ PEP8</h4>
        <span class="close-modal" onclick="hidePEP8Modal('{{ tab_id }}')">&times;</span>
    </div>
    <div class="pep8-modal-body">
        <div class="errors-list" id="errorsList_{{ tab_id }}">
            <!-- –û—à–∏–±–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ -->
        </div>
    </div>
    <div class="pep8-modal-footer">
        <button onclick="hidePEP8Modal('{{ tab_id }}')">
            –ó–∞–∫—Ä—ã—Ç—å
        </button>
    </div>
</div>

<script>
    if (typeof window.MonacoEditor === 'undefined') {
        window.MonacoEditor = class MonacoEditor {
            constructor(tabId, name, initialCode = '') {
                this.tabId = tabId;
                this.name = name;
                this.initialCode = initialCode;
                this.editor = null;
                this.fontSize = localStorage.getItem('monacoeditor_fontsize') || 14;
                this.stats = {
                    totalChars: 0,
                    nonSpaceChars: 0,
                    functionCount: 0,
                    classCount: 0,
                    selectedChars: 0,
                    selectedNonSpaceChars: 0,
                    selectedWords: 0,
                    selectedLines: 0,
                    errors: 0
                };
                this.functions = [];
                this.classes = [];
                this.imports = [];
                this.errors = [];
                this.pep8Limit = 119;

                // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
                this.taskData = {
                    forbiddenWords: [],
                    examples: [{
                        input: '',
                        output: ''
                    }],
                    tags: ['python', '–∑–∞–¥–∞—á–∞'],
                    constraints: {
                        maxLines: null,
                        maxLineLength: null,
                        maxChars: null,
                        maxFunctions: null,
                        maxClasses: null
                    }
                };

                // Monaco Editor instance
                this.monacoEditor = null;
                this.decorations = [];


                this.init();
            }

            async init() {
                this.applyFontSize();
                await this.createEditor();
                this.bindEvents();
                this.updateAllStats();
                this.setupTooltips();
                this.initStructureSidebar();
                this.initTaskModal();

                // –°—Ç—Ä—É–∫—Ç—É—Ä—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                setTimeout(() => {
                    this.initStructureSidebar();
                }, 100);

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Å–æ–ª–∏
                setTimeout(() => {
                    this.restoreConsoleHeight();
                    this.initConsoleResize();
                }, 200);
            }

            applyFontSize() {
                document.documentElement.style.setProperty('--editor-font-size', `${this.fontSize}px`);
                $(`#fontSize_${this.tabId}`).text(`${this.fontSize}px`);
            }

            increaseFontSize() {
                if (this.fontSize < 24) {
                    this.fontSize++;
                    this.applyFontSize();
                    this.updateEditorFont();
                    localStorage.setItem('monacoeditor_fontsize', this.fontSize);
                }
            }

            decreaseFontSize() {
                if (this.fontSize > 10) {
                    this.fontSize--;
                    this.applyFontSize();
                    this.updateEditorFont();
                    localStorage.setItem('monacoeditor_fontsize', this.fontSize);
                }
            }

            updateEditorFont() {
                if (this.monacoEditor) {
                    this.monacoEditor.updateOptions({
                        fontSize: this.fontSize
                    });
                }
            }

            async createEditor() {
                const container = document.getElementById('editorContainer_' + this.tabId);
                if (!container) return;

                try {
                    if (typeof require === 'undefined') return;

                    require.config({paths: {'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.0/min/vs'}});
                    await new Promise((res, rej) => require(['vs/editor/editor.main'], res, rej));

                    this.monacoEditor = monaco.editor.defineTheme('oneDarkCustom', {
                        base: 'vs-dark',
                        inherit: true,
                        rules: [
                            {token: 'keyword.python', foreground: 'C678DD'},       // from, import, def
                            {token: 'string.python', foreground: '98C379'},        // —Å—Ç—Ä–æ–∫–∏
                            {token: 'function.python', foreground: '61AFEF'},      // –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π
                            {token: 'type.python', foreground: 'E5C07B'},          // –∫–ª–∞—Å—Å—ã
                            {token: 'comment.python', foreground: '5C6370', fontStyle: 'italic'},
                            {token: 'number.python', foreground: 'D19A66'},        // —á–∏—Å–ª–∞
                            {token: 'operator.python', foreground: '56B6C2'},      // + - * /
                            {token: 'identifier.python', foreground: 'ABB2BF'},    // –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                            {token: 'meta.function.decorator.python', foreground: 'D19A66'}, // @decorator
                        ],
                        colors: {
                            'editor.background': '#282C34',
                            'editor.foreground': '#ABB2BF',
                            'editor.lineHighlightBackground': '#2C313C',
                            'editorLineNumber.foreground': '#495162',
                            'editorLineNumber.activeForeground': '#ABB2BF',
                            'editorIndentGuide.background': '#3B4048',
                            'editorIndentGuide.activeBackground': '#528BFF',
                            'editor.selectionBackground': '#3E4451',
                        }
                    });

                    // 2. –°–û–ó–î–ê–ï–ú –†–ï–î–ê–ö–¢–û–†
                    this.monacoEditor = monaco.editor.create(container, {
                        value: this.initialCode || '',
                        language: 'python',
                        theme: 'oneDarkCustom', // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ç–µ–º—É

                        // –®–†–ò–§–¢ (JetBrains Mono –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ –∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω —á–µ—Ä–µ–∑ CSS)
                        fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                        fontSize: 14,
                        lineHeight: 25, // –ù–∞ —Å–∫—Ä–∏–Ω–µ –æ—á–µ–Ω—å —Å–≤–æ–±–æ–¥–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
                        letterSpacing: 0.5,
                        fontLigatures: true,

                        padding: {top: 20, bottom: 20},

                        minimap: {enabled: false},
                        scrollbar: {
                            vertical: 'visible',
                            horizontal: 'visible',
                            verticalScrollbarSize: 10,
                            horizontalScrollbarSize: 10,
                            useShadows: false
                        },

                        lineNumbersMinChars: 4,
                        glyphMargin: false,
                        folding: true,

                        automaticLayout: true,
                        scrollBeyondLastLine: false,
                        renderLineHighlight: 'all',

                        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≤–µ–¥–µ–Ω–∏—è (—Ä–µ–∂–∏–º "—ç–∫–∑–∞–º–µ–Ω")
                        quickSuggestions: false,
                        suggestOnTriggerCharacters: false,
                        autoClosingBrackets: 'always',
                        tabSize: 4,
                        insertSpaces: true,

                        guides: {
                            indentation: true,
                            bracketPairs: true
                        }
                    });

                } catch (err) {
                    console.error('Monaco Init Error:', err);
                }
            }

            updateSelectionUI() {
                const selectedText = this.stats.selectedNonSpaceChars > 0
                    ? `${this.stats.selectedNonSpaceChars}—Å`
                    : "0";

                $('#selectedChars_' + this.tabId).text(selectedText);

                // –î–µ—Ç–∞–ª—å–Ω—ã–π tooltip
                const tooltipText = this.stats.selectedNonSpaceChars > 0
                    ? `${this.stats.selectedNonSpaceChars} —Å–∏–º–≤–æ–ª–æ–≤ (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤/—Ç–∞–±–æ–≤/–ø–µ—Ä–µ–Ω–æ—Å–æ–≤)\n` +
                    `${this.stats.selectedWords} —Å–ª–æ–≤\n` +
                    `${this.stats.selectedLines} —Å—Ç—Ä–æ–∫`
                    : '–í—ã–¥–µ–ª–µ–Ω–æ —Å–∏–º–≤–æ–ª–æ–≤ (–±–µ–∑ whitespace)';

                $(`#selectedChars_${this.tabId}`).parent().attr('title', tooltipText);
            }

            initStructureSidebar() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                this.updateStructureSidebar();

                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ–∫—Ü–∏–π –∏–∑ localStorage
                this.restoreSectionStates();
            }

            restoreSectionStates() {
                const sections = ['functions', 'classes', 'imports'];

                sections.forEach(sectionType => {
                    const storageKey = `monacoeditor_section_${this.tabId}_${sectionType}`;
                    const savedState = localStorage.getItem(storageKey);
                    const section = document.getElementById(`${sectionType}Section_${this.tabId}`);

                    if (section && savedState === 'closed') {
                        const items = section.querySelector('.section-items');
                        const toggle = section.querySelector('.section-toggle');

                        if (items && toggle) {
                            items.style.display = 'none';
                            toggle.classList.remove('fa-chevron-up');
                            toggle.classList.add('fa-chevron-down');
                        }
                    }
                });
            }

            updateStructureSidebar() {
                this.analyzeCodeStructure();
                this.renderFunctionsList();
                this.renderClassesList();
                this.renderImportsList();
                this.updateStructureCounts();
            }

            analyzeCodeStructure() {
                if (!this.monacoEditor) return;

                const code = this.monacoEditor.getValue();
                const lines = code.split('\n');

                this.functions = [];
                this.classes = [];
                this.imports = [];

                lines.forEach((line, index) => {
                    const lineNum = index + 1;
                    const trimmed = line.trim();

                    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
                    const funcMatch = trimmed.match(/^def\s+(\w+)\s*\(/);
                    if (funcMatch) {
                        const funcName = funcMatch[1];
                        const indent = line.match(/^(\s*)/)[1].length;

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ –∏–º–µ–Ω–∏
                        let type = 'function';
                        let icon = 'fa-code';

                        if (funcName.startsWith('__') && funcName.endsWith('__')) {
                            type = 'magic';
                            icon = 'fa-magic';
                        } else if (funcName.startsWith('_')) {
                            type = 'private';
                            icon = 'fa-lock';
                        } else if (funcName === funcName.toUpperCase()) {
                            type = 'constant';
                            icon = 'fa-hashtag';
                        }

                        this.functions.push({
                            name: funcName,
                            line: lineNum,
                            indent: indent,
                            type: type,
                            icon: icon
                        });
                    }

                    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤
                    const classMatch = trimmed.match(/^class\s+(\w+)/);
                    if (classMatch) {
                        const className = classMatch[1];
                        const indent = line.match(/^(\s*)/)[1].length;

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–ª–∞—Å—Å–∞
                        let type = 'class';
                        let icon = 'fa-cube';

                        if (className.includes('Abstract') || className.includes('Base')) {
                            type = 'abstract';
                            icon = 'fa-shapes';
                        } else if (className.includes('Mixin')) {
                            type = 'mixin';
                            icon = 'fa-puzzle-piece';
                        } else if (className.includes('Exception') || className.includes('Error')) {
                            type = 'exception';
                            icon = 'fa-exclamation-circle';
                        }

                        this.classes.push({
                            name: className,
                            line: lineNum,
                            indent: indent,
                            type: type,
                            icon: icon
                        });
                    }

                    // –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–æ–≤
                    const importMatch = trimmed.match(/^(import|from)\s+(\w+)/);
                    if (importMatch) {
                        const importType = importMatch[1];
                        const module = importMatch[2];

                        this.imports.push({
                            module: module,
                            line: lineNum,
                            type: importType
                        });
                    }
                });
            }

            renderFunctionsList() {
                const container = document.getElementById('functionsList_' + this.tabId);
                if (!container) return;

                container.innerHTML = '';

                if (this.functions.length === 0) {
                    container.innerHTML = '<div class="empty-message">–ù–µ—Ç —Ñ—É–Ω–∫—Ü–∏–π</div>';
                    return;
                }

                this.functions.forEach(func => {
                    const funcElement = document.createElement('div');
                    funcElement.className = `structure-item func-${func.type}`;
                    funcElement.innerHTML = `
                    <i class="fas ${func.icon}"></i>
                    <span class="item-name">${func.name}</span>
                    <span class="item-line">:${func.line}</span>
                `;

                    funcElement.onclick = (e) => {
                        e.stopPropagation();
                        this.goToLine(func.line);
                    };

                    container.appendChild(funcElement);
                });
            }

            renderClassesList() {
                const container = document.getElementById('classesList_' + this.tabId);
                if (!container) return;

                container.innerHTML = '';

                if (this.classes.length === 0) {
                    container.innerHTML = '<div class="empty-message">–ù–µ—Ç –∫–ª–∞—Å—Å–æ–≤</div>';
                    return;
                }

                this.classes.forEach(cls => {
                    const classElement = document.createElement('div');
                    classElement.className = `structure-item class-${cls.type}`;
                    classElement.innerHTML = `
                    <i class="fas ${cls.icon}"></i>
                    <span class="item-name">${cls.name}</span>
                    <span class="item-line">:${cls.line}</span>
                `;

                    classElement.onclick = (e) => {
                        e.stopPropagation();
                        this.goToLine(cls.line);
                    };

                    container.appendChild(classElement);
                });
            }

            renderImportsList() {
                const container = document.getElementById('importsList_' + this.tabId);
                if (!container) return;

                container.innerHTML = '';

                if (this.imports.length === 0) {
                    container.innerHTML = '<div class="empty-message">–ù–µ—Ç –∏–º–ø–æ—Ä—Ç–æ–≤</div>';
                    return;
                }

                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç—ã –ø–æ –º–æ–¥—É–ª—è–º
                const groupedImports = {};
                this.imports.forEach(imp => {
                    if (!groupedImports[imp.module]) {
                        groupedImports[imp.module] = [];
                    }
                    groupedImports[imp.module].push(imp);
                });

                Object.entries(groupedImports).forEach(([module, imports]) => {
                    const importElement = document.createElement('div');
                    importElement.className = 'structure-item import';
                    importElement.innerHTML = `
                    <i class="fas fa-file-import"></i>
                    <span class="item-name">${module}</span>
                `;

                    // –ü—Ä–∏ –∫–ª–∏–∫–µ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø–µ—Ä–≤–æ–º—É –∏–º–ø–æ—Ä—Ç—É —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
                    importElement.onclick = (e) => {
                        e.stopPropagation();
                        this.goToLine(imports[0].line);
                    };

                    container.appendChild(importElement);
                });
            }

            updateStructureCounts() {
                $(`#functionCountDisplay_${this.tabId}`).text(this.functions.length);
                $(`#classCountDisplay_${this.tabId}`).text(this.classes.length);
            }

            initTaskModal() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
                this.updateForbiddenWordsList();
                this.updateTagsList();
                this.updateExamplesList();
            }

            bindEvents() {
                // –ó–∞–ø—É—Å–∫ –∫–æ–¥–∞
                $('#tabRunBtn_' + this.tabId).off('click').on('click', () => {
                    this.runCode();
                });

                // –û—á–∏—Å—Ç–∫–∞ –∫–æ–Ω—Å–æ–ª–∏
                $('#clearConsoleBtn_' + this.tabId).off('click').on('click', () => {
                    this.clearConsole();
                });

                // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Å–æ–ª—å
                $(`#expandConsoleBtn_${this.tabId}`).off('click').on('click', () => {
                    this.expandConsole();
                });

                // –°–≤–µ—Ä–Ω—É—Ç—å –∫–æ–Ω—Å–æ–ª—å
                $(`#collapseConsoleBtn_${this.tabId}`).off('click').on('click', () => {
                    this.collapseConsole();
                });


                // –ö–ª–∏–∫ –ø–æ –∏–∫–æ–Ω–∫–µ –æ—à–∏–±–æ–∫ PEP8
                $(document).on('click', `#pep8Errors_${this.tabId}`, (e) => {
                    e.stopPropagation();
                    this.showErrorsModal();
                });

                if (this.monacoEditor) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
                    this.monacoEditor.onDidChangeModelContent(() => {
                        this.updateAllStats();
                        this.updateStructureSidebar();
                        this.autoSave();
                    });

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è
                    this.monacoEditor.onDidChangeCursorSelection(() => {
                        this.updateSelectionStats();
                    });

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–≤–æ–¥–∞
                    this.monacoEditor.onKeyDown((e) => {
                        this.validateKeyInput(e);
                    });
                }
            }

            validateKeyInput(e) {
                // –ó–∞–ø—Ä–µ—Ç –Ω–∞ —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π
                if (e.key === ';') {
                    this.addConsoleMessage('Python –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π (;) –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫', 'warning');
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            }

            setupTooltips() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
                $(`#statusBar_${this.tabId} .stat-item[data-tooltip]`).each(function () {
                    const tooltip = $(this).data('tooltip');
                    $(this).attr('title', tooltip);
                });
            }

            updateAllStats() {
                if (!this.monacoEditor) return;

                const code = this.monacoEditor.getValue();

                this.updateCharStats(code);
                this.updateCodeStructureStats(code);
                this.updateSelectionStats();
                this.checkPEP8Rules(code);
                this.loadConsoleHeight();

                this.updateStatsUI();
            }

            updateCharStats(code) {
                this.stats.totalChars = code.length;
                this.stats.nonSpaceChars = code.replace(/\s/g, '').length;
            }

            updateCodeStructureStats(code) {
                this.stats.functionCount = this.functions.length;
                this.stats.classCount = this.classes.length;
            }

            updateSelectionStats() {
                if (!this.monacoEditor) return;

                const selection = this.monacoEditor.getSelection();
                let selectedAllChars = 0;
                let selectedNonWhitespaceChars = 0;
                let selectedWords = 0;
                let selectedLines = 0;

                if (!selection.isEmpty()) {
                    const model = this.monacoEditor.getModel();
                    const text = model.getValueInRange(selection);

                    // –í—Å–µ —Å–∏–º–≤–æ–ª—ã
                    selectedAllChars = text.length;

                    // –ù–µ-whitespace —Å–∏–º–≤–æ–ª—ã
                    selectedNonWhitespaceChars = text.replace(/\s/g, '').length;

                    // –ü–æ–¥—Å—á–µ—Ç —Å–ª–æ–≤
                    const wordArray = text.match(/\S+/g) || [];
                    selectedWords = wordArray.length;

                    // –ü–æ–¥—Å—á–µ—Ç —Å—Ç—Ä–æ–∫
                    const startLine = selection.startLineNumber;
                    const endLine = selection.endLineNumber;
                    selectedLines = endLine - startLine + 1;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                this.stats.selectedChars = selectedAllChars;
                this.stats.selectedNonSpaceChars = selectedNonWhitespaceChars;
                this.stats.selectedWords = selectedWords;
                this.stats.selectedLines = selectedLines;

                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                this.updateSelectionUI();
            }

            checkPEP8Rules(code) {
                const lines = code.split('\n');
                this.errors = [];

                this.clearLineMarkers();

                lines.forEach((line, index) => {
                    const lineNum = index + 1;

                    if (line.length > this.pep8Limit) {
                        this.addError(lineNum, `–°—Ç—Ä–æ–∫–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è (${line.length}/${this.pep8Limit} —Å–∏–º–≤–æ–ª–æ–≤)`, 'pep8');
                    }

                    if (line.includes(';')) {
                        this.addError(lineNum, '–¢–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Python', 'syntax');
                    }

                    if (line.startsWith('\t')) {
                        this.addError(lineNum, '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ 4 –ø—Ä–æ–±–µ–ª–∞ –≤–º–µ—Å—Ç–æ —Ç–∞–±–æ–≤ –¥–ª—è –æ—Ç—Å—Ç—É–ø–æ–≤', 'pep8');
                    }

                    if (line.endsWith(' ') || line.endsWith('\t')) {
                        this.addError(lineNum, '–£–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏', 'pep8');
                    }
                });

                this.stats.errors = this.errors.length;
            }

            addError(lineNum, message, type) {
                this.errors.push({line: lineNum, message, type});

                if (this.monacoEditor) {
                    const model = this.monacoEditor.getModel();
                    if (!model) return;

                    const lineDecoration = {
                        range: new monaco.Range(lineNum, 1, lineNum, 1),
                        options: {
                            isWholeLine: true,
                            className: type === 'syntax' ? 'error-line-decoration' : 'warning-line-decoration',
                            glyphMarginClassName: type === 'syntax' ? 'error-glyph-margin' : 'warning-glyph-margin'
                        }
                    };

                    this.decorations = this.monacoEditor.deltaDecorations(
                        this.decorations,
                        [lineDecoration]
                    );
                }
            }

            clearLineMarkers() {
                if (!this.monacoEditor) return;
                this.decorations = this.monacoEditor.deltaDecorations(this.decorations, []);
            }

            updateStatsUI() {
                $('#nonSpaceChars_' + this.tabId).text(this.stats.nonSpaceChars);
                $('#functionCount_' + this.tabId).text(this.stats.functionCount);
                $('#classCount_' + this.tabId).text(this.stats.classCount);
                $('#selectedChars_' + this.tabId).text(this.stats.selectedNonSpaceChars);
                $('#errorCount_' + this.tabId).text(this.stats.errors);

                const errorStat = $('#pep8Errors_' + this.tabId);
                if (this.stats.errors > 0) {
                    errorStat.addClass('has-errors');
                } else {
                    errorStat.removeClass('has-errors');
                }
            }

            showErrorsModal() {
                if (this.errors.length === 0) return;

                const modal = document.getElementById('pep8ErrorsModal_' + this.tabId);
                const errorsList = document.getElementById('errorsList_' + this.tabId);

                errorsList.innerHTML = '';

                const pep8Errors = this.errors.filter(e => e.type === 'pep8');
                const syntaxErrors = this.errors.filter(e => e.type === 'syntax');

                if (pep8Errors.length > 0) {
                    errorsList.innerHTML += '<div class="error-group-title">–û—à–∏–±–∫–∏ PEP8:</div>';
                    pep8Errors.forEach(error => {
                        errorsList.innerHTML += `
                        <div class="error-item" onclick="window.codeMonkeyInstances['${this.tabId}'].goToLine(${error.line})">
                            <span class="error-line">–°—Ç—Ä–æ–∫–∞ ${error.line}:</span>
                            <span class="error-message">${error.message}</span>
                        </div>
                    `;
                    });
                }

                if (syntaxErrors.length > 0) {
                    errorsList.innerHTML += '<div class="error-group-title">–°–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:</div>';
                    syntaxErrors.forEach(error => {
                        errorsList.innerHTML += `
                        <div class="error-item" onclick="window.codeMonkeyInstances['${this.tabId}'].goToLine(${error.line})">
                            <span class="error-line">–°—Ç—Ä–æ–∫–∞ ${error.line}:</span>
                            <span class="error-message">${error.message}</span>
                        </div>
                    `;
                    });
                }

                modal.style.display = 'block';
            }

            hideErrorsModal() {
                document.getElementById('pep8ErrorsModal_' + this.tabId).style.display = 'none';
            }

            hideTaskModal() {
                document.getElementById('taskCreationModal_' + this.tabId).style.display = 'none';
            }

            updateTaskCodePreview() {
                const codePreview = document.getElementById('taskCodePreview_' + this.tabId);
                if (!codePreview || !this.monacoEditor) return;

                const code = this.monacoEditor.getValue();
                const lines = code.split('\n');

                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                let html = '<pre><code>';
                lines.forEach((line, index) => {
                    html += `<span class="line-number">${index + 1}</span> ${this.escapeHtml(line)}\n`;
                });
                html += '</code></pre>';

                codePreview.innerHTML = html;

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                $('#taskLinesCount_' + this.tabId).text(lines.length);
                $('#taskCharsCount_' + this.tabId).text(code.length);
                $('#taskNonSpaceCount_' + this.tabId).text(code.replace(/\s/g, '').length);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            resetTaskForm() {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∫ –Ω–∞—á–∞–ª—å–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º
                $('#taskDescription_' + this.tabId).val('');

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                $('#limitLines_' + this.tabId).prop('checked', false);
                $('#limitLineLength_' + this.tabId).prop('checked', false);
                $('#limitChars_' + this.tabId).prop('checked', false);
                $('#limitFunctions_' + this.tabId).prop('checked', false);
                $('#limitClasses_' + this.tabId).prop('checked', false);

                $('#maxLines_' + this.tabId).prop('disabled', true);
                $('#maxLineLength_' + this.tabId).prop('disabled', true);
                $('#maxChars_' + this.tabId).prop('disabled', true);
                $('#maxFunctions_' + this.tabId).prop('disabled', true);
                $('#maxClasses_' + this.tabId).prop('disabled', true);

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
                this.taskData.forbiddenWords = [];
                this.updateForbiddenWordsList();

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã
                this.taskData.examples = [{
                    input: '',
                    output: ''
                }];
                this.updateExamplesList();

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–≥–∏
                this.taskData.tags = ['python', '–∑–∞–¥–∞—á–∞'];
                this.updateTagsList();

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª—ë–≥–∫–∏–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                $('input[name="difficulty_' + this.tabId + '"][value="easy"]').prop('checked', true);
            }

            updateForbiddenWordsList() {
                const list = document.getElementById('forbiddenWordsList_' + this.tabId);
                if (!list) return;

                list.innerHTML = '';

                if (this.taskData.forbiddenWords.length === 0) {
                    list.innerHTML = '<div class="empty-words">–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div>';
                    return;
                }

                this.taskData.forbiddenWords.forEach((word, index) => {
                    const wordElement = document.createElement('div');
                    wordElement.className = 'forbidden-word';
                    wordElement.innerHTML = `
                        <span>${word}</span>
                        <button type="button" class="remove-word-btn" onclick="removeForbiddenWord('${this.tabId}', ${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    list.appendChild(wordElement);
                });
            }

            updateTagsList() {
                const list = document.getElementById('tagsList_' + this.tabId);
                if (!list) return;

                list.innerHTML = '';

                this.taskData.tags.forEach((tag, index) => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        ${tag}
                        <span class="remove-tag" onclick="removeTag('${this.tabId}', ${index})">√ó</span>
                    `;
                    list.appendChild(tagElement);
                });
            }

            clearConsoleContent() {
                // –¢–æ–ª—å–∫–æ –æ—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, –Ω–µ –º–µ–Ω—è–µ–º –≤—ã—Å–æ—Ç—É
                $('#consoleOutput_' + this.tabId).empty();
                this.addConsoleMessage("–ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞", "info");
            }

            updateExamplesList() {
                const container = $('.io-examples');
                if (!container.length) return;

                // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø—Ä–∏–º–µ—Ä—ã –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ
                $('.io-example:gt(0)').remove();

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–∏–º–µ—Ä
                $('#inputExample1_' + this.tabId).val(this.taskData.examples[0].input || '');
                $('#outputExample1_' + this.tabId).val(this.taskData.examples[0].output || '');

                // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã
                for (let i = 1; i < this.taskData.examples.length; i++) {
                    this.addExampleToDOM(i + 1, this.taskData.examples[i]);
                }
            }

            addExampleToDOM(exampleNum, exampleData) {
                const examplesContainer = $('.io-examples');
                const exampleHtml = `
                    <div class="io-example" id="example_${exampleNum}_${this.tabId}">
                        <div class="io-header">
                            <span>–ü—Ä–∏–º–µ—Ä ${exampleNum}</span>
                            <button type="button" class="remove-example-btn" onclick="removeExample('${this.tabId}', ${exampleNum - 1})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="io-row">
                            <div class="io-cell">
                                <label>–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</label>
                                <textarea class="io-input" id="inputExample${exampleNum}_${this.tabId}" placeholder='{"arg1": "value", "arg2": 123}'>${exampleData.input || ''}</textarea>
                            </div>
                            <div class="io-cell">
                                <label>–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</label>
                                <textarea class="io-output" id="outputExample${exampleNum}_${this.tabId}" placeholder='{"result": "expected"}' >${exampleData.output || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;

                examplesContainer.append(exampleHtml);
            }

            goToLine(line) {
                if (!this.monacoEditor) return;

                this.monacoEditor.revealLineInCenter(line);
                this.monacoEditor.setPosition({
                    lineNumber: line,
                    column: 1
                });
                this.monacoEditor.focus();
                this.hideErrorsModal();
            }

            loadConsoleHeight() {
                const savedHeight = localStorage.getItem(`console_height_${this.tabId}`);
                const consoleContainer = document.getElementById(`consoleContainer_${this.tabId}`);

                if (savedHeight && consoleContainer) {
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –≤—ã—Å–æ—Ç—É
                    consoleContainer.style.height = `${savedHeight}px`;

                    // –í–∞–∂–Ω–æ: –µ—Å–ª–∏ Monaco —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –µ–≥–æ —Ä–∞–∑–º–µ—Ä
                    if (this.monacoEditor) {
                        this.monacoEditor.layout();
                    }
                }
            }

            runCode() {
                if (!this.monacoEditor) return;

                const code = this.monacoEditor.getValue();
                const runBtn = $('#tabRunBtn_' + this.tabId);

                runBtn.prop('disabled', true);
                runBtn.html('<div class="loading"></div> –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞...');

                this.clearConsoleContent();

                // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –∑–∞–ø—É—Å–∫
                $.ajax({
                    url: `${location.origin}/code_cup/editor/run-code/`,
                    type: 'POST',
                    data: {code: code, language: 'python'},
                    success: (response) => {
                        if (response.success && response.task_id) {
                            this.addConsoleMessage(`‚öôÔ∏è –ó–∞–¥–∞—á–∞ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å...`, 'info');
                            // –ù–∞—á–∏–Ω–∞–µ–º –æ–ø—Ä–∞—à–∏–≤–∞—Ç—å —Å—Ç–∞—Ç—É—Å
                            this.pollTaskStatus(response.task_id);
                        } else {
                            this.addConsoleMessage(`‚ùå –û—à–∏–±–∫–∞: ${response.error}`, 'error');
                            this.resetRunButton();
                        }
                    },
                    error: (xhr) => {
                        this.addConsoleMessage(`‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞`, 'error');
                        this.resetRunButton();
                    }
                });
            }

            pollTaskStatus(taskId) {
                const runBtn = $('#tabRunBtn_' + this.tabId);

                const checkInterval = setInterval(() => {
                    $.ajax({
                        url: `${location.origin}/code_cup/editor/get-status/${taskId}/`,
                        type: 'GET',
                        success: (data) => {
                            if (data.status === 'SUCCESS') {
                                clearInterval(checkInterval);
                                const res = data.result;

                                if (res.success) {
                                    this.addConsoleMessage(`‚úì –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞ ${res.execution_time_ms}–º—Å`, 'success');
                                    if (res.output) this.addConsoleMessage(res.output, 'output');

                                    // –ï—Å–ª–∏ –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ tasks.py:
                                    if (res.stats) {
                                        this.addConsoleMessage(`üìä –°—Ç—Ä–æ–∫: ${res.stats.lines}, –§—É–Ω–∫—Ü–∏–π: ${res.stats.functions}`, 'info');
                                    }
                                } else {
                                    this.addConsoleMessage(`‚ùå –û—à–∏–±–∫–∞: ${res.error}`, 'error');
                                }
                                this.resetRunButton();
                            } else if (data.status === 'FAILURE') {
                                clearInterval(checkInterval);
                                this.addConsoleMessage(`‚ùå –°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞ Celery`, 'error');
                                this.resetRunButton();
                            }
                            // –ï—Å–ª–∏ PENDING ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –∂–¥–µ–º —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
                        },
                        error: () => {
                            clearInterval(checkInterval);
                            this.resetRunButton();
                        }
                    });
                }, 500); // –û–ø—Ä–æ—Å –∫–∞–∂–¥—ã–µ –ø–æ–ª—Å–µ–∫—É–Ω–¥—ã
            }

            resetRunButton() {
                const runBtn = $('#tabRunBtn_' + this.tabId);
                runBtn.prop('disabled', false);
                runBtn.html('<i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å');
            }

            addConsoleMessage(message, type = 'info') {
                const consoleOutput = $('#consoleOutput_' + this.tabId);
                if (!consoleOutput.length) return;

                const timestamp = new Date().toLocaleTimeString().slice(0, 5);
                const messageClass = type === 'error' ? 'error' :
                    type === 'success' ? 'success' :
                        type === 'warning' ? 'warning' :
                            type === 'output' ? 'output' : 'info';

                const messageLine = `<div class="console-line ${messageClass}">` +
                    `${message}` +
                    `</div>`;

                consoleOutput.append(messageLine);
                consoleOutput.scrollTop(consoleOutput[0].scrollHeight);
            }

            clearConsole() {
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Å–æ–ª—å (–ø–æ –∫–Ω–æ–ø–∫–µ)
                $('#consoleOutput_' + this.tabId).empty();
                this.addConsoleMessage("–ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞", "info");
                // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã—Å–æ—Ç—É!
            }

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            restoreConsoleHeight() {
                const consoleContainer = $(`#consoleContainer_${this.tabId}`);
                if (consoleContainer.length) {
                    const savedHeight = localStorage.getItem(`console_height_${this.tabId}`);
                    if (savedHeight) {
                        consoleContainer.css('height', `${savedHeight}px`);

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                        if (parseInt(savedHeight) > 250) {
                            $(`#expandConsoleBtn_${this.tabId}`).hide();
                            $(`#collapseConsoleBtn_${this.tabId}`).show();
                        } else {
                            $(`#expandConsoleBtn_${this.tabId}`).show();
                            $(`#collapseConsoleBtn_${this.tabId}`).hide();
                        }
                    }
                }
            }

            initConsoleResize() {
                const handle = document.getElementById(`consoleResize_${this.tabId}`);
                const consoleElem = document.getElementById(`consoleContainer_${this.tabId}`);

                if (!handle || !consoleElem) return;

                handle.addEventListener('pointerdown', (e) => {
                    e.preventDefault();

                    // –ë—ã—Å—Ç—Ä—ã–π –∑–∞—Ö–≤–∞—Ç —Ñ–æ–∫—É—Å–∞ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–≤—ã–ø–∞–¥–µ–Ω–∏–µ" –º—ã—à–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –¥–≤–∏–∂–µ–Ω–∏–∏)
                    handle.setPointerCapture(e.pointerId);

                    const startY = e.clientY;
                    const startHeight = consoleElem.offsetHeight;

                    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ DOM –∫ –±—ã—Å—Ç—Ä–æ–º—É —Ä–µ—Å–∞–π–∑—É
                    document.body.style.cursor = 'row-resize';
                    document.body.style.userSelect = 'none';
                    consoleElem.style.transition = 'none';
                    consoleElem.classList.add('resizing');

                    // –ï—Å–ª–∏ —É –≤–∞—Å Monaco –∏–ª–∏ Iframe, –æ–Ω–∏ "–∫—Ä–∞–¥—É—Ç" —Å–æ–±—ã—Ç–∏—è –º—ã—à–∏.
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–ª–æ–π –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ –Ω–∞ –≤—Ä–µ–º—è —Ä–µ—Å–∞–π–∑–∞.
                    const overlay = document.createElement('div');
                    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;z-index:9999;cursor:row-resize;';
                    document.body.appendChild(overlay);

                    let rafId = null;

                    const onPointerMove = (moveEvent) => {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ 60+ FPS
                        if (rafId) cancelAnimationFrame(rafId);

                        rafId = requestAnimationFrame(() => {
                            const deltaY = startY - moveEvent.clientY;
                            let newHeight = startHeight + deltaY;

                            // –ñ–µ—Å—Ç–∫–∏–µ –∏ –±—ã—Å—Ç—Ä—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                            // 40px - –≤—ã—Å–æ—Ç–∞ —à–∞–ø–∫–∏ –∫–æ–Ω—Å–æ–ª–∏, window.innerHeight * 0.8 - –º–∞–∫—Å. –ø—Ä–µ–¥–µ–ª
                            const minH = 40;
                            const maxH = window.innerHeight * 0.8;

                            if (newHeight < minH) newHeight = minH;
                            if (newHeight > maxH) newHeight = maxH;

                            consoleElem.style.height = `${newHeight}px`;

                            // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –≤–µ—Ä—Å—Ç–∫—É —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
                            if (this.monacoEditor) {
                                this.monacoEditor.layout();
                            }
                        });
                    };

                    const onPointerUp = () => {
                        if (rafId) cancelAnimationFrame(rafId);

                        // –ß–∏—Å—Ç–∏–º –∑–∞ —Å–æ–±–æ–π
                        document.body.removeChild(overlay);
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        consoleElem.style.transition = '';
                        consoleElem.classList.remove('resizing');

                        handle.releasePointerCapture(e.pointerId);
                        document.removeEventListener('pointermove', onPointerMove);
                        document.removeEventListener('pointerup', onPointerUp);

                        this.saveConsoleHeight();
                    };

                    document.addEventListener('pointermove', onPointerMove);
                    document.addEventListener('pointerup', onPointerUp);
                });
            }

            saveConsoleHeight() {
                const consoleContainer = document.getElementById(`consoleContainer_${this.tabId}`);
                if (consoleContainer) {
                    const currentHeight = consoleContainer.offsetHeight;

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ –±–æ–ª—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 40px)
                    if (currentHeight > 40) {
                        localStorage.setItem(`console_height_${this.tabId}`, currentHeight);
                    }
                }
            }

            autoSave() {
                if (!this.monacoEditor) return;
                const content = this.monacoEditor.getValue();

                try {
                    const tabs = JSON.parse(localStorage.getItem('codeMonkeyTabs') || '{}');
                    tabs[this.tabId] = {
                        id: this.tabId,
                        name: this.name,
                        content: content,
                        lastModified: new Date().toISOString(),
                        stats: this.stats,
                        functions: this.functions,
                        classes: this.classes
                    };
                    localStorage.setItem('codeMonkeyTabs', JSON.stringify(tabs));
                } catch (e) {
                    console.error('Error saving tab:', e);
                }
            }

            expandConsole() {
                const consoleContainer = $(`#consoleContainer_${this.tabId}`);
                const expandBtn = $(`#expandConsoleBtn_${this.tabId}`);
                const collapseBtn = $(`#collapseConsoleBtn_${this.tabId}`);

                if (consoleContainer.length) {
                    consoleContainer.css('height', '500px');
                    expandBtn.hide();
                    collapseBtn.show();
                    this.saveConsoleHeight();
                }
            }

            collapseConsole() {
                const consoleContainer = $(`#consoleContainer_${this.tabId}`);
                const expandBtn = $(`#expandConsoleBtn_${this.tabId}`);
                const collapseBtn = $(`#collapseConsoleBtn_${this.tabId}`);

                if (consoleContainer.length) {
                    consoleContainer.css('height', '200px');
                    expandBtn.show();
                    collapseBtn.hide();
                    this.saveConsoleHeight();
                }
            }

            formatCode() {
                if (!this.monacoEditor) return;

                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Monaco Editor
                    this.monacoEditor.getAction('editor.action.formatDocument').run();

                    this.updateAllStats();
                    this.updateStructureSidebar();
                    this.hideErrorsModal();
                    this.addConsoleMessage("–ö–æ–¥ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω", "success");
                } catch (error) {
                    console.error('Error formatting code:', error);
                    this.addConsoleMessage("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–¥–∞", "error");
                }
            }

            createTask() {
                // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
                const taskTitle = $('#taskTitle_' + this.tabId).val();
                const taskDescription = $('#taskDescription_' + this.tabId).val();
                const code = this.monacoEditor.getValue();

                // –°–æ–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
                const constraints = {
                    maxLines: $('#limitLines_' + this.tabId).is(':checked') ? parseInt($('#maxLines_' + this.tabId).val()) : null,
                    maxLineLength: $('#limitLineLength_' + this.tabId).is(':checked') ? parseInt($('#maxLineLength_' + this.tabId).val()) : null,
                    maxChars: $('#limitChars_' + this.tabId).is(':checked') ? parseInt($('#maxChars_' + this.tabId).val()) : null,
                    maxFunctions: $('#limitFunctions_' + this.tabId).is(':checked') ? parseInt($('#maxFunctions_' + this.tabId).val()) : null,
                    maxClasses: $('#limitClasses_' + this.tabId).is(':checked') ? parseInt($('#maxClasses_' + this.tabId).val()) : null
                };

                // –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã
                const examples = [];
                $('.io-example').each((index, element) => {
                    const exampleNum = index + 1;
                    const input = $('#inputExample' + exampleNum + '_' + this.tabId).val();
                    const output = $('#outputExample' + exampleNum + '_' + this.tabId).val();

                    if (input || output) {
                        examples.push({
                            input: input,
                            output: output
                        });
                    }
                });

                // –£—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
                const difficulty = $('input[name="difficulty_' + this.tabId + '"]:checked').val();

                // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –∑–∞–¥–∞—á–∏
                const task = {
                    id: 'task_' + Date.now(),
                    title: taskTitle,
                    description: taskDescription,
                    code: code,
                    constraints: constraints,
                    forbiddenWords: this.taskData.forbiddenWords,
                    examples: examples,
                    tags: this.taskData.tags,
                    difficulty: difficulty,
                    created: new Date().toISOString(),
                    stats: {
                        lines: code.split('\n').length,
                        chars: code.length,
                        nonSpaceChars: code.replace(/\s/g, '').length,
                        functions: this.functions.length,
                        classes: this.classes.length
                    }
                };

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É –≤ localStorage
                this.saveTask(task);

                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                this.hideTaskModal();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.addConsoleMessage(`–ó–∞–¥–∞—á–∞ "${taskTitle}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞!`, 'success');

                return task;
            }

            saveTask(task) {
                console.log("saveTask", task)
                try {
                    const tasks = JSON.parse(localStorage.getItem('codeMonkeyTasks') || '[]');
                    tasks.push(task);
                    localStorage.setItem('codeMonkeyTasks', JSON.stringify(tasks));
                    return true;
                } catch (e) {
                    console.error('Error saving task:', e);
                    this.addConsoleMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏', 'error');
                    return false;
                }
            }
        };
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å UI
    function increaseFontSize(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].increaseFontSize();
        }
    }

    function decreaseFontSize(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].decreaseFontSize();
        }
    }

    function hidePEP8Modal(tabId) {
        const modal = document.getElementById('pep8ErrorsModal_' + tabId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const items = section.querySelector('.section-items');
        const toggle = section.querySelector('.section-toggle');

        const parts = sectionId.split('_');
        const tabId = parts[parts.length - 1];
        const sectionType = parts[0].replace('Section', '');

        const storageKey = `monacoeditor_section_${tabId}_${sectionType}`;

        if (items.style.display === 'none') {
            items.style.display = 'block';
            toggle.classList.remove('fa-chevron-down');
            toggle.classList.add('fa-chevron-up');
            localStorage.setItem(storageKey, 'open');
        } else {
            items.style.display = 'none';
            toggle.classList.remove('fa-chevron-up');
            toggle.classList.add('fa-chevron-down');
            localStorage.setItem(storageKey, 'closed');
        }
    }

    function removeForbiddenWord(tabId, index) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].taskData.forbiddenWords.splice(index, 1);
            window.codeMonkeyInstances[tabId].updateForbiddenWordsList();
        }
    }


    function removeTag(tabId, index) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].taskData.tags.splice(index, 1);
            window.codeMonkeyInstances[tabId].updateTagsList();
        }
    }

    function removeExample(tabId, index) {
        if (!window.codeMonkeyInstances || !window.codeMonkeyInstances[tabId]) return;

        if (window.codeMonkeyInstances[tabId].taskData.examples.length > 1) {
            window.codeMonkeyInstances[tabId].taskData.examples.splice(index, 1);
            window.codeMonkeyInstances[tabId].updateExamplesList();
        }
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–≤
    window.codeMonkeyInstances = window.codeMonkeyInstances || {};

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    $(document).ready(function () {
        const tabId = "{{ tab_id }}";
        const name = "{{ name }}";
        const code = `{{ code }}`;

        // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
        window.codeMonkeyInstances[tabId] = new window.MonacoEditor(tabId, name, code);
    });
</script>
<style>
    /* –ü–æ–¥–∫–ª—é—á–∞–µ–º JetBrains Mono */
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap');

    :root {
        --editor-font-size: 14px;
        --pycharm-bg: #1e1e1e;
        --pycharm-fg: #d4d4d4;
        --pycharm-accent: #569cd6;
        --pycharm-string: #ce9178;
        --pycharm-number: #b5cea8;
        --pycharm-keyword: #c586c0;
        --pycharm-comment: #6a9955;
        --pycharm-selection: #264f78;
        --pycharm-gutter: #1e1e1e;
        --pycharm-gutter-fg: #858585;
        --pycharm-error: #f44747;
        --pycharm-warning: #ffcc00;
        --pycharm-success: #4CAF50;
        --pycharm-info: #4d9feb;
        --pycharm-border: #3c3f41;
        --sidebar-bg: #252526;
        --sidebar-border: #3c3f41;
        --sidebar-header: #2d2d30;
    }

    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    .single-editor {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
        min-height: 500px;
        max-height: 1000px;
        border: 1px solid var(--pycharm-border);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
        background: var(--pycharm-bg);
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ */
    .single-header {
        background: var(--pycharm-bg);
        border-bottom: 1px solid var(--pycharm-border);
        padding: 8px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        min-height: 50px;
    }

    .single-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .single-title {
        color: var(--pycharm-fg);
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-weight: 500;
    }

    /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–æ–º */
    .font-size-controls {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-left: 15px;
        background: rgba(255, 255, 255, 0.05);
        padding: 3px 8px;
        border-radius: 4px;
        border: 1px solid var(--pycharm-border);
    }

    .font-btn {
        background: transparent;
        border: none;
        padding: 2px 8px;
        font-size: 12px;
        color: var(--pycharm-gutter-fg);
        cursor: pointer;
    }

    .font-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--pycharm-fg);
    }

    .font-size-display {
        color: var(--pycharm-fg);
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        min-width: 40px;
        text-align: center;
    }

    /* –ö–Ω–æ–ø–∫–∏ –≤ —Å—Ç–∏–ª–µ VS Code */
    .tab-run-btn, .console-btn {
        background: #0e639c;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tab-run-btn:hover, .console-btn:hover {
        background: #1177bb;
        border-color: #0e639c;
    }

    .tab-run-btn:active, .console-btn:active {
        background: #0e639c;
        transform: translateY(1px);
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –∏ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    .editor-content-wrapper {
        display: flex;
        flex: 1;
        overflow: hidden;
        min-height: 300px;
    }

    /* –û–±–ª–∞—Å—Ç—å —Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –∫–æ–¥–∞ */
    .code-mirror-wrapper {
        flex: 1;
        position: relative;
        overflow: hidden;
        min-width: 300px;
    }

    /* Monaco Editor –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
    .code-mirror-wrapper .monaco-editor {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    /* Monaco Editor custom styles */
    .monaco-editor .margin {
        background-color: var(--pycharm-gutter);
    }

    .monaco-editor .line-numbers {
        color: var(--pycharm-gutter-fg);
        font-family: 'JetBrains Mono', monospace;
    }

    /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–¥–∞ */
    .code-structure-sidebar {
        width: 250px;
        min-width: 200px;
        max-width: 300px;
        background: var(--sidebar-bg);
        border-left: 1px solid var(--sidebar-border);
        display: flex;
        flex-direction: column;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        overflow: hidden;
        flex-shrink: 0;
        position: relative;
    }

    .structure-header {
        background: var(--sidebar-header);
        color: var(--pycharm-fg);
        padding: 10px 12px;
        font-size: 13px;
        font-weight: 600;
        border-bottom: 1px solid var(--sidebar-border);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
        white-space: nowrap;
        overflow: hidden;
    }

    .structure-header i {
        color: var(--pycharm-accent);
    }

    .structure-content {
        flex: 1;
        overflow-y: auto;
        padding: 5px 0;
        position: relative;
        width: 100%;
        scrollbar-width: thin;
        scrollbar-color: #4c5052 var(--pycharm-gutter);
    }

    /* –°–µ–∫—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã */
    .structure-section {
        width: 100%;
        margin-bottom: 5px;
        display: flex;
        flex-direction: column;
    }

    .section-header {
        background: rgba(255, 255, 255, 0.05);
        padding: 8px 12px;
        color: var(--pycharm-fg);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
        user-select: none;
        width: 100%;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .section-header:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .section-header i:first-child {
        width: 16px;
        text-align: center;
        color: var(--pycharm-info);
    }

    .section-toggle {
        margin-left: auto;
        font-size: 10px;
        opacity: 0.7;
        transition: transform 0.2s;
    }

    .section-header span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .section-items {
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.2);
        width: 100%;
        box-sizing: border-box;
        scrollbar-width: thin;
        scrollbar-color: #4c5052 rgba(0, 0, 0, 0.2);
    }

    /* –≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã */
    .structure-item {
        padding: 6px 12px 6px 28px;
        color: var(--pycharm-fg);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        width: 100%;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .structure-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-left: 3px solid var(--pycharm-info);
        padding-left: 25px;
    }

    .structure-item i {
        font-size: 11px;
        width: 16px;
        text-align: center;
    }

    .item-name {
        flex: 1;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 400;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
    }

    .item-line {
        color: var(--pycharm-gutter-fg);
        font-size: 11px;
        font-family: 'JetBrains Mono', monospace;
        opacity: 0.8;
    }

    /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ñ—É–Ω–∫—Ü–∏–π */
    .func-function i {
        color: #4d9feb;
    }

    .func-magic i {
        color: #c586c0;
    }

    .func-private i {
        color: #f44747;
    }

    .func-constant i {
        color: #b5cea8;
    }

    /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–ª–∞—Å—Å–æ–≤ */
    .class-class i {
        color: #4CAF50;
    }

    .class-abstract i {
        color: #ff9800;
    }

    .class-mixin i {
        color: #9c27b0;
    }

    .class-exception i {
        color: #f44336;
    }

    .import i {
        color: #ce9178;
    }

    .empty-message {
        padding: 10px 12px 10px 28px;
        color: var(--pycharm-comment);
        font-size: 11px;
        font-style: italic;
    }

    /* –°—Ç–∞—Ç—É—Å –±–∞—Ä –≤–Ω–∏–∑—É */
    .editor-status-bar {
        background: var(--pycharm-gutter);
        border-top: 1px solid var(--pycharm-border);
        padding: 6px 15px;
        display: flex;
        justify-content: flex-end;
        font-size: 12px;
        font-family: 'JetBrains Mono', monospace;
        flex-shrink: 0;
        min-height: 32px;
    }

    .status-stats {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
        color: white;
        cursor: default;
        padding: 3px 8px;
        border-radius: 3px;
        transition: all 0.2s;
        font-family: 'JetBrains Mono', monospace;
    }

    .stat-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--pycharm-fg);
    }

    .stat-item i {
        font-size: 12px;
        opacity: 0.8;
    }

    .stat-item.error-stat {
        color: var(--pycharm-error);
    }

    .stat-item.error-stat.has-errors {
        background: rgba(255, 107, 107, 0.15);
        cursor: pointer;
        animation: pulse 2s infinite;
    }

    .stat-item.error-stat.has-errors:hover {
        background: rgba(255, 107, 107, 0.25);
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
        100% {
            opacity: 1;
        }
    }

    /* –ö–æ–Ω—Å–æ–ª—å */
    .console-container {
        background: var(--pycharm-bg);
        border: 1px solid var(--pycharm-border);
        border-radius: 0 0 4px 4px;
        margin-top: 5px;
        display: flex;
        flex-direction: column;
        height: 200px;
        min-height: 150px;
        max-height: 300px;
        overflow: hidden;
    }

    .console-header {
        background: var(--pycharm-gutter);
        border-bottom: 1px solid var(--pycharm-border);
        padding: 8px 15px;
        flex-shrink: 0;
    }

    .console-title {
        color: var(--pycharm-fg);
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
    }

    .console-output {
        flex: 1;
        overflow-y: auto;
        padding: 10px 15px;
        background: var(--pycharm-bg);
    }

    .console-line {
        padding: 3px 0;
        font-size: 13px;
        line-height: 1.4;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    .console-line.info {
        color: var(--pycharm-info);
    }

    .console-line.success {
        color: var(--pycharm-success);
    }

    .console-line.warning {
        color: var(--pycharm-warning);
    }

    .console-line.error {
        color: var(--pycharm-error);
    }

    .console-line.output {
        color: #f0f0f0;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 12px;
    }

    .timestamp {
        color: #777;
        font-size: 11px;
        margin-right: 8px;
        font-family: 'JetBrains Mono', monospace;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—à–∏–±–æ–∫ */
    .pep8-errors-modal {
        position: absolute;
        bottom: 40px;
        right: 15px;
        width: 400px;
        max-height: 300px;
        background: var(--pycharm-bg);
        border: 1px solid var(--pycharm-border);
        border-radius: 6px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow: hidden;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    .pep8-modal-header {
        background: var(--pycharm-gutter);
        padding: 12px 15px;
        border-bottom: 1px solid var(--pycharm-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pep8-modal-header h4 {
        margin: 0;
        font-size: 14px;
        color: var(--pycharm-fg);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .pep8-modal-header h4 i {
        color: var(--pycharm-error);
    }

    .close-modal {
        color: var(--pycharm-gutter-fg);
        font-size: 20px;
        cursor: pointer;
        padding: 0 5px;
        transition: color 0.2s;
    }

    .close-modal:hover {
        color: var(--pycharm-fg);
    }

    .pep8-modal-body {
        padding: 10px;
        max-height: 200px;
        overflow-y: auto;
    }

    .error-group-title {
        color: var(--pycharm-comment);
        font-size: 11px;
        text-transform: uppercase;
        margin: 8px 0 5px 0;
        padding-bottom: 3px;
        border-bottom: 1px solid var(--pycharm-border);
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .error-item {
        padding: 8px 10px;
        margin: 4px 0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
        border-left: 3px solid transparent;
    }

    .error-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid var(--pycharm-error);
        transform: translateX(2px);
    }

    .error-line {
        color: var(--pycharm-error);
        font-weight: 600;
        margin-right: 10px;
        min-width: 70px;
        display: inline-block;
    }

    .error-message {
        color: var(--pycharm-fg);
    }

    .pep8-modal-footer {
        padding: 12px 15px;
        border-top: 1px solid var(--pycharm-border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .pep8-modal-footer button {
        background: #4c5052;
        color: #b0b0b0;
        border: 1px solid #3c3f41;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        font-family: 'Segoe UI', sans-serif;
    }

    .pep8-modal-footer button:hover {
        background: #5a5e5f;
        color: #d0d0d0;
        border-color: #4c5052;
    }

    .pep8-modal-footer button:first-child {
        background: #4CAF50;
        color: white;
        border-color: #45a049;
    }

    .pep8-modal-footer button:first-child:hover {
        background: #45a049;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
    .loading {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid var(--pycharm-fg);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* Monaco Editor decorations */
    .error-line-decoration {
        background: rgba(244, 71, 71, 0.1);
    }

    .warning-line-decoration {
        background: rgba(255, 204, 0, 0.1);
    }

    .error-glyph-margin {
        background: #f44747;
    }

    .warning-glyph-margin {
        background: #ffcc00;
    }

    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .create-task-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
    }

    .create-task-btn:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ */
    .task-creation-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .task-modal-content {
        background: #2b2b2b;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        border: 1px solid #3c3f41;
        overflow: hidden;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ */
    .console-resize-handle {
        height: 5px;
        background: var(--pycharm-border);
        cursor: ns-resize;
        flex-shrink: 0;
        position: relative;
        z-index: 10;
        transition: background 0.2s;
    }

    .console-resize-handle:hover {
        background: var(--pycharm-info);
    }

    .console-resize-handle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 3px;
        background: var(--pycharm-gutter-fg);
        border-radius: 2px;
        opacity: 0.5;
    }

    .console-resize-handle:hover::after {
        opacity: 1;
        background: var(--pycharm-info);
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏ */
    .console-container {
        background: var(--pycharm-bg);
        border: 1px solid var(--pycharm-border);
        border-radius: 0 0 4px 4px;
        margin-top: 5px;
        display: flex;
        flex-direction: column;
        height: 200px;
        min-height: 100px;
        max-height: 800px;
        overflow: hidden;
        position: relative;
        transition: height 0.2s ease;
        user-select: none;
    }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π... */

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-height: 800px) {
        .single-editor {
            height: calc(100vh - 80px);
            min-height: 400px;
        }

        .console-container {
            height: 180px;
            min-height: 120px;
        }
    }

    @media (max-height: 600px) {
        .single-editor {
            height: calc(100vh - 60px);
            min-height: 300px;
        }

        .console-container {
            height: 150px;
            min-height: 100px;
        }
    }

    @media (max-width: 768px) {
        .editor-content-wrapper {
            flex-direction: column;
        }

        .code-structure-sidebar {
            width: 100%;
            max-width: none;
            height: 200px;
            border-left: none;
            border-top: 1px solid var(--sidebar-border);
        }

        .single-editor {
            height: auto;
            min-height: 600px;
        }
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è Monaco Editor */
    .monaco-editor .view-overlays .current-line {
        border: none !important;
        background-color: rgba(33, 66, 131, 0.15) !important;
    }

    .monaco-editor .selected-text {
        background-color: var(--pycharm-selection) !important;
    }

    .monaco-editor .cursor {
        background-color: var(--pycharm-fg) !important;
        border-left: 2px solid var(--pycharm-fg) !important;
    }

    /* –í –≤–∞—à–µ–º CSS —Ñ–∞–π–ª–µ */
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

    /* –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ñ–æ–Ω –≤–æ–∫—Ä—É–≥ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —á—É—Ç—å –º—è–≥—á–µ */
    .monaco-editor, .monaco-editor-background, .monaco-editor .margin {
        background-color: #282c34 !important; /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ One Dark */
    }
</style>