{% load static %}
<div class="single-editor" data-editor-id="{{ tab_id }}">
    <div class="single-header">
        <div class="single-info">
            <div class="single-icon">
                <i class="fab fa-python"></i>
            </div>
            <div class="single-title">{{ name }}</div>
            <div class="font-size-controls">
                <button class="font-btn" onclick="decreaseFontSize('{{ tab_id }}')" title="Уменьшить шрифт">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="font-size-display" id="fontSize_{{ tab_id }}">14px</span>
                <button class="font-btn" onclick="increaseFontSize('{{ tab_id }}')" title="Увеличить шрифт">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div class="task-search-container" style="margin-left: 20px; position: relative;">
                <div class="task-search-wrapper">
                    <!-- Добавлен скрытый input для хранения ID задачи -->
                    <input type="hidden" id="selectedTaskId_{{ tab_id }}" value="">
                    <input type="text"
                           class="task-search-input font-size-controls"
                           id="taskSearchInput_{{ tab_id }}"
                           placeholder="Поиск задачи..."
                           data-tab-id="{{ tab_id }}"
                           data-task-id=""
                           autocomplete="off"
                           style="border: none;color: #c3d4d4;">
                    <button class="task-clear-btn" id="taskClearBtn_{{ tab_id }}" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="task-results-dropdown" id="taskResults_{{ tab_id }}" style="display: none;"></div>
            </div>
        </div>
        <div class="header-actions">
            <button class="tab-run-btn" id="tabRunBtn_{{ tab_id }}">
                <i class="fas fa-play"></i> Запустить
            </button>
        </div>
    </div>

    <div class="editor-content-wrapper">
        <div class="code-mirror-wrapper" id="editorContainer_{{ tab_id }}" style="border: none;">
        </div>

        <div class="console-container" data-console-id="{{ tab_id }}" id="consoleContainer_{{ tab_id }}"
             style="height: 100%;margin-top: 0;">
            <div class="console-header">
                <div class="console-title">
                    <i class="fas fa-terminal"></i>
                    <span>Консоль</span>
                </div>
            </div>

            <div class="console-output" id="consoleOutput_{{ tab_id }}">
                <div class="console-line info">
                    Готов к выполнению кода
                </div>
            </div>
        </div>
    </div>

    <!-- Статус бар -->
    <div class="editor-status-bar" id="statusBar_{{ tab_id }}">
        <div class="status-stats">
            <!-- Всего символов без пробелов -->
            <div class="stat-item" data-tooltip="Всего символов без пробелов">
                <i class="fas fa-font"></i>
                <span id="nonSpaceChars_{{ tab_id }}">0</span>
            </div>

            <!-- Всего функций -->
            <div class="stat-item" data-tooltip="Количество функций">
                <i class="fas fa-code"></i>
                <span id="functionCount_{{ tab_id }}">0</span>
            </div>

            <!-- Всего классов -->
            <div class="stat-item" data-tooltip="Количество классов">
                <i class="fas fa-cube"></i>
                <span id="classCount_{{ tab_id }}">0</span>
            </div>

            <!-- Выделено символов -->
            <div class="stat-item" data-tooltip="Выделено символов">
                <i class="fas fa-highlighter"></i>
                <span id="selectedChars_{{ tab_id }}">0</span>
            </div>

            <!-- Ошибки PEP8 -->
            <div class="stat-item error-stat" id="pep8Errors_{{ tab_id }}" data-tooltip="Ошибки PEP8">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorCount_{{ tab_id }}">0</span>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для ошибок PEP8 -->
<div class="pep8-errors-modal" id="pep8ErrorsModal_{{ tab_id }}" style="display: none;">
    <div class="pep8-modal-header">
        <h4><i class="fas fa-exclamation-triangle"></i> Ошибки PEP8</h4>
        <span class="close-modal" onclick="hidePEP8Modal('{{ tab_id }}')">&times;</span>
    </div>
    <div class="pep8-modal-body">
        <div class="errors-list" id="errorsList_{{ tab_id }}">
            <!-- Ошибки будут добавлены сюда -->
        </div>
    </div>
    <div class="pep8-modal-footer">
        <button onclick="hidePEP8Modal('{{ tab_id }}')">
            Закрыть
        </button>
    </div>
</div>
<script src="{% static 'js/code_editor.js' %}"></script>
<script src="{% static 'js/task_search.js' %}"></script>
<script>
    // Инициализация при загрузке документа
    document.addEventListener('DOMContentLoaded', function () {
        window.taskSearchInstances = window.taskSearchInstances || {};
    });


    // Глобальные функции для работы с задачами
    function loadTaskTemplate(tabId) {
        const taskSearch = window.TaskSearch[tabId];

        if (!taskSearch || !taskSearch.hasSelectedTask()) {
            alert('Сначала выберите задачу!');
            return;
        }

        // Проверяем, есть ли несохраненные изменения
        if (taskSearch.hasUnsavedChanges()) {
            showConfirmLoadModal(tabId);
        } else {
            confirmTaskLoad(tabId);
        }
    }

    function showConfirmLoadModal(tabId) {
        const modal = document.getElementById(`confirmLoadTaskModal_${tabId}`);
        if (modal) {
            modal.style.display = 'block';
        } else {
            // Создаем модальное окно, если его нет
            createConfirmModal(tabId);
            document.getElementById(`confirmLoadTaskModal_${tabId}`).style.display = 'block';
        }
    }

    function createConfirmModal(tabId) {
        const modalHTML = `
            <div class="confirmation-modal" id="confirmLoadTaskModal_${tabId}" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4><i class="fas fa-exclamation-triangle"></i> Внимание!</h4>
                    </div>
                    <div class="modal-body">
                        <p>При загрузке шаблона задачи текущий код будет удален.</p>
                        <p>У вас есть несохраненные изменения. Вы уверены, что хотите продолжить?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" onclick="cancelTaskLoad('${tabId}')">Отмена</button>
                        <button class="btn-primary" onclick="confirmTaskLoad('${tabId}')">Продолжить</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    function cancelTaskLoad(tabId) {
        const modal = document.getElementById(`confirmLoadTaskModal_${tabId}`);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    async function confirmTaskLoad(tabId) {
        const taskSearch = window.taskSearchInstances[tabId];

        if (!taskSearch || !taskSearch.hasSelectedTask()) {
            alert('Ошибка: задача не выбрана');
            return;
        }

        const task = taskSearch.getSelectedTask();

        try {
            // Получаем шаблон задачи
            const response = await fetch(`/code_cup/editor/tasks/${task.id}/template/`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            // Загружаем шаблон в редактор
            if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
                window.codeMonkeyInstances[tabId].setValue(data.template || '');
                console.log(`Шаблон задачи "${task.name}" загружен в таб ${tabId}`);

                // Показываем уведомление об успехе
                showNotification(`Шаблон задачи "${task.name}" успешно загружен`, 'success');
            }

        } catch (error) {
            console.error('Ошибка загрузки шаблона:', error);
            showNotification('Не удалось загрузить шаблон задачи', 'error');
        } finally {
            // Скрываем модальное окно
            cancelTaskLoad(tabId);
        }
    }

    function showNotification(message, type = 'info') {
        // Создаем уведомление
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            ${message}
        `;

        document.body.appendChild(notification);

        // Показываем с анимацией
        setTimeout(() => notification.classList.add('show'), 10);

        // Удаляем через 5 секунд
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }


    // Глобальные функции для взаимодействия с UI
    function increaseFontSize(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].increaseFontSize();
        }
    }

    function decreaseFontSize(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].decreaseFontSize();
        }
    }

    function hidePEP8Modal(tabId) {
        const modal = document.getElementById('pep8ErrorsModal_' + tabId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const items = section.querySelector('.section-items');
        const toggle = section.querySelector('.section-toggle');

        const parts = sectionId.split('_');
        const tabId = parts[parts.length - 1];
        const sectionType = parts[0].replace('Section', '');

        const storageKey = `monacoeditor_section_${tabId}_${sectionType}`;

        if (items.style.display === 'none') {
            items.style.display = 'block';
            toggle.classList.remove('fa-chevron-down');
            toggle.classList.add('fa-chevron-up');
            localStorage.setItem(storageKey, 'open');
        } else {
            items.style.display = 'none';
            toggle.classList.remove('fa-chevron-up');
            toggle.classList.add('fa-chevron-down');
            localStorage.setItem(storageKey, 'closed');
        }
    }

    window.codeMonkeyInstances = window.codeMonkeyInstances || {};

    $(document).ready(function () {
        const tabId = "{{ tab_id }}";
        const name = "{{ name }}";
        const code = `{{ code }}`;

        console.log("tabId", tabId);

        // Создаем экземпляр редактора
        if (window.MonacoEditor) {
            window.codeMonkeyInstances[tabId] = new window.MonacoEditor(tabId, name, code);
        }

        // Создаем экземпляр поиска задач
        window.taskSearchInstances[tabId] = new window.TaskSearch(tabId);

        console.log('Инициализирован TaskSearch для таба:', tabId, window.taskSearchInstances[tabId]);
    });
</script>
<link rel="stylesheet" href="{% static 'css/style_code_page.css' %}">