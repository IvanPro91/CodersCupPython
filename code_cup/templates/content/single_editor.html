<div class="single-editor" data-editor-id="{{ tab_id }}">
    <div class="single-header">
        <div class="single-info">
            <div class="single-icon">
                <i class="fab fa-python"></i>
            </div>
            <div class="single-title">{{ name }}</div>
            <div class="font-size-controls">
                <button class="font-btn" onclick="decreaseFontSize('{{ tab_id }}')" title="Уменьшить шрифт">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="font-size-display" id="fontSize_{{ tab_id }}">14px</span>
                <button class="font-btn" onclick="increaseFontSize('{{ tab_id }}')" title="Увеличить шрифт">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <div class="header-actions">
            <button class="create-task-btn" id="createTaskBtn_{{ tab_id }}" title="Создать задачу из кода">
                <i class="fas fa-tasks"></i> Создать как задачу
            </button>
            <button class="tab-run-btn" id="tabRunBtn_{{ tab_id }}">
                <i class="fas fa-play"></i> Запустить
            </button>
        </div>
    </div>

    <div class="editor-content-wrapper">
        <div class="code-mirror-wrapper">
            <textarea id="codeEditor_{{ tab_id }}" style="display:none;">{{ code }}</textarea>
        </div>

        <!-- Блок с функциями и классами -->
        <div class="code-structure-sidebar" id="structureSidebar_{{ tab_id }}">
            <div class="structure-header">
                <i class="fas fa-sitemap"></i>
                <span>Структура кода</span>
            </div>
            <div class="structure-content">
                <!-- Функции -->
                <div class="structure-section" id="functionsSection_{{ tab_id }}">
                    <div class="section-header" onclick="toggleSection('functionsSection_{{ tab_id }}')">
                        <i class="fas fa-code"></i>
                        <span>Функции (<span id="functionCountDisplay_{{ tab_id }}">0</span>)</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-items" id="functionsList_{{ tab_id }}">
                        <!-- Функции будут добавлены здесь -->
                    </div>
                </div>

                <!-- Классы -->
                <div class="structure-section" id="classesSection_{{ tab_id }}">
                    <div class="section-header" onclick="toggleSection('classesSection_{{ tab_id }}')">
                        <i class="fas fa-cube"></i>
                        <span>Классы (<span id="classCountDisplay_{{ tab_id }}">0</span>)</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-items" id="classesList_{{ tab_id }}">
                        <!-- Классы будут добавлены здесь -->
                    </div>
                </div>

                <!-- Импорты -->
                <div class="structure-section" id="importsSection_{{ tab_id }}">
                    <div class="section-header" onclick="toggleSection('importsSection_{{ tab_id }}')">
                        <i class="fas fa-file-import"></i>
                        <span>Импорты</span>
                        <i class="fas fa-chevron-down section-toggle"></i>
                    </div>
                    <div class="section-items" id="importsList_{{ tab_id }}">
                        <!-- Импорты будут добавлены здесь -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Статус бар -->
    <div class="editor-status-bar" id="statusBar_{{ tab_id }}">
        <div class="status-stats">
            <!-- Всего символов без пробелов -->
            <div class="stat-item" data-tooltip="Всего символов без пробелов">
                <i class="fas fa-font"></i>
                <span id="nonSpaceChars_{{ tab_id }}">0</span>
            </div>

            <!-- Всего функций -->
            <div class="stat-item" data-tooltip="Количество функций">
                <i class="fas fa-code"></i>
                <span id="functionCount_{{ tab_id }}">0</span>
            </div>

            <!-- Всего классов -->
            <div class="stat-item" data-tooltip="Количество классов">
                <i class="fas fa-cube"></i>
                <span id="classCount_{{ tab_id }}">0</span>
            </div>

            <!-- Выделено символов -->
            <div class="stat-item" data-tooltip="Выделено символов">
                <i class="fas fa-highlighter"></i>
                <span id="selectedChars_{{ tab_id }}">0</span>
            </div>

            <!-- Ошибки PEP8 -->
            <div class="stat-item error-stat" id="pep8Errors_{{ tab_id }}" data-tooltip="Ошибки PEP8">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorCount_{{ tab_id }}">0</span>
            </div>
        </div>
    </div>
</div>

<div class="console-container" data-console-id="{{ tab_id }}" id="consoleContainer_{{ tab_id }}">
    <div class="console-header">
        <div class="console-title">
            <i class="fas fa-terminal"></i> Консоль
            <span class="console-status" id="consoleStatus_{{ tab_id }}"></span>
        </div>
        <div class="console-actions">
            <button class="console-btn" id="clearConsoleBtn_{{ tab_id }}" title="Очистить консоль">
                <i class="fas fa-broom"></i>
            </button>
            <button class="console-btn" id="expandConsoleBtn_{{ tab_id }}" title="Развернуть консоль">
                <i class="fas fa-expand-alt"></i>
            </button>
            <button class="console-btn" id="collapseConsoleBtn_{{ tab_id }}" title="Свернуть консоль"
                    style="display: none;">
                <i class="fas fa-compress-alt"></i>
            </button>
        </div>
    </div>

    <!-- Элемент для изменения размера -->
    <div class="console-resize-handle" id="consoleResize_{{ tab_id }}"></div>

    <div class="console-output" id="consoleOutput_{{ tab_id }}">
        <div class="console-line info">Готов к выполнению кода</div>
    </div>
</div>

<!-- Модальное окно для ошибок PEP8 -->
<div class="pep8-errors-modal" id="pep8ErrorsModal_{{ tab_id }}" style="display: none;">
    <div class="pep8-modal-header">
        <h4><i class="fas fa-exclamation-triangle"></i> Ошибки PEP8</h4>
        <span class="close-modal" onclick="hidePEP8Modal('{{ tab_id }}')">&times;</span>
    </div>
    <div class="pep8-modal-body">
        <div class="errors-list" id="errorsList_{{ tab_id }}">
            <!-- Ошибки будут добавлены сюда -->
        </div>
    </div>
    <div class="pep8-modal-footer">
        <button onclick="formatCode('{{ tab_id }}')">
            <i class="fas fa-code"></i> Автоформат
        </button>
        <button onclick="hidePEP8Modal('{{ tab_id }}')">
            Закрыть
        </button>
    </div>
</div>

<!-- Модальное окно для создания задачи -->
<div class="task-creation-modal" id="taskCreationModal_{{ tab_id }}">
    <div class="task-modal-content">
        <div class="task-modal-header">
            <h3><i class="fas fa-tasks"></i> Создание задачи</h3>
            <span class="close-task-modal" onclick="hideTaskModal('{{ tab_id }}')">&times;</span>
        </div>

        <div class="task-modal-body">
            <div class="task-form-section">
                <label for="taskTitle_{{ tab_id }}">Название задачи:</label>
                <input type="text" id="taskTitle_{{ tab_id }}" class="task-input" placeholder="Введите название задачи"
                       value="{{ name }}">
            </div>

            <div class="task-form-section">
                <label for="taskDescription_{{ tab_id }}">Описание задачи:</label>
                <textarea id="taskDescription_{{ tab_id }}" class="task-textarea"
                          placeholder="Опишите задачу, требования, условия..."></textarea>
            </div>

            <div class="task-form-section">
                <label for="taskCode_{{ tab_id }}">Код задачи:</label>
                <div class="code-preview" id="taskCodePreview_{{ tab_id }}">
                    <!-- Код будет отображаться здесь -->
                </div>
                <div class="code-stats">
                    <span>Строк: <span id="taskLinesCount_{{ tab_id }}">0</span></span>
                    <span>Символов: <span id="taskCharsCount_{{ tab_id }}">0</span></span>
                    <span>Без пробелов: <span id="taskNonSpaceCount_{{ tab_id }}">0</span></span>
                </div>
            </div>

            <div class="task-form-section">
                <label>Ограничения:</label>
                <div class="constraints-grid">
                    <!-- Максимальное количество строк -->
                    <div class="constraint-item">
                        <label>
                            <input type="checkbox" id="limitLines_{{ tab_id }}"
                                   onchange="toggleLineLimit('{{ tab_id }}')">
                            Максимальное количество строк:
                        </label>
                        <input type="number" id="maxLines_{{ tab_id }}" class="constraint-input" min="1" max="100"
                               value="10" disabled>
                    </div>

                    <!-- Максимальная длина строки -->
                    <div class="constraint-item">
                        <label>
                            <input type="checkbox" id="limitLineLength_{{ tab_id }}"
                                   onchange="toggleLineLengthLimit('{{ tab_id }}')">
                            Максимальная длина строки:
                        </label>
                        <input type="number" id="maxLineLength_{{ tab_id }}" class="constraint-input" min="10" max="200"
                               value="80" disabled>
                    </div>

                    <!-- Максимальное количество символов -->
                    <div class="constraint-item">
                        <label>
                            <input type="checkbox" id="limitChars_{{ tab_id }}"
                                   onchange="toggleCharLimit('{{ tab_id }}')">
                            Максимальное количество символов:
                        </label>
                        <input type="number" id="maxChars_{{ tab_id }}" class="constraint-input" min="10" max="1000"
                               value="200" disabled>
                    </div>

                    <!-- Максимальное количество функций -->
                    <div class="constraint-item">
                        <label>
                            <input type="checkbox" id="limitFunctions_{{ tab_id }}"
                                   onchange="toggleFunctionLimit('{{ tab_id }}')">
                            Максимальное количество функций:
                        </label>
                        <input type="number" id="maxFunctions_{{ tab_id }}" class="constraint-input" min="0" max="10"
                               value="3" disabled>
                    </div>

                    <!-- Максимальное количество классов -->
                    <div class="constraint-item">
                        <label>
                            <input type="checkbox" id="limitClasses_{{ tab_id }}"
                                   onchange="toggleClassLimit('{{ tab_id }}')">
                            Максимальное количество классов:
                        </label>
                        <input type="number" id="maxClasses_{{ tab_id }}" class="constraint-input" min="0" max="5"
                               value="1" disabled>
                    </div>
                </div>
            </div>

            <div class="task-form-section">
                <label>Запрещённые слова:</label>
                <div class="forbidden-words-container">
                    <div class="words-input-container">
                        <input type="text" id="forbiddenWordInput_{{ tab_id }}" class="word-input"
                               placeholder="Введите запрещённое слово">
                        <button type="button" class="add-word-btn" onclick="addForbiddenWord('{{ tab_id }}')">
                            <i class="fas fa-plus"></i> Добавить
                        </button>
                    </div>
                    <div class="words-list" id="forbiddenWordsList_{{ tab_id }}">
                        <!-- Запрещённые слова будут отображаться здесь -->
                    </div>
                </div>
            </div>

            <div class="task-form-section">
                <label>Входные и выходные данные:</label>
                <div class="io-examples">
                    <div class="io-example">
                        <div class="io-header">
                            <span>Пример 1</span>
                            <button type="button" class="remove-example-btn" onclick="removeExample('{{ tab_id }}', 0)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="io-row">
                            <div class="io-cell">
                                <label>Входные данные:</label>
                                <textarea class="io-input" id="inputExample1_{{ tab_id }}"
                                          placeholder='{"arg1": "value", "arg2": 123}'></textarea>
                            </div>
                            <div class="io-cell">
                                <label>Ожидаемый результат:</label>
                                <textarea class="io-output" id="outputExample1_{{ tab_id }}"
                                          placeholder='{"result": "expected"}'></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" class="add-example-btn" onclick="addExample('{{ tab_id }}')">
                    <i class="fas fa-plus"></i> Добавить пример
                </button>
            </div>

            <div class="task-form-section">
                <label>Теги:</label>
                <div class="tags-container">
                    <div class="tags-input-container">
                        <input type="text" id="tagInput_{{ tab_id }}" class="tag-input" placeholder="Введите тег">
                        <button type="button" class="add-tag-btn" onclick="addTag('{{ tab_id }}')">
                            <i class="fas fa-plus"></i> Добавить
                        </button>
                    </div>
                    <div class="tags-list" id="tagsList_{{ tab_id }}">
                        <!-- Теги будут отображаться здесь -->
                        <span class="tag">python</span>
                        <span class="tag">задача</span>
                    </div>
                </div>
            </div>

            <div class="task-form-section">
                <label>Уровень сложности:</label>
                <div class="difficulty-levels">
                    <label class="difficulty-label">
                        <input type="radio" name="difficulty_{{ tab_id }}" value="easy" checked>
                        <span class="difficulty easy">Лёгкий</span>
                    </label>
                    <label class="difficulty-label">
                        <input type="radio" name="difficulty_{{ tab_id }}" value="medium">
                        <span class="difficulty medium">Средний</span>
                    </label>
                    <label class="difficulty-label">
                        <input type="radio" name="difficulty_{{ tab_id }}" value="hard">
                        <span class="difficulty hard">Сложный</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="task-modal-footer">
            <button class="cancel-task-btn" onclick="hideTaskModal('{{ tab_id }}')">
                Отмена
            </button>
            <button class="create-task-final-btn" onclick="createTask('{{ tab_id }}')">
                <i class="fas fa-check"></i> Создать задачу
            </button>
        </div>
    </div>
</div>

<script>
    // ГЛОБАЛЬНЫЙ КЛАСС - объявляем только если не объявлен
    if (typeof window.CodeMonkey === 'undefined') {
        window.CodeMonkey = class CodeMonkey {
            constructor(tabId, name, initialCode = '') {
                this.tabId = tabId;
                this.name = name;
                this.initialCode = initialCode;
                this.editor = null;
                this.fontSize = localStorage.getItem('codemonkey_fontsize') || 14;
                this.stats = {
                    totalChars: 0,
                    nonSpaceChars: 0,
                    functionCount: 0,
                    classCount: 0,
                    selectedChars: 0,
                    selectedNonSpaceChars: 0,
                    selectedWords: 0,
                    selectedLines: 0,
                    errors: 0
                };
                this.functions = [];
                this.classes = [];
                this.imports = [];
                this.errors = [];
                this.pep8Limit = 119;

                // Данные для создания задачи
                this.taskData = {
                    forbiddenWords: [],
                    examples: [{
                        input: '',
                        output: ''
                    }],
                    tags: ['python', 'задача'],
                    constraints: {
                        maxLines: null,
                        maxLineLength: null,
                        maxChars: null,
                        maxFunctions: null,
                        maxClasses: null
                    }
                };

                this.init();
            }

            init() {
                this.applyFontSize();
                this.createEditor();
                this.bindEvents();
                this.updateAllStats();
                this.setupTooltips();
                this.initStructureSidebar();
                this.initTaskModal();

                // Структуру инициализируем после обновления статистики
                setTimeout(() => {
                    this.initStructureSidebar();
                }, 100);

                // Восстанавливаем высоту консоли
                setTimeout(() => {
                    this.restoreConsoleHeight();
                    this.initConsoleResize();
                }, 200);
            }

            applyFontSize() {
                document.documentElement.style.setProperty('--editor-font-size', `${this.fontSize}px`);
                $(`#fontSize_${this.tabId}`).text(`${this.fontSize}px`);
            }

            increaseFontSize() {
                if (this.fontSize < 24) {
                    this.fontSize++;
                    this.applyFontSize();
                    this.updateEditorFont();
                    localStorage.setItem('codemonkey_fontsize', this.fontSize);
                }
            }

            decreaseFontSize() {
                if (this.fontSize > 10) {
                    this.fontSize--;
                    this.applyFontSize();
                    this.updateEditorFont();
                    localStorage.setItem('codemonkey_fontsize', this.fontSize);
                }
            }

            updateEditorFont() {
                if (this.editor) {
                    const wrapper = this.editor.getWrapperElement();
                    const lineNumbers = wrapper.querySelector('.CodeMirror-linenumber');
                    const code = wrapper.querySelector('.CodeMirror-code');

                    if (lineNumbers) lineNumbers.style.fontSize = `${this.fontSize}px`;
                    if (code) code.style.fontSize = `${this.fontSize}px`;

                    this.editor.refresh();
                }
            }

            createEditor() {
                const textarea = document.getElementById('codeEditor_' + this.tabId);
                if (!textarea) return;

                try {
                    this.editor = CodeMirror.fromTextArea(textarea, {
                        mode: 'python',
                        theme: 'pycharm', // nord
                        lineNumbers: true,
                        matchBrackets: true,
                        indentUnit: 4,
                        tabSize: 4,
                        lineWrapping: false,
                        styleActiveLine: true,
                        autoRefresh: true,
                        value: this.initialCode || textarea.value || '',
                        extraKeys: {
                            "Ctrl-D": function (cm) {
                                // Дублирование строки
                                const cursor = cm.getCursor();
                                const line = cm.getLine(cursor.line);
                                cm.replaceRange(line + "\n", {line: cursor.line, ch: 0});
                                cm.setCursor(cursor.line + 1, cursor.ch);
                            },
                            "Ctrl-Shift-D": function (cm) {
                                // Дублирование выделенного текста
                                if (cm.somethingSelected()) {
                                    const selections = cm.listSelections();
                                    let newSelections = [];
                                    let offset = 0;

                                    selections.forEach((sel, i) => {
                                        const text = cm.getRange(sel.anchor, sel.head);
                                        cm.replaceRange(text, {line: sel.to().line, ch: 0});
                                        offset++;
                                        newSelections.push({
                                            anchor: {line: sel.anchor.line + offset, ch: sel.anchor.ch},
                                            head: {line: sel.head.line + offset, ch: sel.head.ch}
                                        });
                                    });
                                    cm.setSelections(newSelections);
                                } else {
                                    // Если ничего не выделено, дублируем строку
                                    const cursor = cm.getCursor();
                                    const line = cm.getLine(cursor.line);
                                    cm.replaceRange(line + "\n", {line: cursor.line, ch: 0});
                                    cm.setCursor(cursor.line + 1, cursor.ch);
                                }
                            },
                            "Enter": (cm) => this.handleEnterKey(cm),
                            "Tab": (cm) => this.handleTabKey(cm),
                            "Shift-Tab": (cm) => this.handleShiftTabKey(cm),
                            "Ctrl-=": (cm) => {
                                this.increaseFontSize();
                            },
                            "Ctrl--": (cm) => {
                                this.decreaseFontSize();
                            },
                            "Ctrl-0": (cm) => {
                                this.fontSize = 14;
                                this.applyFontSize();
                                this.updateEditorFont();
                                localStorage.setItem('codemonkey_fontsize', this.fontSize);
                            }
                        }
                    });

                    if (this.initialCode) {
                        this.editor.setValue(this.initialCode);
                    }

                    // Применяем размер шрифта к редактору
                    this.updateEditorFont();
                    this.setupMultipleCursors();

                } catch (error) {
                    console.error('Error initializing editor:', error);
                }
            }

            setupMultipleCursors() {
                if (!this.editor) return;

                // Alt+клик для добавления каретки
                this.editor.on("mousedown", (cm, event) => {
                    if (event.altKey && !event.ctrlKey && !event.shiftKey && !event.metaKey) {
                        const pos = cm.coordsChar({left: event.clientX, top: event.clientY});
                        const selections = cm.listSelections();

                        // Добавляем новую каретку
                        const newSelections = [...selections, {anchor: pos, head: pos}];
                        cm.setSelections(newSelections, null, {scroll: false});

                        event.preventDefault();
                        event.stopPropagation();
                    }
                });

                // Alt+стрелки для перемещения кареток
                this.editor.on("keydown", (cm, event) => {
                    if (event.altKey && (event.key === 'ArrowUp' || event.key === 'ArrowDown' ||
                        event.key === 'ArrowLeft' || event.key === 'ArrowRight')) {
                        const selections = cm.listSelections();
                        const newSelections = selections.map(sel => {
                            let newAnchor, newHead;

                            switch (event.key) {
                                case 'ArrowUp':
                                    newAnchor = {line: sel.anchor.line - 1, ch: sel.anchor.ch};
                                    newHead = {line: sel.head.line - 1, ch: sel.head.ch};
                                    break;
                                case 'ArrowDown':
                                    newAnchor = {line: sel.anchor.line + 1, ch: sel.anchor.ch};
                                    newHead = {line: sel.head.line + 1, ch: sel.head.ch};
                                    break;
                                case 'ArrowLeft':
                                    newAnchor = {line: sel.anchor.line, ch: Math.max(0, sel.anchor.ch - 1)};
                                    newHead = {line: sel.head.line, ch: Math.max(0, sel.head.ch - 1)};
                                    break;
                                case 'ArrowRight':
                                    const lineLength = cm.getLine(sel.anchor.line).length;
                                    newAnchor = {line: sel.anchor.line, ch: Math.min(lineLength, sel.anchor.ch + 1)};
                                    newHead = {line: sel.head.line, ch: Math.min(lineLength, sel.head.ch + 1)};
                                    break;
                            }

                            return {anchor: newAnchor, head: newHead};
                        });

                        cm.setSelections(newSelections);
                        event.preventDefault();
                    }
                });
            }

            updateSelectionUI() {
                const selectedText = this.stats.selectedNonSpaceChars > 0
                    ? `${this.stats.selectedNonSpaceChars}с`
                    : "0";

                $('#selectedChars_' + this.tabId).text(selectedText);

                // Детальный tooltip
                const tooltipText = this.stats.selectedNonSpaceChars > 0
                    ? `${this.stats.selectedNonSpaceChars} символов (без пробелов/табов/переносов)\n` +
                    `${this.stats.selectedWords} слов\n` +
                    `${this.stats.selectedLines} строк`
                    : 'Выделено символов (без whitespace)';

                $(`#selectedChars_${this.tabId}`).parent().attr('title', tooltipText);
            }

            initStructureSidebar() {
                // Инициализируем боковую панель структуры
                this.updateStructureSidebar();

                // Восстанавливаем состояние секций из localStorage
                this.restoreSectionStates();
            }

            restoreSectionStates() {
                const sections = ['functions', 'classes', 'imports'];

                sections.forEach(sectionType => {
                    const storageKey = `codemonkey_section_${this.tabId}_${sectionType}`;
                    const savedState = localStorage.getItem(storageKey);
                    const section = document.getElementById(`${sectionType}Section_${this.tabId}`);

                    if (section && savedState === 'closed') {
                        const items = section.querySelector('.section-items');
                        const toggle = section.querySelector('.section-toggle');

                        if (items && toggle) {
                            items.style.display = 'none';
                            toggle.classList.remove('fa-chevron-up');
                            toggle.classList.add('fa-chevron-down');
                        }
                    }
                });
            }

            updateStructureSidebar() {
                this.analyzeCodeStructure();
                this.renderFunctionsList();
                this.renderClassesList();
                this.renderImportsList();
                this.updateStructureCounts();
            }

            analyzeCodeStructure() {
                if (!this.editor) return;

                const code = this.editor.getValue();
                const lines = code.split('\n');

                this.functions = [];
                this.classes = [];
                this.imports = [];

                lines.forEach((line, index) => {
                    const lineNum = index + 1;
                    const trimmed = line.trim();

                    // Обнаружение функций
                    const funcMatch = trimmed.match(/^def\s+(\w+)\s*\(/);
                    if (funcMatch) {
                        const funcName = funcMatch[1];
                        const indent = line.match(/^(\s*)/)[1].length;

                        // Определяем тип функции по имени
                        let type = 'function';
                        let icon = 'fa-code';

                        if (funcName.startsWith('__') && funcName.endsWith('__')) {
                            type = 'magic';
                            icon = 'fa-magic';
                        } else if (funcName.startsWith('_')) {
                            type = 'private';
                            icon = 'fa-lock';
                        } else if (funcName === funcName.toUpperCase()) {
                            type = 'constant';
                            icon = 'fa-hashtag';
                        }

                        this.functions.push({
                            name: funcName,
                            line: lineNum,
                            indent: indent,
                            type: type,
                            icon: icon
                        });
                    }

                    // Обнаружение классов
                    const classMatch = trimmed.match(/^class\s+(\w+)/);
                    if (classMatch) {
                        const className = classMatch[1];
                        const indent = line.match(/^(\s*)/)[1].length;

                        // Определяем тип класса
                        let type = 'class';
                        let icon = 'fa-cube';

                        if (className.includes('Abstract') || className.includes('Base')) {
                            type = 'abstract';
                            icon = 'fa-shapes';
                        } else if (className.includes('Mixin')) {
                            type = 'mixin';
                            icon = 'fa-puzzle-piece';
                        } else if (className.includes('Exception') || className.includes('Error')) {
                            type = 'exception';
                            icon = 'fa-exclamation-circle';
                        }

                        this.classes.push({
                            name: className,
                            line: lineNum,
                            indent: indent,
                            type: type,
                            icon: icon
                        });
                    }

                    // Обнаружение импортов
                    const importMatch = trimmed.match(/^(import|from)\s+(\w+)/);
                    if (importMatch) {
                        const importType = importMatch[1];
                        const module = importMatch[2];

                        this.imports.push({
                            module: module,
                            line: lineNum,
                            type: importType
                        });
                    }
                });
            }

            renderFunctionsList() {
                const container = document.getElementById('functionsList_' + this.tabId);
                if (!container) return;

                container.innerHTML = '';

                if (this.functions.length === 0) {
                    container.innerHTML = '<div class="empty-message">Нет функций</div>';
                    return;
                }

                this.functions.forEach(func => {
                    const funcElement = document.createElement('div');
                    funcElement.className = `structure-item func-${func.type}`;
                    funcElement.innerHTML = `
                    <i class="fas ${func.icon}"></i>
                    <span class="item-name">${func.name}</span>
                    <span class="item-line">:${func.line}</span>
                `;

                    funcElement.onclick = (e) => {
                        e.stopPropagation();
                        this.goToLine(func.line - 1);
                    };

                    container.appendChild(funcElement);
                });
            }

            renderClassesList() {
                const container = document.getElementById('classesList_' + this.tabId);
                if (!container) return;

                container.innerHTML = '';

                if (this.classes.length === 0) {
                    container.innerHTML = '<div class="empty-message">Нет классов</div>';
                    return;
                }

                this.classes.forEach(cls => {
                    const classElement = document.createElement('div');
                    classElement.className = `structure-item class-${cls.type}`;
                    classElement.innerHTML = `
                    <i class="fas ${cls.icon}"></i>
                    <span class="item-name">${cls.name}</span>
                    <span class="item-line">:${cls.line}</span>
                `;

                    classElement.onclick = (e) => {
                        e.stopPropagation();
                        this.goToLine(cls.line - 1);
                    };

                    container.appendChild(classElement);
                });
            }

            renderImportsList() {
                const container = document.getElementById('importsList_' + this.tabId);
                if (!container) return;

                container.innerHTML = '';

                if (this.imports.length === 0) {
                    container.innerHTML = '<div class="empty-message">Нет импортов</div>';
                    return;
                }

                // Группируем импорты по модулям
                const groupedImports = {};
                this.imports.forEach(imp => {
                    if (!groupedImports[imp.module]) {
                        groupedImports[imp.module] = [];
                    }
                    groupedImports[imp.module].push(imp);
                });

                Object.entries(groupedImports).forEach(([module, imports]) => {
                    const importElement = document.createElement('div');
                    importElement.className = 'structure-item import';
                    importElement.innerHTML = `
                    <i class="fas fa-file-import"></i>
                    <span class="item-name">${module}</span>
                `;

                    // При клике переходим к первому импорту этого модуля
                    importElement.onclick = (e) => {
                        e.stopPropagation();
                        this.goToLine(imports[0].line - 1);
                    };

                    container.appendChild(importElement);
                });
            }

            updateStructureCounts() {
                $(`#functionCountDisplay_${this.tabId}`).text(this.functions.length);
                $(`#classCountDisplay_${this.tabId}`).text(this.classes.length);
            }

            initTaskModal() {
                // Инициализация модального окна создания задачи
                this.updateForbiddenWordsList();
                this.updateTagsList();
                this.updateExamplesList();
            }

            bindEvents() {
                // Запуск кода
                $('#tabRunBtn_' + this.tabId).off('click').on('click', () => {
                    this.runCode();
                });

                // Очистка консоли
                $('#clearConsoleBtn_' + this.tabId).off('click').on('click', () => {
                    this.clearConsole();
                });

                // Развернуть консоль
                $(`#expandConsoleBtn_${this.tabId}`).off('click').on('click', () => {
                    this.expandConsole();
                });

                // Свернуть консоль
                $(`#collapseConsoleBtn_${this.tabId}`).off('click').on('click', () => {
                    this.collapseConsole();
                });

                // Создание задачи
                $('#createTaskBtn_' + this.tabId).off('click').on('click', () => {
                    this.showTaskModal();
                });

                // Клик по иконке ошибок PEP8
                $(document).on('click', `#pep8Errors_${this.tabId}`, (e) => {
                    e.stopPropagation();
                    this.showErrorsModal();
                });

                if (this.editor) {
                    // Обновление статистики и структуры
                    this.editor.on('change', () => {
                        this.updateAllStats();
                        this.updateStructureSidebar();
                        this.autoSave();
                    });
                    this.editor.on('cursorActivity', () => {
                        this.updateSelectionStats();
                    });

                    // Обновление статистики выделения
                    this.editor.on('cursorActivity', () => {
                        this.updateSelectionStats();
                    });

                    // Проверка ввода
                    this.editor.on('beforeChange', (cm, change) => {
                        return this.validateInput(change);
                    });
                }

                // Инициализируем изменение размера консоли
                setTimeout(() => {
                    this.initConsoleResize();
                }, 100);
            }

            setupTooltips() {
                // Инициализация тултипов для статистики
                $(`#statusBar_${this.tabId} .stat-item[data-tooltip]`).each(function () {
                    const tooltip = $(this).data('tooltip');
                    $(this).attr('title', tooltip);
                });
            }

            validateInput(change) {
                const newText = change.text.join('');

                // Запрет на точку с запятой
                if (newText.includes(';')) {
                    this.addConsoleMessage('Python не использует точку с запятой (;) в конце строк', 'warning');
                    return false;
                }

                // Проверка длины строки
                if (change.from.line === change.to.line) {
                    const line = this.editor.getLine(change.from.line);
                    const beforeLength = line.length;
                    const changeLength = newText.length - (change.to.ch - change.from.ch);
                    const newLineLength = beforeLength + changeLength;

                    if (newLineLength > this.pep8Limit) {
                        this.addConsoleMessage(`Строка слишком длинная (${newLineLength}/${this.pep8Limit} символов)`, 'warning');
                        return false;
                    }
                }

                return true;
            }

            updateAllStats() {
                if (!this.editor) return;

                const code = this.editor.getValue();

                this.updateCharStats(code);
                this.updateCodeStructureStats(code);
                this.updateSelectionStats();
                this.checkPEP8Rules(code);

                this.updateStatsUI();
            }

            updateCharStats(code) {
                this.stats.totalChars = code.length;
                this.stats.nonSpaceChars = code.replace(/\s/g, '').length;
            }

            updateCodeStructureStats(code) {
                this.stats.functionCount = this.functions.length;
                this.stats.classCount = this.classes.length;
            }

            updateSelectionStats() {
                if (!this.editor) return;

                const selections = this.editor.listSelections();
                let selectedAllChars = 0;
                let selectedNonWhitespaceChars = 0;
                let selectedWords = 0;
                let selectedLines = 0;

                if (selections.length > 0) {
                    const uniqueLines = new Set();

                    selections.forEach(sel => {
                        // Определяем реальные границы выделения (работает в обе стороны)
                        const start = this.editor.getCursor("from"); // Начало выделения
                        const end = this.editor.getCursor("to");     // Конец выделения

                        // Получаем текст выделения (правильно для любого направления)
                        const text = this.editor.getRange(start, end);

                        // Все символы
                        selectedAllChars += text.length;

                        // Не-whitespace символы (все кроме пробелов, табов, переносов строк)
                        selectedNonWhitespaceChars += text.replace(/\s/g, '').length;

                        // Подсчет слов
                        const wordArray = text.match(/\S+/g) || [];
                        selectedWords += wordArray.length;

                        // Подсчет строк
                        const startLine = Math.min(start.line, end.line);
                        const endLine = Math.max(start.line, end.line);
                        for (let i = startLine; i <= endLine; i++) {
                            uniqueLines.add(i);
                        }
                    });

                    selectedLines = uniqueLines.size;
                }

                // Обновляем статистику
                this.stats.selectedChars = selectedAllChars;
                this.stats.selectedNonSpaceChars = selectedNonWhitespaceChars;
                this.stats.selectedWords = selectedWords;
                this.stats.selectedLines = selectedLines;

                // Обновляем UI
                this.updateSelectionUI();
            }

            checkPEP8Rules(code) {
                const lines = code.split('\n');
                this.errors = [];

                this.clearLineMarkers();

                lines.forEach((line, index) => {
                    const lineNum = index + 1;

                    if (line.length > this.pep8Limit) {
                        this.addError(lineNum, `Строка слишком длинная (${line.length}/${this.pep8Limit} символов)`, 'pep8');
                    }

                    if (line.includes(';')) {
                        this.addError(lineNum, 'Точка с запятой не используется в Python', 'syntax');
                    }

                    if (line.startsWith('\t')) {
                        this.addError(lineNum, 'Используйте 4 пробела вместо табов для отступов', 'pep8');
                    }

                    if (line.endsWith(' ') || line.endsWith('\t')) {
                        this.addError(lineNum, 'Уберите пробелы в конце строки', 'pep8');
                    }
                });

                this.stats.errors = this.errors.length;
            }

            addError(lineNum, message, type) {
                this.errors.push({line: lineNum, message, type});

                if (this.editor) {
                    const lineIndex = lineNum - 1;
                    const markerType = type === 'syntax' ? 'error' : 'warning';
                    this.editor.addLineClass(lineIndex, 'wrap', `cm-line-${markerType}-${this.tabId}`);
                }
            }

            clearLineMarkers() {
                if (!this.editor) return;

                for (let i = 0; i < this.editor.lineCount(); i++) {
                    this.editor.removeLineClass(i, 'wrap', `cm-line-error-${this.tabId}`);
                    this.editor.removeLineClass(i, 'wrap', `cm-line-warning-${this.tabId}`);
                }
            }

            updateStatsUI() {
                $('#nonSpaceChars_' + this.tabId).text(this.stats.nonSpaceChars);
                $('#functionCount_' + this.tabId).text(this.stats.functionCount);
                $('#classCount_' + this.tabId).text(this.stats.classCount);
                $('#selectedChars_' + this.tabId).text(this.stats.selectedNonSpaceChars);
                $('#errorCount_' + this.tabId).text(this.stats.errors);

                const errorStat = $('#pep8Errors_' + this.tabId);
                if (this.stats.errors > 0) {
                    errorStat.addClass('has-errors');
                } else {
                    errorStat.removeClass('has-errors');
                }
            }

            showErrorsModal() {
                if (this.errors.length === 0) return;

                const modal = document.getElementById('pep8ErrorsModal_' + this.tabId);
                const errorsList = document.getElementById('errorsList_' + this.tabId);

                errorsList.innerHTML = '';

                const pep8Errors = this.errors.filter(e => e.type === 'pep8');
                const syntaxErrors = this.errors.filter(e => e.type === 'syntax');

                if (pep8Errors.length > 0) {
                    errorsList.innerHTML += '<div class="error-group-title">Ошибки PEP8:</div>';
                    pep8Errors.forEach(error => {
                        errorsList.innerHTML += `
                        <div class="error-item" onclick="window.codeMonkeyInstances['${this.tabId}'].goToLine(${error.line - 1})">
                            <span class="error-line">Строка ${error.line}:</span>
                            <span class="error-message">${error.message}</span>
                        </div>
                    `;
                    });
                }

                if (syntaxErrors.length > 0) {
                    errorsList.innerHTML += '<div class="error-group-title">Синтаксические ошибки:</div>';
                    syntaxErrors.forEach(error => {
                        errorsList.innerHTML += `
                        <div class="error-item" onclick="window.codeMonkeyInstances['${this.tabId}'].goToLine(${error.line - 1})">
                            <span class="error-line">Строка ${error.line}:</span>
                            <span class="error-message">${error.message}</span>
                        </div>
                    `;
                    });
                }

                modal.style.display = 'block';
            }

            hideErrorsModal() {
                document.getElementById('pep8ErrorsModal_' + this.tabId).style.display = 'none';
            }

            showTaskModal() {
                const modal = document.getElementById('taskCreationModal_' + this.tabId);
                if (!modal) return;

                // Обновляем статистику кода в модальном окне
                this.updateTaskCodePreview();

                // Сбрасываем форму
                this.resetTaskForm();

                modal.style.display = 'flex'; // <-- ИЗМЕНИТЬ НА 'flex'
            }

            hideTaskModal() {
                document.getElementById('taskCreationModal_' + this.tabId).style.display = 'none';
            }

            updateTaskCodePreview() {
                const codePreview = document.getElementById('taskCodePreview_' + this.tabId);
                if (!codePreview || !this.editor) return;

                const code = this.editor.getValue();
                const lines = code.split('\n');

                // Форматируем код для отображения
                let html = '<pre><code>';
                lines.forEach((line, index) => {
                    html += `<span class="line-number">${index + 1}</span> ${this.escapeHtml(line)}\n`;
                });
                html += '</code></pre>';

                codePreview.innerHTML = html;

                // Обновляем статистику
                $('#taskLinesCount_' + this.tabId).text(lines.length);
                $('#taskCharsCount_' + this.tabId).text(code.length);
                $('#taskNonSpaceCount_' + this.tabId).text(code.replace(/\s/g, '').length);
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            resetTaskForm() {
                // Сбрасываем форму к начальным значениям
                $('#taskDescription_' + this.tabId).val('');

                // Сбрасываем ограничения
                $('#limitLines_' + this.tabId).prop('checked', false);
                $('#limitLineLength_' + this.tabId).prop('checked', false);
                $('#limitChars_' + this.tabId).prop('checked', false);
                $('#limitFunctions_' + this.tabId).prop('checked', false);
                $('#limitClasses_' + this.tabId).prop('checked', false);

                $('#maxLines_' + this.tabId).prop('disabled', true);
                $('#maxLineLength_' + this.tabId).prop('disabled', true);
                $('#maxChars_' + this.tabId).prop('disabled', true);
                $('#maxFunctions_' + this.tabId).prop('disabled', true);
                $('#maxClasses_' + this.tabId).prop('disabled', true);

                // Сбрасываем запрещённые слова
                this.taskData.forbiddenWords = [];
                this.updateForbiddenWordsList();

                // Сбрасываем примеры
                this.taskData.examples = [{
                    input: '',
                    output: ''
                }];
                this.updateExamplesList();

                // Сбрасываем теги
                this.taskData.tags = ['python', 'задача'];
                this.updateTagsList();

                // Устанавливаем лёгкий уровень сложности
                $('input[name="difficulty_' + this.tabId + '"][value="easy"]').prop('checked', true);
            }

            updateForbiddenWordsList() {
                const list = document.getElementById('forbiddenWordsList_' + this.tabId);
                if (!list) return;

                list.innerHTML = '';

                if (this.taskData.forbiddenWords.length === 0) {
                    list.innerHTML = '<div class="empty-words">Запрещённые слова не добавлены</div>';
                    return;
                }

                this.taskData.forbiddenWords.forEach((word, index) => {
                    const wordElement = document.createElement('div');
                    wordElement.className = 'forbidden-word';
                    wordElement.innerHTML = `
                        <span>${word}</span>
                        <button type="button" class="remove-word-btn" onclick="removeForbiddenWord('${this.tabId}', ${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    list.appendChild(wordElement);
                });
            }

            updateTagsList() {
                const list = document.getElementById('tagsList_' + this.tabId);
                if (!list) return;

                list.innerHTML = '';

                this.taskData.tags.forEach((tag, index) => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        ${tag}
                        <span class="remove-tag" onclick="removeTag('${this.tabId}', ${index})">×</span>
                    `;
                    list.appendChild(tagElement);
                });
            }

            clearConsoleContent() {
                // Только очищаем содержимое, не меняем высоту
                $('#consoleOutput_' + this.tabId).empty();
                this.addConsoleMessage("Консоль очищена", "info");
            }

            updateExamplesList() {
                const container = $('.io-examples');
                if (!container.length) return;

                // Очищаем все примеры кроме первого
                $('.io-example:gt(0)').remove();

                // Обновляем первый пример
                $('#inputExample1_' + this.tabId).val(this.taskData.examples[0].input || '');
                $('#outputExample1_' + this.tabId).val(this.taskData.examples[0].output || '');

                // Добавляем остальные примеры
                for (let i = 1; i < this.taskData.examples.length; i++) {
                    this.addExampleToDOM(i + 1, this.taskData.examples[i]);
                }
            }

            addExampleToDOM(exampleNum, exampleData) {
                const examplesContainer = $('.io-examples');
                const exampleHtml = `
                    <div class="io-example" id="example_${exampleNum}_${this.tabId}">
                        <div class="io-header">
                            <span>Пример ${exampleNum}</span>
                            <button type="button" class="remove-example-btn" onclick="removeExample('${this.tabId}', ${exampleNum - 1})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="io-row">
                            <div class="io-cell">
                                <label>Входные данные:</label>
                                <textarea class="io-input" id="inputExample${exampleNum}_${this.tabId}" placeholder='{"arg1": "value", "arg2": 123}'>${exampleData.input || ''}</textarea>
                            </div>
                            <div class="io-cell">
                                <label>Ожидаемый результат:</label>
                                <textarea class="io-output" id="outputExample${exampleNum}_${this.tabId}" placeholder='{"result": "expected"}' >${exampleData.output || ''}</textarea>
                            </div>
                        </div>
                    </div>
                `;

                examplesContainer.append(exampleHtml);
            }

            goToLine(line) {
                if (!this.editor) return;

                this.editor.setCursor(line, 0);
                this.editor.focus();
                this.editor.scrollIntoView({line: line, ch: 0}, 100);
                this.hideErrorsModal();
            }

            handleEnterKey(cm) {
                const cursor = cm.getCursor();
                const line = cm.getLine(cursor.line);
                const indentMatch = line.match(/^(\s*)/);
                const indent = indentMatch ? indentMatch[1] : '';

                if (line.trim().endsWith(':')) {
                    cm.replaceSelection('\n' + indent + '    ');
                } else {
                    cm.replaceSelection('\n' + indent);
                }
            }

            handleTabKey(cm) {
                if (cm.somethingSelected()) {
                    cm.indentSelection("add");
                } else {
                    cm.replaceSelection('    ', "end", "+input");
                }
            }

            handleShiftTabKey(cm) {
                cm.indentSelection("subtract");
            }

            runCode() {
                if (!this.editor) return;

                const code = this.editor.getValue();
                const runBtn = $('#tabRunBtn_' + this.tabId);

                runBtn.prop('disabled', true);
                runBtn.html('<div class="loading"></div> Выполнение...');

                // Очищаем содержимое консоли, но НЕ сбрасываем высоту
                this.clearConsoleContent();

                if (this.errors.length > 0) {
                    this.addConsoleMessage(`Найдено ${this.errors.length} ошибок`, 'warning');
                    this.errors.slice(0, 2).forEach(error => {
                        this.addConsoleMessage(`  Строка ${error.line}: ${error.message}`, 'warning');
                    });

                    runBtn.prop('disabled', false);
                    runBtn.html('<i class="fas fa-play"></i> Запустить');
                    return;
                }

                // Запоминаем время начала выполнения
                const startTime = Date.now();

                // AJAX запрос на сервер
                $.ajax({
                    url: `${location.origin}/code_cup/editor/run-code/`,
                    type: 'POST',
                    data: {
                        code: code,
                        tab_id: this.tabId,
                        language: 'python'
                    },
                    success: (response) => {
                        const executionTime = Date.now() - startTime;

                        if (response.success) {
                            this.addConsoleMessage(`✓ Код выполнен успешно (${executionTime}мс)`, 'success');

                            // Итоговый вывод
                            if (response.final_output && response.final_output.trim() !== '') {
                                this.addConsoleMessage(response.final_output, 'output');
                            }

                        } else {
                            this.addConsoleMessage(`❌ Ошибка выполнения (${executionTime}мс): ${response.error}`, 'error');
                        }
                    },
                    error: (xhr, status, error) => {
                        const executionTime = Date.now() - startTime;
                        this.addConsoleMessage(`❌ Ошибка соединения (${executionTime}мс): ${error}`, 'error');
                        if (xhr.responseText) {
                            this.addConsoleMessage(`Детали: ${xhr.responseText}`, 'error');
                        }
                    },
                    complete: () => {
                        runBtn.prop('disabled', false);
                        runBtn.html('<i class="fas fa-play"></i> Запустить');
                    }
                });
            }

            addConsoleMessage(message, type = 'info') {
                const consoleOutput = $('#consoleOutput_' + this.tabId);
                if (!consoleOutput.length) return;

                const timestamp = new Date().toLocaleTimeString().slice(0, 5);
                const messageClass = type === 'error' ? 'error' :
                    type === 'success' ? 'success' :
                        type === 'warning' ? 'warning' :
                            type === 'output' ? 'output' : 'info';

                const messageLine = `<div class="console-line ${messageClass}">` +
                    `${message}` +
                    `</div>`;

                consoleOutput.append(messageLine);
                consoleOutput.scrollTop(consoleOutput[0].scrollHeight);
            }

            clearConsole() {
                // Полностью очищаем консоль (по кнопке)
                $('#consoleOutput_' + this.tabId).empty();
                this.addConsoleMessage("Консоль очищена", "info");
                // Не сбрасываем высоту!
            }

            // Восстановление высоты при инициализации
            restoreConsoleHeight() {
                const consoleContainer = $(`#consoleContainer_${this.tabId}`);
                if (consoleContainer.length) {
                    const savedHeight = localStorage.getItem(`console_height_${this.tabId}`);
                    if (savedHeight) {
                        consoleContainer.css('height', `${savedHeight}px`);

                        // Обновляем состояние кнопок
                        if (parseInt(savedHeight) > 250) {
                            $(`#expandConsoleBtn_${this.tabId}`).hide();
                            $(`#collapseConsoleBtn_${this.tabId}`).show();
                        } else {
                            $(`#expandConsoleBtn_${this.tabId}`).show();
                            $(`#collapseConsoleBtn_${this.tabId}`).hide();
                        }
                    }
                }
            }

// Инициализация изменения размера с улучшенной логикой
            initConsoleResize() {
                const handle = document.getElementById(`consoleResize_${this.tabId}`);
                const consoleElem = document.getElementById(`consoleContainer_${this.tabId}`);

                if (!handle || !consoleElem) return;

                handle.addEventListener('mousedown', (e) => {
                    e.preventDefault();

                    const startY = e.clientY;
                    const startHeight = consoleElem.offsetHeight;
                    const consoleRect = consoleElem.getBoundingClientRect();

                    console.log('Ресайз начат:', {
                        startY,
                        startHeight,
                        consoleTop: consoleRect.top,
                        windowHeight: window.innerHeight,
                        availableSpace: window.innerHeight - consoleRect.top
                    });

                    // Отключаем transition
                    consoleElem.style.transition = 'none';
                    consoleElem.classList.add('resizing');

                    const onMouseMove = (e) => {
                        const currentY = e.clientY;
                        const deltaY = startY - currentY;

                        // Сначала вычисляем новую высоту без ограничений
                        let newHeight = startHeight + deltaY;

                        // МЯГКИЕ ограничения:
                        // 1. Нельзя сделать меньше 50px (чтобы оставалось место для handle)
                        // 2. Нельзя сделать больше, чем позволяет доступное пространство
                        const minHeight = 50;
                        const maxHeight = window.innerHeight - consoleRect.top - 10; // 10px отступ

                        console.log('Вычисление:', {
                            deltaY,
                            newHeight,
                            minHeight,
                            maxHeight
                        });

                        // Применяем ограничения
                        if (newHeight < minHeight) {
                            consoleElem.style.height = `${minHeight}px`;
                        } else if (newHeight > maxHeight) {
                            consoleElem.style.height = `${maxHeight}px`;
                        } else {
                            consoleElem.style.height = `${newHeight}px`;
                        }
                    };

                    const onMouseUp = () => {
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);

                        // Восстанавливаем transition
                        consoleElem.style.transition = '';
                        consoleElem.classList.remove('resizing');

                        // Сохраняем
                        this.saveConsoleHeight();
                    };

                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            }

            saveConsoleHeight() {
                const consoleContainer = $(`#consoleContainer_${this.tabId}`);
                if (consoleContainer.length) {
                    const currentHeight = consoleContainer.height();
                    localStorage.setItem(`console_height_${this.tabId}`, currentHeight);
                }
            }

            autoSave() {
                if (!this.editor) return;
                const content = this.editor.getValue();

                try {
                    const tabs = JSON.parse(localStorage.getItem('codeMonkeyTabs') || '{}');
                    tabs[this.tabId] = {
                        id: this.tabId,
                        name: this.name,
                        content: content,
                        lastModified: new Date().toISOString(),
                        stats: this.stats,
                        functions: this.functions,
                        classes: this.classes
                    };
                    localStorage.setItem('codeMonkeyTabs', JSON.stringify(tabs));
                } catch (e) {
                    console.error('Error saving tab:', e);
                }
            }

            resetConsoleHeight() {
                const consoleContainer = $(`#consoleContainer_${this.tabId}`);
                if (consoleContainer.length) {
                    consoleContainer.css('height', '200px');
                    localStorage.removeItem(`console_height_${this.tabId}`);
                }
            }

            expandConsole() {
                const consoleContainer = $(`#consoleContainer_${this.tabId}`);
                const expandBtn = $(`#expandConsoleBtn_${this.tabId}`);
                const collapseBtn = $(`#collapseConsoleBtn_${this.tabId}`);

                if (consoleContainer.length) {
                    consoleContainer.css('height', '500px');
                    expandBtn.hide();
                    collapseBtn.show();
                    this.saveConsoleHeight();
                }
            }

            collapseConsole() {
                const consoleContainer = $(`#consoleContainer_${this.tabId}`);
                const expandBtn = $(`#expandConsoleBtn_${this.tabId}`);
                const collapseBtn = $(`#collapseConsoleBtn_${this.tabId}`);

                if (consoleContainer.length) {
                    consoleContainer.css('height', '200px');
                    expandBtn.show();
                    collapseBtn.hide();
                    this.saveConsoleHeight();
                }
            }

            // initConsoleResize() {
            //     const resizeHandle = $(`#consoleResize_${this.tabId}`);
            //     const consoleContainer = $(`#consoleContainer_${this.tabId}`);
            //
            //     if (!resizeHandle.length || !consoleContainer.length) return;
            //
            //     let isResizing = false;
            //     let startY, startHeight;
            //
            //     resizeHandle.on('mousedown', (e) => {
            //         e.preventDefault();
            //         isResizing = true;
            //         startY = e.clientY;
            //         startHeight = parseInt(consoleContainer.height(), 10);
            //
            //         $(document).on('mousemove', mouseMoveHandler);
            //         $(document).on('mouseup', mouseUpHandler);
            //     });
            //
            //     const mouseMoveHandler = (e) => {
            //         if (!isResizing) return;
            //
            //         const deltaY = startY - e.clientY;
            //         const newHeight = Math.max(100, Math.min(800, startHeight + deltaY));
            //
            //         consoleContainer.css('height', `${newHeight}px`);
            //     };
            //
            //     const mouseUpHandler = () => {
            //         isResizing = false;
            //         $(document).off('mousemove', mouseMoveHandler);
            //         $(document).off('mouseup', mouseUpHandler);
            //
            //         // Сохраняем высоту
            //         const currentHeight = parseInt(consoleContainer.height(), 10);
            //         localStorage.setItem(`console_height_${this.tabId}`, currentHeight);
            //     };
            //
            //     // Восстанавливаем сохраненную высоту
            //     const savedHeight = localStorage.getItem(`console_height_${this.tabId}`);
            //     if (savedHeight) {
            //         consoleContainer.css('height', `${savedHeight}px`);
            //         if (parseInt(savedHeight) > 200) {
            //             $(`#expandConsoleBtn_${this.tabId}`).hide();
            //             $(`#collapseConsoleBtn_${this.tabId}`).show();
            //         }
            //     }
            // }

            formatCode() {
                if (!this.editor) return;

                this.editor.operation(() => {
                    const lines = this.editor.lineCount();
                    for (let i = 0; i < lines; i++) {
                        this.editor.indentLine(i, "smart");
                    }
                });

                this.updateAllStats();
                this.updateStructureSidebar();
                this.hideErrorsModal();
                this.addConsoleMessage("Код отформатирован", "success");
            }

            createTask() {
                // Собираем данные из формы
                const taskTitle = $('#taskTitle_' + this.tabId).val();
                const taskDescription = $('#taskDescription_' + this.tabId).val();
                const code = this.editor.getValue();

                // Собираем ограничения
                const constraints = {
                    maxLines: $('#limitLines_' + this.tabId).is(':checked') ? parseInt($('#maxLines_' + this.tabId).val()) : null,
                    maxLineLength: $('#limitLineLength_' + this.tabId).is(':checked') ? parseInt($('#maxLineLength_' + this.tabId).val()) : null,
                    maxChars: $('#limitChars_' + this.tabId).is(':checked') ? parseInt($('#maxChars_' + this.tabId).val()) : null,
                    maxFunctions: $('#limitFunctions_' + this.tabId).is(':checked') ? parseInt($('#maxFunctions_' + this.tabId).val()) : null,
                    maxClasses: $('#limitClasses_' + this.tabId).is(':checked') ? parseInt($('#maxClasses_' + this.tabId).val()) : null
                };

                // Собираем примеры
                const examples = [];
                $('.io-example').each((index, element) => {
                    const exampleNum = index + 1;
                    const input = $('#inputExample' + exampleNum + '_' + this.tabId).val();
                    const output = $('#outputExample' + exampleNum + '_' + this.tabId).val();

                    if (input || output) {
                        examples.push({
                            input: input,
                            output: output
                        });
                    }
                });

                // Уровень сложности
                const difficulty = $('input[name="difficulty_' + this.tabId + '"]:checked').val();

                // Формируем объект задачи
                const task = {
                    id: 'task_' + Date.now(),
                    title: taskTitle,
                    description: taskDescription,
                    code: code,
                    constraints: constraints,
                    forbiddenWords: this.taskData.forbiddenWords,
                    examples: examples,
                    tags: this.taskData.tags,
                    difficulty: difficulty,
                    created: new Date().toISOString(),
                    stats: {
                        lines: code.split('\n').length,
                        chars: code.length,
                        nonSpaceChars: code.replace(/\s/g, '').length,
                        functions: this.functions.length,
                        classes: this.classes.length
                    }
                };

                // Сохраняем задачу в localStorage
                this.saveTask(task);

                // Закрываем модальное окно
                this.hideTaskModal();

                // Показываем уведомление
                this.addConsoleMessage(`Задача "${taskTitle}" успешно создана!`, 'success');

                return task;
            }

            saveTask(task) {
                console.log("saveTask", task)
                try {
                    const tasks = JSON.parse(localStorage.getItem('codeMonkeyTasks') || '[]');
                    tasks.push(task);
                    localStorage.setItem('codeMonkeyTasks', JSON.stringify(tasks));
                    return true;
                } catch (e) {
                    console.error('Error saving task:', e);
                    this.addConsoleMessage('Ошибка при сохранении задачи', 'error');
                    return false;
                }
            }
        };
    }

    // Глобальные функции для взаимодействия с UI
    function increaseFontSize(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].increaseFontSize();
        }
    }

    function decreaseFontSize(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].decreaseFontSize();
        }
    }

    function hidePEP8Modal(tabId) {
        const modal = document.getElementById('pep8ErrorsModal_' + tabId);
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function formatCode(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].formatCode();
        }
    }

    function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        const items = section.querySelector('.section-items');
        const toggle = section.querySelector('.section-toggle');

        // Извлекаем tabId и sectionType из ID
        const parts = sectionId.split('_');
        const tabId = parts[parts.length - 1];
        const sectionType = parts[0].replace('Section', '');

        // Сохраняем состояние в localStorage
        const storageKey = `codemonkey_section_${tabId}_${sectionType}`;

        if (items.style.display === 'none') {
            items.style.display = 'block';
            toggle.classList.remove('fa-chevron-down');
            toggle.classList.add('fa-chevron-up');
            localStorage.setItem(storageKey, 'open');
        } else {
            items.style.display = 'none';
            toggle.classList.remove('fa-chevron-up');
            toggle.classList.add('fa-chevron-down');
            localStorage.setItem(storageKey, 'closed');
        }
    }

    // Функции для работы с модальным окном создания задачи
    function showTaskModal(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].showTaskModal();
        }
    }

    function hideTaskModal(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].hideTaskModal();
        }
    }

    function toggleLineLimit(tabId) {
        const checkbox = $('#limitLines_' + tabId);
        $('#maxLines_' + tabId).prop('disabled', !checkbox.is(':checked'));
    }

    function toggleLineLengthLimit(tabId) {
        const checkbox = $('#limitLineLength_' + tabId);
        $('#maxLineLength_' + tabId).prop('disabled', !checkbox.is(':checked'));
    }

    function toggleCharLimit(tabId) {
        const checkbox = $('#limitChars_' + tabId);
        $('#maxChars_' + tabId).prop('disabled', !checkbox.is(':checked'));
    }

    function toggleFunctionLimit(tabId) {
        const checkbox = $('#limitFunctions_' + tabId);
        $('#maxFunctions_' + tabId).prop('disabled', !checkbox.is(':checked'));
    }

    function toggleClassLimit(tabId) {
        const checkbox = $('#limitClasses_' + tabId);
        $('#maxClasses_' + tabId).prop('disabled', !checkbox.is(':checked'));
    }

    function addForbiddenWord(tabId) {
        if (!window.codeMonkeyInstances || !window.codeMonkeyInstances[tabId]) return;

        const input = $('#forbiddenWordInput_' + tabId);
        const word = input.val().trim();

        if (word && !window.codeMonkeyInstances[tabId].taskData.forbiddenWords.includes(word)) {
            window.codeMonkeyInstances[tabId].taskData.forbiddenWords.push(word);
            window.codeMonkeyInstances[tabId].updateForbiddenWordsList();
            input.val('');
        }
    }

    function removeForbiddenWord(tabId, index) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].taskData.forbiddenWords.splice(index, 1);
            window.codeMonkeyInstances[tabId].updateForbiddenWordsList();
        }
    }

    function addTag(tabId) {
        if (!window.codeMonkeyInstances || !window.codeMonkeyInstances[tabId]) return;

        const input = $('#tagInput_' + tabId);
        const tag = input.val().trim().toLowerCase();

        if (tag && !window.codeMonkeyInstances[tabId].taskData.tags.includes(tag)) {
            window.codeMonkeyInstances[tabId].taskData.tags.push(tag);
            window.codeMonkeyInstances[tabId].updateTagsList();
            input.val('');
        }
    }

    function removeTag(tabId, index) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].taskData.tags.splice(index, 1);
            window.codeMonkeyInstances[tabId].updateTagsList();
        }
    }

    function addExample(tabId) {
        if (!window.codeMonkeyInstances || !window.codeMonkeyInstances[tabId]) return;

        window.codeMonkeyInstances[tabId].taskData.examples.push({
            input: '',
            output: ''
        });

        const exampleNum = window.codeMonkeyInstances[tabId].taskData.examples.length;
        window.codeMonkeyInstances[tabId].addExampleToDOM(exampleNum, {
            input: '',
            output: ''
        });
    }

    function removeExample(tabId, index) {
        if (!window.codeMonkeyInstances || !window.codeMonkeyInstances[tabId]) return;

        if (window.codeMonkeyInstances[tabId].taskData.examples.length > 1) {
            window.codeMonkeyInstances[tabId].taskData.examples.splice(index, 1);
            window.codeMonkeyInstances[tabId].updateExamplesList();
        }
    }

    function expandConsole(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].expandConsole();
        }
    }

    function collapseConsole(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            window.codeMonkeyInstances[tabId].collapseConsole();
        }
    }

    function createTask(tabId) {
        if (window.codeMonkeyInstances && window.codeMonkeyInstances[tabId]) {
            return window.codeMonkeyInstances[tabId].createTask();
        }
    }

    // Глобальная регистрация экземпляров редакторов
    window.codeMonkeyInstances = window.codeMonkeyInstances || {};

    // Инициализация редактора при загрузке
    $(document).ready(function () {
        const tabId = "{{ tab_id }}";
        const name = "{{ name }}";
        const code = `{{ code }}`;

        // Создаем экземпляр редактора
        window.codeMonkeyInstances[tabId] = new window.CodeMonkey(tabId, name, code);

        try {
            const savedTabs = JSON.parse(localStorage.getItem('codeMonkeyTabs') || '{}');
            const savedTab = savedTabs[tabId];
            if (savedTab && savedTab.content && window.codeMonkeyInstances[tabId]) {
                window.codeMonkeyInstances[tabId].editor.setValue(savedTab.content);
                window.codeMonkeyInstances[tabId].updateAllStats();
                window.codeMonkeyInstances[tabId].updateStructureSidebar();
            }
        } catch (e) {
            console.error('Error loading saved content:', e);
        }
    });
</script>
<style>
    /* Подключаем JetBrains Mono */
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap');

    :root {
        --editor-font-size: 14px;
        --pycharm-bg: #2b2b2b;
        --pycharm-fg: #a9b7c6;
        --pycharm-accent: #9876aa;
        --pycharm-string: #6a8759;
        --pycharm-number: #6897bb;
        --pycharm-keyword: #cc7832;
        --pycharm-comment: #808080;
        --pycharm-selection: #214283;
        --pycharm-gutter: #313335;
        --pycharm-gutter-fg: #606366;
        --pycharm-error: #ff6b6b;
        --pycharm-warning: #ffcc00;
        --pycharm-success: #4CAF50;
        --pycharm-info: #4d9feb;
        --pycharm-border: #3c3f41;
        --sidebar-bg: #2b2b2b;
        --sidebar-border: #3c3f41;
        --sidebar-header: #363636;
    }

    /* Основной контейнер редактора */
    .single-editor {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 100px);
        min-height: 500px;
        max-height: 1000px;
        border: 1px solid var(--pycharm-border);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
        background: var(--pycharm-bg);
    }

    /* Заголовок редактора */
    .single-header {
        background: var(--pycharm-bg);
        border-bottom: 1px solid var(--pycharm-border);
        padding: 8px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
        min-height: 50px;
    }

    .single-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .single-icon {
        color: var(--pycharm-accent);
    }

    .single-title {
        color: var(--pycharm-fg);
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-weight: 500;
    }

    /* Управление шрифтом */
    .font-size-controls {
        display: flex;
        align-items: center;
        gap: 5px;
        margin-left: 15px;
        background: rgba(255, 255, 255, 0.05);
        padding: 3px 8px;
        border-radius: 4px;
        border: 1px solid var(--pycharm-border);
    }

    .font-btn {
        background: transparent;
        border: none;
        padding: 2px 8px;
        font-size: 12px;
        color: var(--pycharm-gutter-fg);
        cursor: pointer;
    }

    .font-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--pycharm-fg);
    }

    .font-size-display {
        color: var(--pycharm-fg);
        font-family: 'JetBrains Mono', monospace;
        font-size: 12px;
        min-width: 40px;
        text-align: center;
    }

    /* Кнопки в стиле PyCharm */
    .tab-run-btn, .console-btn {
        background: #4c5052;
        color: #b0b0b0;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 6px 12px;
        font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tab-run-btn:hover, .console-btn:hover {
        background: #5a5e5f;
        color: #d0d0d0;
        border-color: #4c5052;
    }

    .tab-run-btn:active, .console-btn:active {
        background: #3c3f41;
        transform: translateY(1px);
    }

    /* Контейнер для редактора и боковой панели */
    .editor-content-wrapper {
        display: flex;
        flex: 1;
        overflow: hidden;
        min-height: 300px;
    }

    /* Область с редактором кода */
    .code-mirror-wrapper {
        flex: 1;
        position: relative;
        overflow: hidden;
        min-width: 300px;
    }

    /* PyCharm-like стили для CodeMirror */
    .CodeMirror {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        height: auto !important;
        font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: var(--editor-font-size);
        font-weight: 400;
        line-height: 1.5;
        background: var(--pycharm-bg);
        color: var(--pycharm-fg);
    }

    .CodeMirror-gutters {
        background: var(--pycharm-gutter);
        border-right: 1px solid var(--pycharm-border);
        color: var(--pycharm-gutter-fg);
    }

    .CodeMirror-linenumber {
        color: var(--pycharm-gutter-fg);
        font-size: var(--editor-font-size);
        font-family: 'JetBrains Mono', monospace;
    }

    .CodeMirror-line {
        font-size: var(--editor-font-size);
    }

    .CodeMirror-cursor {
        border-left: 2px solid var(--pycharm-fg);
    }

    .CodeMirror-selected {
        background: var(--pycharm-selection) !important;
    }

    .CodeMirror-focused .CodeMirror-selected {
        background: var(--pycharm-selection) !important;
    }

    /* Подсветка активной строки */
    .CodeMirror-activeline-background {
        background: rgba(33, 66, 131, 0.15) !important;
    }

    /* Синтаксическая подсветка */
    .cm-keyword {
        color: var(--pycharm-keyword);
        font-weight: 600;
    }

    .cm-builtin {
        color: var(--pycharm-keyword);
    }

    .cm-def {
        color: #ffc66d;
    }

    .cm-variable {
        color: var(--pycharm-fg);
    }

    .cm-variable-2 {
        color: #ffc66d;
    }

    .cm-variable-3 {
        color: #9876aa;
    }

    .cm-string {
        color: var(--pycharm-string);
    }

    .cm-string-2 {
        color: var(--pycharm-string);
    }

    .cm-number {
        color: var(--pycharm-number);
    }

    .cm-atom {
        color: #9876aa;
    }

    .cm-operator {
        color: var(--pycharm-fg);
    }

    .cm-comment {
        color: var(--pycharm-comment);
        font-style: italic;
    }

    .cm-meta {
        color: #bbb529;
    }

    .cm-bracket {
        color: var(--pycharm-fg);
    }

    .cm-tag {
        color: #e8bf6a;
    }

    .cm-attribute {
        color: #bababa;
    }

    .cm-link {
        color: var(--pycharm-string);
    }

    .cm-error {
        color: var(--pycharm-error);
    }

    .cm-property {
        color: #ffc66d;
    }

    /* Боковая панель структуры кода */
    .code-structure-sidebar {
        width: 250px;
        min-width: 200px;
        max-width: 300px;
        background: var(--sidebar-bg);
        border-left: 1px solid var(--sidebar-border);
        display: flex;
        flex-direction: column;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        overflow: hidden;
        flex-shrink: 0;
        position: relative;
    }

    .structure-header {
        background: var(--sidebar-header);
        color: var(--pycharm-fg);
        padding: 10px 12px;
        font-size: 13px;
        font-weight: 600;
        border-bottom: 1px solid var(--sidebar-border);
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
        white-space: nowrap;
        overflow: hidden;
    }

    .structure-header i {
        color: var(--pycharm-accent);
    }

    .structure-content {
        flex: 1;
        overflow-y: auto;
        padding: 5px 0;
        position: relative;
        width: 100%;
        scrollbar-width: thin;
        scrollbar-color: #4c5052 var(--pycharm-gutter);
    }

    /* Секции структуры */
    .structure-section {
        width: 100%;
        margin-bottom: 5px;
        display: flex;
        flex-direction: column;
    }

    .section-header {
        background: rgba(255, 255, 255, 0.05);
        padding: 8px 12px;
        color: var(--pycharm-fg);
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: background 0.2s;
        user-select: none;
        width: 100%;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .section-header:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .section-header i:first-child {
        width: 16px;
        text-align: center;
        color: var(--pycharm-info);
    }

    .section-toggle {
        margin-left: auto;
        font-size: 10px;
        opacity: 0.7;
        transition: transform 0.2s;
    }

    .section-header span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }

    .section-items {
        max-height: 200px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.2);
        width: 100%;
        box-sizing: border-box;
        scrollbar-width: thin;
        scrollbar-color: #4c5052 rgba(0, 0, 0, 0.2);
    }

    /* Элементы структуры */
    .structure-item {
        padding: 6px 12px 6px 28px;
        color: var(--pycharm-fg);
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        border-left: 3px solid transparent;
        width: 100%;
        box-sizing: border-box;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .structure-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-left: 3px solid var(--pycharm-info);
        padding-left: 25px;
    }

    .structure-item i {
        font-size: 11px;
        width: 16px;
        text-align: center;
    }

    .item-name {
        flex: 1;
        font-family: 'JetBrains Mono', monospace;
        font-weight: 400;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
    }

    .item-line {
        color: var(--pycharm-gutter-fg);
        font-size: 11px;
        font-family: 'JetBrains Mono', monospace;
        opacity: 0.8;
    }

    /* Цвета для разных типов функций */
    .func-function i {
        color: #4d9feb;
    }

    .func-magic i {
        color: #9876aa;
    }

    .func-private i {
        color: #ff6b6b;
    }

    .func-constant i {
        color: #6897bb;
    }

    /* Цвета для разных типов классов */
    .class-class i {
        color: #4CAF50;
    }

    .class-abstract i {
        color: #ff9800;
    }

    .class-mixin i {
        color: #9c27b0;
    }

    .class-exception i {
        color: #f44336;
    }

    .import i {
        color: #6a8759;
    }

    .empty-message {
        padding: 10px 12px 10px 28px;
        color: var(--pycharm-comment);
        font-size: 11px;
        font-style: italic;
    }

    /* Статус бар внизу */
    .editor-status-bar {
        background: var(--pycharm-gutter);
        border-top: 1px solid var(--pycharm-border);
        padding: 6px 15px;
        display: flex;
        justify-content: flex-end;
        font-size: 12px;
        font-family: 'JetBrains Mono', monospace;
        flex-shrink: 0;
        min-height: 32px;
    }

    .status-stats {
        display: flex;
        gap: 20px;
        align-items: center;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
        color: white;
        cursor: default;
        padding: 3px 8px;
        border-radius: 3px;
        transition: all 0.2s;
        font-family: 'JetBrains Mono', monospace;
    }

    .stat-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--pycharm-fg);
    }

    .stat-item i {
        font-size: 12px;
        opacity: 0.8;
    }

    .stat-item.error-stat {
        color: var(--pycharm-error);
    }

    .stat-item.error-stat.has-errors {
        background: rgba(255, 107, 107, 0.15);
        cursor: pointer;
        animation: pulse 2s infinite;
    }

    .stat-item.error-stat.has-errors:hover {
        background: rgba(255, 107, 107, 0.25);
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
        100% {
            opacity: 1;
        }
    }

    /* Консоль */
    .console-container {
        background: var(--pycharm-bg);
        border: 1px solid var(--pycharm-border);
        border-radius: 0 0 4px 4px;
        margin-top: 5px;
        display: flex;
        flex-direction: column;
        height: 200px;
        min-height: 150px;
        max-height: 300px;
        overflow: hidden;
    }

    .console-header {
        background: var(--pycharm-gutter);
        border-bottom: 1px solid var(--pycharm-border);
        padding: 8px 15px;
        flex-shrink: 0;
    }

    .console-title {
        color: var(--pycharm-fg);
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
    }

    .console-output {
        flex: 1;
        overflow-y: auto;
        padding: 10px 15px;
        background: var(--pycharm-bg);
    }

    .console-line {
        padding: 3px 0;
        font-size: 13px;
        line-height: 1.4;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    .console-line.info {
        color: var(--pycharm-info);
    }

    .console-line.success {
        color: var(--pycharm-success);
    }

    .console-line.warning {
        color: var(--pycharm-warning);
    }

    .console-line.error {
        color: var(--pycharm-error);
    }

    .console-line.output {
        color: #f0f0f0;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        font-size: 12px;
    }

    .timestamp {
        color: #777;
        font-size: 11px;
        margin-right: 8px;
        font-family: 'JetBrains Mono', monospace;
    }

    /* Модальное окно ошибок */
    .pep8-errors-modal {
        position: absolute;
        bottom: 40px;
        right: 15px;
        width: 400px;
        max-height: 300px;
        background: var(--pycharm-bg);
        border: 1px solid var(--pycharm-border);
        border-radius: 6px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow: hidden;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    .pep8-modal-header {
        background: var(--pycharm-gutter);
        padding: 12px 15px;
        border-bottom: 1px solid var(--pycharm-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pep8-modal-header h4 {
        margin: 0;
        font-size: 14px;
        color: var(--pycharm-fg);
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
    }

    .pep8-modal-header h4 i {
        color: var(--pycharm-error);
    }

    .close-modal {
        color: var(--pycharm-gutter-fg);
        font-size: 20px;
        cursor: pointer;
        padding: 0 5px;
        transition: color 0.2s;
    }

    .close-modal:hover {
        color: var(--pycharm-fg);
    }

    .pep8-modal-body {
        padding: 10px;
        max-height: 200px;
        overflow-y: auto;
    }

    .error-group-title {
        color: var(--pycharm-comment);
        font-size: 11px;
        text-transform: uppercase;
        margin: 8px 0 5px 0;
        padding-bottom: 3px;
        border-bottom: 1px solid var(--pycharm-border);
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .error-item {
        padding: 8px 10px;
        margin: 4px 0;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 13px;
        border-left: 3px solid transparent;
    }

    .error-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-left: 3px solid var(--pycharm-error);
        transform: translateX(2px);
    }

    .error-line {
        color: var(--pycharm-error);
        font-weight: 600;
        margin-right: 10px;
        min-width: 70px;
        display: inline-block;
    }

    .error-message {
        color: var(--pycharm-fg);
    }

    .pep8-modal-footer {
        padding: 12px 15px;
        border-top: 1px solid var(--pycharm-border);
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .pep8-modal-footer button {
        background: #4c5052;
        color: #b0b0b0;
        border: 1px solid #3c3f41;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
        font-family: 'Segoe UI', sans-serif;
    }

    .pep8-modal-footer button:hover {
        background: #5a5e5f;
        color: #d0d0d0;
        border-color: #4c5052;
    }

    .pep8-modal-footer button:first-child {
        background: #4CAF50;
        color: white;
        border-color: #45a049;
    }

    .pep8-modal-footer button:first-child:hover {
        background: #45a049;
    }

    /* Анимация загрузки */
    .loading {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid var(--pycharm-fg);
        border-top: 2px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* Стиль для скроллбара */
    .CodeMirror-vscrollbar::-webkit-scrollbar,
    .structure-content::-webkit-scrollbar,
    .pep8-modal-body::-webkit-scrollbar,
    .section-items::-webkit-scrollbar {
        width: 8px;
    }

    .CodeMirror-vscrollbar::-webkit-scrollbar-track,
    .structure-content::-webkit-scrollbar-track,
    .pep8-modal-body::-webkit-scrollbar-track,
    .section-items::-webkit-scrollbar-track {
        background: var(--pycharm-gutter);
    }

    .CodeMirror-vscrollbar::-webkit-scrollbar-thumb,
    .structure-content::-webkit-scrollbar-thumb,
    .pep8-modal-body::-webkit-scrollbar-thumb,
    .section-items::-webkit-scrollbar-thumb {
        background: #4c5052;
        border-radius: 4px;
    }

    .CodeMirror-vscrollbar::-webkit-scrollbar-thumb:hover,
    .structure-content::-webkit-scrollbar-thumb:hover,
    .pep8-modal-body::-webkit-scrollbar-thumb:hover,
    .section-items::-webkit-scrollbar-thumb:hover {
        background: #5a5e5f;
    }

    /* Адаптивность */
    @media (max-height: 800px) {
        .single-editor {
            height: calc(100vh - 80px);
            min-height: 400px;
        }

        .console-container {
            height: 180px;
            min-height: 120px;
        }
    }

    @media (max-height: 600px) {
        .single-editor {
            height: calc(100vh - 60px);
            min-height: 300px;
        }

        .console-container {
            height: 150px;
            min-height: 100px;
        }
    }

    /* Регулировка размера для мобильных устройств */
    @media (max-width: 768px) {
        .editor-content-wrapper {
            flex-direction: column;
        }

        .code-structure-sidebar {
            width: 100%;
            max-width: none;
            height: 200px;
            border-left: none;
            border-top: 1px solid var(--sidebar-border);
        }

        .single-editor {
            height: auto;
            min-height: 600px;
        }
    }

    /* Адаптивность при маленькой ширине */
    @media (max-width: 1200px) {
        .code-structure-sidebar {
            width: 220px;
            min-width: 180px;
        }

        .structure-header span {
            font-size: 12px;
        }

        .section-header {
            padding: 6px 10px;
            font-size: 11px;
        }

        .structure-item {
            padding: 5px 10px 5px 24px;
            font-size: 11px;
        }
    }

    /* Для очень узкой боковой панели */
    @media (max-width: 900px) {
        .code-structure-sidebar {
            width: 200px;
            min-width: 160px;
        }

        .structure-header {
            padding: 8px 10px;
        }

        .structure-header span {
            font-size: 11px;
        }
    }

    /* Основные стили для функциональности создания задач */

    /* Контейнер для действий в заголовке */
    .header-actions {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* Кнопка создания задачи */
    .create-task-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        font-family: 'Segoe UI', 'Helvetica Neue', sans-serif;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
        box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
    }

    .create-task-btn:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }

    .create-task-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 3px rgba(102, 126, 234, 0.3);
    }

    .create-task-btn i {
        font-size: 14px;
    }

    /* Модальное окно создания задачи */
    .task-creation-modal {
        display: none; /* Скрыто по умолчанию */
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
    }

    .task-modal-content {
        background: #2b2b2b;
        border-radius: 8px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        border: 1px solid #3c3f41;
        overflow: hidden;
    }

    .task-modal-header {
        background: #363636;
        padding: 15px 20px;
        border-bottom: 1px solid #3c3f41;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-shrink: 0;
    }

    .task-modal-header h3 {
        margin: 0;
        color: #a9b7c6;
        font-size: 18px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        font-family: 'Segoe UI', sans-serif;
    }

    .task-modal-header h3 i {
        color: #9876aa;
    }

    .close-task-modal {
        color: #808080;
        font-size: 24px;
        cursor: pointer;
        padding: 0 5px;
        transition: color 0.2s;
        line-height: 1;
    }

    .close-task-modal:hover {
        color: #a9b7c6;
    }

    .task-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .task-form-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .task-form-section label {
        color: #a9b7c6;
        font-size: 14px;
        font-weight: 600;
        font-family: 'Segoe UI', sans-serif;
    }

    .task-input, .task-textarea {
        background: #1e1e1e;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 10px;
        color: #a9b7c6;
        font-family: 'JetBrains Mono', monospace;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .task-input:focus, .task-textarea:focus {
        outline: none;
        border-color: #4d9feb;
        box-shadow: 0 0 0 2px rgba(77, 159, 235, 0.2);
    }

    .task-input {
        height: 36px;
    }

    .task-textarea {
        min-height: 100px;
        resize: vertical;
    }

    /* Предпросмотр кода */
    .code-preview {
        background: #1e1e1e;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
        line-height: 1.4;
    }

    .code-preview pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .code-preview code {
        display: block;
        color: #a9b7c6;
    }

    .line-number {
        color: #808080;
        display: inline-block;
        width: 30px;
        text-align: right;
        margin-right: 10px;
        user-select: none;
    }

    .code-stats {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        font-size: 12px;
        color: #808080;
        font-family: 'JetBrains Mono', monospace;
    }

    .code-stats span {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .code-stats span span {
        color: #a9b7c6;
        font-weight: 600;
    }

    /* Ограничения */
    .constraints-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 15px;
        margin-top: 10px;
    }

    .constraint-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 4px;
        border: 1px solid transparent;
        transition: all 0.2s;
    }

    .constraint-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: #3c3f41;
    }

    .constraint-item label {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
        font-weight: normal;
        cursor: pointer;
        flex: 1;
    }

    .constraint-item input[type="checkbox"] {
        margin: 0;
        width: 16px;
        height: 16px;
        cursor: pointer;
    }

    .constraint-input {
        width: 70px;
        background: #1e1e1e;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 5px 8px;
        color: #a9b7c6;
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
        transition: all 0.2s;
    }

    .constraint-input:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: #2b2b2b;
    }

    .constraint-input:focus {
        outline: none;
        border-color: #4d9feb;
    }

    /* Запрещённые слова */
    .forbidden-words-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .words-input-container {
        display: flex;
        gap: 10px;
    }

    .word-input {
        flex: 1;
        background: #1e1e1e;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 8px 12px;
        color: #a9b7c6;
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
    }

    .add-word-btn {
        background: #4c5052;
        color: #b0b0b0;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 8px 15px;
        font-family: 'Segoe UI', sans-serif;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
    }

    .add-word-btn:hover {
        background: #5a5e5f;
        color: #d0d0d0;
    }

    .words-list {
        min-height: 60px;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        background: #1e1e1e;
    }

    .empty-words {
        color: #808080;
        font-style: italic;
        text-align: center;
        width: 100%;
        padding: 20px;
        font-size: 13px;
    }

    .forbidden-word {
        background: rgba(255, 107, 107, 0.15);
        color: #ff6b6b;
        padding: 5px 10px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
        border: 1px solid rgba(255, 107, 107, 0.3);
    }

    .remove-word-btn {
        background: none;
        border: none;
        color: #ff6b6b;
        cursor: pointer;
        padding: 2px;
        font-size: 12px;
        transition: color 0.2s;
    }

    .remove-word-btn:hover {
        color: #ff5252;
    }

    /* Входные и выходные данные */
    .io-examples {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .io-example {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 15px;
        border: 1px solid #3c3f41;
    }

    .io-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #3c3f41;
    }

    .io-header span {
        color: #a9b7c6;
        font-weight: 600;
        font-size: 14px;
    }

    .remove-example-btn {
        background: none;
        border: none;
        color: #808080;
        cursor: pointer;
        padding: 5px;
        font-size: 14px;
        transition: color 0.2s;
        border-radius: 3px;
    }

    .remove-example-btn:hover {
        color: #ff6b6b;
        background: rgba(255, 107, 107, 0.1);
    }

    .io-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .io-cell {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .io-cell label {
        color: #808080;
        font-size: 12px;
        font-weight: normal;
    }

    .io-input, .io-output {
        background: #1e1e1e;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 10px;
        color: #a9b7c6;
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
        min-height: 80px;
        resize: vertical;
        transition: border-color 0.2s;
    }

    .io-input:focus, .io-output:focus {
        outline: none;
        border-color: #4d9feb;
    }

    .add-example-btn {
        background: #4c5052;
        color: #b0b0b0;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 8px 15px;
        font-family: 'Segoe UI', sans-serif;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        align-self: flex-start;
        margin-top: 5px;
    }

    .add-example-btn:hover {
        background: #5a5e5f;
        color: #d0d0d0;
    }

    /* Теги */
    .tags-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .tags-input-container {
        display: flex;
        gap: 10px;
    }

    .tag-input {
        flex: 1;
        background: #1e1e1e;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 8px 12px;
        color: #a9b7c6;
        font-family: 'JetBrains Mono', monospace;
        font-size: 13px;
    }

    .add-tag-btn {
        background: #4c5052;
        color: #b0b0b0;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 8px 15px;
        font-family: 'Segoe UI', sans-serif;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 5px;
        white-space: nowrap;
    }

    .add-tag-btn:hover {
        background: #5a5e5f;
        color: #d0d0d0;
    }

    .tags-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 10px;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        background: #1e1e1e;
        min-height: 45px;
    }

    .tag {
        background: #4d9feb;
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-family: 'Segoe UI', sans-serif;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s;
    }

    .tag:hover {
        background: #3d8fdb;
        transform: translateY(-1px);
    }

    .remove-tag {
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        padding-left: 3px;
        opacity: 0.8;
        transition: opacity 0.2s;
    }

    .remove-tag:hover {
        opacity: 1;
    }

    /* Уровень сложности */
    .difficulty-levels {
        display: flex;
        gap: 20px;
        margin-top: 5px;
    }

    .difficulty-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        margin: 0;
        font-weight: normal;
    }

    .difficulty-label input[type="radio"] {
        display: none;
    }

    .difficulty {
        padding: 8px 20px;
        border-radius: 4px;
        font-family: 'Segoe UI', sans-serif;
        font-size: 13px;
        font-weight: 600;
        transition: all 0.2s;
        border: 2px solid transparent;
        cursor: pointer;
    }

    .difficulty.easy {
        background: rgba(76, 175, 80, 0.15);
        color: #4CAF50;
        border-color: rgba(76, 175, 80, 0.3);
    }

    .difficulty.medium {
        background: rgba(255, 152, 0, 0.15);
        color: #FF9800;
        border-color: rgba(255, 152, 0, 0.3);
    }

    .difficulty.hard {
        background: rgba(244, 67, 54, 0.15);
        color: #F44336;
        border-color: rgba(244, 67, 54, 0.3);
    }

    .difficulty-label input[type="radio"]:checked + .difficulty {
        background: #4CAF50;
        color: white;
        border-color: #45a049;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .difficulty-label input[type="radio"]:checked + .difficulty.medium {
        background: #FF9800;
        border-color: #f57c00;
    }

    .difficulty-label input[type="radio"]:checked + .difficulty.hard {
        background: #F44336;
        border-color: #d32f2f;
    }

    .difficulty-label input[type="radio"]:checked + .difficulty::before {
        content: "✓ ";
        font-weight: bold;
    }

    /* Футер модального окна */
    .task-modal-footer {
        background: #363636;
        padding: 15px 20px;
        border-top: 1px solid #3c3f41;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        flex-shrink: 0;
    }

    .cancel-task-btn {
        background: #4c5052;
        color: #b0b0b0;
        border: 1px solid #3c3f41;
        border-radius: 4px;
        padding: 10px 20px;
        font-family: 'Segoe UI', sans-serif;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .cancel-task-btn:hover {
        background: #5a5e5f;
        color: #d0d0d0;
    }

    .create-task-final-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 10px 25px;
        font-family: 'Segoe UI', sans-serif;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
    }

    .create-task-final-btn:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }

    .create-task-final-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 3px rgba(102, 126, 234, 0.3);
    }

    /* Стили для скроллбаров */
    .task-modal-body::-webkit-scrollbar,
    .code-preview::-webkit-scrollbar,
    .words-list::-webkit-scrollbar,
    .io-input::-webkit-scrollbar,
    .io-output::-webkit-scrollbar {
        width: 8px;
    }

    .task-modal-body::-webkit-scrollbar-track,
    .code-preview::-webkit-scrollbar-track,
    .words-list::-webkit-scrollbar-track,
    .io-input::-webkit-scrollbar-track,
    .io-output::-webkit-scrollbar-track {
        background: #1e1e1e;
        border-radius: 4px;
    }

    .task-modal-body::-webkit-scrollbar-thumb,
    .code-preview::-webkit-scrollbar-thumb,
    .words-list::-webkit-scrollbar-thumb,
    .io-input::-webkit-scrollbar-thumb,
    .io-output::-webkit-scrollbar-thumb {
        background: #4c5052;
        border-radius: 4px;
    }

    .task-modal-body::-webkit-scrollbar-thumb:hover,
    .code-preview::-webkit-scrollbar-thumb:hover,
    .words-list::-webkit-scrollbar-thumb:hover,
    .io-input::-webkit-scrollbar-thumb:hover,
    .io-output::-webkit-scrollbar-thumb:hover {
        background: #5a5e5f;
    }

    /* Анимации */
    @keyframes modalAppear {
        from {
            opacity: 0;
            transform: translateY(-20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .task-creation-modal[style*="display: block"] .task-modal-content {
        animation: modalAppear 0.3s ease-out;
    }

    /* Адаптивность */
    @media (max-width: 768px) {
        .task-modal-content {
            width: 95%;
            max-height: 95vh;
        }

        .constraints-grid {
            grid-template-columns: 1fr;
        }

        .io-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .difficulty-levels {
            flex-direction: column;
            gap: 10px;
        }

        .difficulty {
            text-align: center;
            width: 100%;
        }

        .header-actions {
            flex-direction: column;
            align-items: stretch;
            gap: 5px;
        }

        .create-task-btn, .tab-run-btn {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .task-modal-body {
            padding: 15px;
        }

        .task-modal-header {
            padding: 12px 15px;
        }

        .task-modal-footer {
            padding: 12px 15px;
            flex-direction: column;
        }

        .cancel-task-btn, .create-task-final-btn {
            width: 100%;
            justify-content: center;
        }

        .words-input-container, .tags-input-container {
            flex-direction: column;
        }

        .add-word-btn, .add-tag-btn {
            width: 100%;
            justify-content: center;
        }
    }

    /* Тёмная тема - дополнительные стили */
    @media (prefers-color-scheme: dark) {
        .task-modal-content {
            background: #1e1e1e;
            border-color: #333;
        }

        .task-modal-header {
            background: #252526;
            border-color: #333;
        }

        .task-input, .task-textarea,
        .code-preview, .constraint-input,
        .word-input, .tag-input,
        .io-input, .io-output {
            background: #252526;
            border-color: #333;
        }

        .words-list, .tags-list {
            background: #252526;
            border-color: #333;
        }

        .io-example {
            border-color: #333;
            background: rgba(255, 255, 255, 0.03);
        }

        .task-modal-footer {
            background: #252526;
            border-color: #333;
        }
    }

    /* Стили для tooltip */
    [data-tooltip] {
        position: relative;
        cursor: help;
    }

    [data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #1e1e1e;
        color: #a9b7c6;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        border: 1px solid #3c3f41;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        pointer-events: none;
    }

    /* Подсветка обязательных полей */
    .task-input:required:invalid,
    .task-textarea:required:invalid {
        border-color: #ff6b6b;
    }

    .task-input:required:valid,
    .task-textarea:required:valid {
        border-color: #4CAF50;
    }

    /* Плейсхолдеры */
    ::placeholder {
        color: #808080;
        opacity: 0.7;
    }

    /* Стили для фокуса доступности */
    .task-input:focus-visible,
    .task-textarea:focus-visible,
    .constraint-input:focus-visible,
    .word-input:focus-visible,
    .tag-input:focus-visible,
    .io-input:focus-visible,
    .io-output:focus-visible {
        outline: 2px solid #4d9feb;
        outline-offset: 2px;
    }

    /* Загрузка для кнопки создания задачи */
    .create-task-final-btn.loading {
        position: relative;
        color: transparent;
    }

    .create-task-final-btn.loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* Уведомления */
    .task-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
        font-family: 'Segoe UI', sans-serif;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .task-notification.error {
        background: #F44336;
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    .task-notification.hiding {
        animation: slideOut 0.3s ease-in forwards;
    }

    /* Группировка в модальном окне */
    .task-form-group {
        background: rgba(255, 255, 255, 0.03);
        border-radius: 6px;
        padding: 15px;
        border: 1px solid #3c3f41;
    }

    .task-form-group .task-form-section:last-child {
        margin-bottom: 0;
    }

    /* Иконки для различных типов ограничений */
    .constraint-item label::before {
        content: '⚙️';
        margin-right: 5px;
        font-size: 14px;
    }

    .constraint-item:nth-child(2) label::before {
        content: '📏';
    }

    .constraint-item:nth-child(3) label::before {
        content: '🔢';
    }

    .constraint-item:nth-child(4) label::before {
        content: '📝';
    }

    .constraint-item:nth-child(5) label::before {
        content: '🏗️';
    }

    /* Стили для изменения размера консоли */
    .console-resize-handle {
        height: 5px;
        background: var(--pycharm-border);
        cursor: ns-resize;
        flex-shrink: 0;
        position: relative;
        z-index: 10;
        transition: background 0.2s;
    }

    .console-resize-handle:hover {
        background: var(--pycharm-info);
    }

    .console-resize-handle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 3px;
        background: var(--pycharm-gutter-fg);
        border-radius: 2px;
        opacity: 0.5;
    }

    .console-resize-handle:hover::after {
        opacity: 1;
        background: var(--pycharm-info);
    }

    /* Улучшенные стили для консоли */
    .console-container {
        background: var(--pycharm-bg);
        border: 1px solid var(--pycharm-border);
        border-radius: 0 0 4px 4px;
        margin-top: 5px;
        display: flex;
        flex-direction: column;
        height: 200px; /* Стандартная высота */
        min-height: 100px;
        max-height: 800px;
        overflow: hidden;
        resize: vertical; /* Браузерный resize как fallback */
        position: relative;
    }

    /* Убираем браузерный resize для нашего кастомного */
    .console-container {
        resize: none;
    }

    .console-header {
        background: var(--pycharm-gutter);
        border-bottom: 1px solid var(--pycharm-border);
        padding: 8px 15px;
        flex-shrink: 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .console-title {
        color: var(--pycharm-fg);
        font-family: 'JetBrains Mono', monospace;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .console-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .console-output {
        flex: 1;
        overflow-y: auto;
        padding: 10px 15px;
        background: var(--pycharm-bg);
        font-size: 13px;
        line-height: 1.4;
    }

    /* Улучшенные стили для сообщений */
    .console-line {
        padding: 4px 0;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        white-space: pre-wrap;
        word-break: break-word;
        border-left: 3px solid transparent;
        padding-left: 8px;
        margin: 2px 0;
        transition: background 0.2s;
    }

    .console-line:hover {
        background: rgba(255, 255, 255, 0.03);
    }

    .console-line.info {
        color: var(--pycharm-info);
        border-left-color: var(--pycharm-info);
    }

    .console-line.success {
        color: var(--pycharm-success);
        border-left-color: var(--pycharm-success);
    }

    .console-line.warning {
        color: var(--pycharm-warning);
        border-left-color: var(--pycharm-warning);
    }

    .console-line.error {
        color: var(--pycharm-error);
        border-left-color: var(--pycharm-error);
    }

    .console-line.output {
        color: #f0f0f0;
        font-family: 'JetBrains Mono', 'Fira Code', monospace;
        border-left-color: #555;
    }

    /* Специальные стили для заголовков разделов */
    .console-line.output:first-child {
        font-weight: bold;
        color: #fff;
        margin-top: 5px;
        padding-top: 8px;
        border-top: 1px solid var(--pycharm-border);
    }

    .timestamp {
        color: #777;
        font-size: 11px;
        margin-right: 8px;
        font-family: 'JetBrains Mono', monospace;
        opacity: 0.7;
    }

    /* Анимация для новых сообщений */
    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .console-line {
        animation: slideIn 0.2s ease-out;
    }

    /* Полоса прокрутки для консоли */
    .console-output::-webkit-scrollbar {
        width: 8px;
    }

    .console-output::-webkit-scrollbar-track {
        background: var(--pycharm-gutter);
        border-radius: 4px;
    }

    .console-output::-webkit-scrollbar-thumb {
        background: #4c5052;
        border-radius: 4px;
    }

    .console-output::-webkit-scrollbar-thumb:hover {
        background: #5a5e5f;
    }

    /* Индикатор изменения размера */
    .console-resizing .console-output {
        pointer-events: none;
    }

    /* Адаптивность для маленьких экранов */
    @media (max-height: 600px) {
        .console-container {
            height: 150px;
            min-height: 80px;
        }
    }

    @media (max-width: 768px) {
        .console-container {
            height: 180px;
            min-height: 120px;
        }

        .console-header {
            padding: 6px 10px;
        }

        .console-title {
            font-size: 12px;
        }

        .console-btn {
            padding: 4px 8px;
            font-size: 11px;
        }
    }

    .console-container {
        background: var(--pycharm-bg);
        border: 1px solid var(--pycharm-border);
        border-radius: 0 0 4px 4px;
        margin-top: 5px;
        display: flex;
        flex-direction: column;
        height: 200px;
        min-height: 100px;
        max-height: 800px;
        overflow: hidden;
        position: relative;
        transition: height 0.2s ease;
        user-select: none; /* Предотвращаем выделение при ресайзе */
    }

    .console-resize-handle {
        height: 8px;
        background: transparent;
        cursor: ns-resize;
        flex-shrink: 0;
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .console-resize-handle:hover,
    .console-resizing .console-resize-handle {
        background: rgba(77, 159, 235, 0.2);
    }

    .console-resize-handle::before {
        content: '';
        width: 40px;
        height: 4px;
        background: var(--pycharm-gutter-fg);
        border-radius: 2px;
        opacity: 0.3;
        transition: all 0.2s;
    }

    .console-resize-handle:hover::before,
    .console-resizing .console-resize-handle::before {
        opacity: 0.8;
        background: var(--pycharm-info);
        width: 60px;
    }

    /* Анимация для кнопок */
    .console-btn {
        transition: all 0.2s ease;
    }

    .console-btn:hover {
        transform: translateY(-1px);
    }
</style>