<!-- Модальное окно создания нового таба -->
<div class="modal-overlay" id="newTabModal">
    <div class="modal">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-plus-circle"></i> Создать новый таб
            </h2>
            <button class="close-modal" id="closeNewTabModal">&times;</button>
        </div>
        <div class="modal-content">
            <div class="tab-options">
                <div class="tab-option" data-type="single">
                    <div class="option-icon">
                        <i class="fas fa-file-code"></i>
                    </div>
                    <div class="option-content">
                        <div class="option-title">Одиночный редактор</div>
                        <div class="option-description">Один пользователь, одна задача</div>
                    </div>
                </div>
            </div>

            <!-- Форма для одиночного редактора -->
            <div class="modal-form" id="singleForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Название файла</label>
                    <input type="text" class="form-input" id="singleFileName" placeholder="script.py" value="script.py">
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn secondary" id="cancelNewTab">Отмена</button>
                <button class="modal-btn primary" id="createTab">Создать</button>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // Модальное окно создания нового таба
    class NewTabModal {
        constructor(web_socket, cls_editor) {
            this.currentTabType = null;
            this.web_socket = web_socket;
            this.cls_editor = cls_editor;
            this.modal = $('#newTabModal');
            this.selectedTask = null;
            this.taskSearchTimeout = null;
            this.init();
        }

        init() {
            this.bindEvents();
        }

        bindEvents() {
            const self = this;

            // Закрытие модального окна
            $('#closeNewTabModal, #cancelNewTab').on('click', function() {
                self.hide();
            });

            // Клик вне модального окна
            this.modal.on('click', function(e) {
                if ($(e.target).is(this)) {
                    self.hide();
                }
            });

            // Выбор типа таба
            $('.tab-option').on('click', function(e) {
                self.onTabOptionClick($(this));
            });

            // Кнопка поиска пользователя
            $('#searchUserBtn').on('click', function() {
                self.onSearchUser();
            });

            // Поиск задач при вводе
            $('#taskSearchInput').on('input', function() {
                clearTimeout(self.taskSearchTimeout);
                const query = $(this).val().trim();

                if (query.length === 0) {
                    self.hideTaskSearchResults();
                    $('#clearTaskSearch').hide();
                    return;
                }

                $('#clearTaskSearch').show();

                self.taskSearchTimeout = setTimeout(() => {
                    self.searchTasks(query);
                }, 300);
            });

            // Очистка поиска задач
            $('#clearTaskSearch').on('click', function() {
                $('#taskSearchInput').val('');
                self.hideTaskSearchResults();
                $(this).hide();
            });

            // Очистка выбранной задачи
            $('#clearTaskSelection').on('click', function() {
                self.clearTaskSelection();
            });

            // Клик вне результатов поиска задач
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.task-search-container').length) {
                    self.hideTaskSearchResults();
                }
            });

            // Выбор задачи из результатов поиска
            $(document).on('click', '.task-result-item', function() {
                const taskId = $(this).data('task-id');
                const taskTitle = $(this).data('task-title');
                const taskDescription = $(this).data('task-description');

                self.selectTask({
                    id: taskId,
                    title: taskTitle,
                    description: taskDescription
                });
            });

            // Делегирование событий для кнопок приглашения из результатов поиска
            $('#userSearchResults').on('click', '.invite-btn-small', function(e) {
                self.onInviteUser($(this));
            });

            // Кнопка создания таба
            $('#createTab').on('click', function() {
                self.onCreateTab();
            });

            // Автофокус при показе форм
            $(document).on('shown.bs.modal', function() {
                self.setupAutoFocus();
            });
        }

        show() {
            this.modal.addClass('show');
            this.resetForm();
        }

        hide() {
            this.modal.removeClass('show');
        }

        resetForm() {
            // Сброс выбора
            $('.tab-option').removeClass('selected');

            // Скрываем все формы
            $('.modal-form').hide();

            // Скрываем результаты поиска
            $('#userSearchResults').hide().empty();
            $('#taskSearchResults').hide().empty();

            // Скрываем кастомную задачу и информацию о выбранной задаче
            $('#customTaskGroup').hide();
            $('#selectedTaskInfo').hide();
            $('#clearTaskSearch').hide();

            // Очищаем поля
            $('#taskSearchInput').val('');
            this.selectedTask = null;

            // Делаем кнопку создания неактивной
            $('#createTab').prop('disabled', true);

            // Сбрасываем текущий тип
            this.currentTabType = null;

            // Очищаем ошибки
            this.clearErrors();
        }

        onTabOptionClick($option) {
            const type = $option.data('type');

            // Снимаем выделение со всех опций
            $('.tab-option').removeClass('selected');

            // Выделяем выбранную опцию
            $option.addClass('selected');
            this.currentTabType = type;

            // Показываем соответствующую форму
            this.showForm(type);

            // Активируем кнопку создания
            $('#createTab').prop('disabled', false);
        }

        showForm(type) {
            // Скрываем все формы
            $('.modal-form').hide();

            // Показываем нужную форму
            if (type === 'single') {
                $('#singleForm').show();
                this.setupAutoFocus('#singleFileName');
            } else if (type === 'collaborative') {
                $('#collaborativeForm').show();
                this.setupAutoFocus('#collabSessionName');
                // Скрываем результаты поиска
                $('#userSearchResults').hide();
            }
        }

        setupAutoFocus(selector) {
            if (selector) {
                setTimeout(() => {
                    $(selector).focus();
                }, 100);
            }
        }

        async searchTasks(query) {
            const $resultsContainer = $('#taskSearchResults');

            // Показываем индикатор загрузки
            $resultsContainer.html(`
                <div class="search-loading">
                    <i class="fas fa-spinner fa-spin"></i> Поиск задач...
                </div>
            `).show();

            try {
                // Запрос к серверу для поиска задач
                const response = await this.fetchTasksFromServer(query);

                if (response.tasks && response.tasks.length > 0) {
                    const html = response.tasks.map(task => `
                        <div class="task-result-item"
                             data-task-id="${task.id}"
                             data-task-title="${task.title}"
                             data-task-description="${task.description}">
                            <div class="task-result-title">${task.title}</div>
                            <div class="task-result-difficulty ${task.difficulty}">
                                ${this.getDifficultyText(task.difficulty)}
                            </div>
                            <div class="task-result-description">${task.description.substring(0, 100)}...</div>
                        </div>
                    `).join('');

                    $resultsContainer.html(html);
                } else {
                    $resultsContainer.html(`
                        <div class="search-no-results">
                            <i class="fas fa-search"></i> Задачи не найдены
                        </div>
                    `);
                }
            } catch (error) {
                console.error('Ошибка поиска задач:', error);
                $resultsContainer.html(`
                    <div class="search-error">
                        <i class="fas fa-exclamation-triangle"></i> Ошибка при поиске задач
                    </div>
                `);
            }
        }

        async fetchTasksFromServer(query) {
            // Здесь будет реальный AJAX запрос к вашему серверу
            // Пример моковых данных для демонстрации
            const mockTasks = [
                {id: 1, title: 'Палиндром', description: 'Напишите функцию, которая проверяет, является ли строка палиндромом.', difficulty: 'easy'},
                {id: 2, title: 'Простые числа', description: 'Найти все простые числа до заданного N.', difficulty: 'medium'},
                {id: 3, title: 'Анаграммы', description: 'Проверить, являются ли две строки анаграммами.', difficulty: 'easy'},
                {id: 4, title: 'Числа Фибоначчи', description: 'Вычислить n-ное число Фибоначчи.', difficulty: 'easy'},
                {id: 5, title: 'Уникальные символы', description: 'Определить, все ли символы в строке уникальны.', difficulty: 'easy'},
                {id: 6, title: 'Сортировка пузырьком', description: 'Реализуйте алгоритм сортировки пузырьком.', difficulty: 'medium'},
                {id: 7, title: 'Бинарный поиск', description: 'Реализуйте алгоритм бинарного поиска.', difficulty: 'medium'},
                {id: 8, title: 'Обратная строка', description: 'Напишите функцию для обращения строки.', difficulty: 'easy'},
                {id: 9, title: 'Проверка скобок', description: 'Проверьте правильность расстановки скобок в выражении.', difficulty: 'medium'},
                {id: 10, title: 'Наибольший общий делитель', description: 'Найдите НОД двух чисел.', difficulty: 'easy'}
            ];

            // Имитация задержки сети
            await new Promise(resolve => setTimeout(resolve, 500));

            // Фильтрация по запросу
            const filteredTasks = mockTasks.filter(task =>
                task.title.toLowerCase().includes(query.toLowerCase()) ||
                task.description.toLowerCase().includes(query.toLowerCase())
            );

            return { tasks: filteredTasks };
        }

        getDifficultyText(difficulty) {
            const difficultyMap = {
                'easy': 'Легкая',
                'medium': 'Средняя',
                'hard': 'Сложная'
            };
            return difficultyMap[difficulty] || difficulty;
        }

        hideTaskSearchResults() {
            $('#taskSearchResults').hide().empty();
        }

        selectTask(task) {
            this.selectedTask = task;

            // Обновляем UI
            $('#selectedTaskTitle').text(task.title);
            $('#selectedTaskDescription').text(task.description);
            $('#selectedTaskInfo').show();

            // Скрываем поле поиска и результаты
            $('#taskSearchInput').val('');
            $('#clearTaskSearch').hide();
            this.hideTaskSearchResults();

            // Закрываем модальное окно после выбора
            this.hide();

            // Загружаем данные задачи с сервера
            this.loadTaskData(task.id);
        }

        clearTaskSelection() {
            this.selectedTask = null;
            $('#selectedTaskInfo').hide();
            $('#taskSearchInput').focus();
        }

        async loadTaskData(taskId) {
            try {
                // AJAX запрос для загрузки данных задачи
                const taskData = await this.fetchTaskDetails(taskId);

                // Здесь можно обработать загруженные данные задачи
                console.log('Загружены данные задачи:', taskData);

                // Например, передать данные в редактор
                if (this.cls_editor && this.cls_editor.setTaskData) {
                    this.cls_editor.setTaskData(taskData);
                }

            } catch (error) {
                console.error('Ошибка загрузки данных задачи:', error);
                this.showError(null, 'Не удалось загрузить данные задачи');
            }
        }

        async fetchTaskDetails(taskId) {
            // Реальный AJAX запрос для получения деталей задачи
            // Пример моковых данных
            const mockTaskDetails = {
                id: taskId,
                title: this.selectedTask.title,
                description: this.selectedTask.description,
                template: `# Решение задачи "${this.selectedTask.title}"\n\ndef solution(input_data):\n    # Ваш код здесь\n    pass\n\nif __name__ == "__main__":\n    # Тестовые данные\n    test_data = ""\n    result = solution(test_data)\n    print(result)`,
                testCases: [
                    {input: 'test1', expected: 'result1'},
                    {input: 'test2', expected: 'result2'}
                ]
            };

            // Имитация задержки сети
            await new Promise(resolve => setTimeout(resolve, 300));

            return mockTaskDetails;
        }

        onSearchUser() {
            const $usernameInput = $('#inviteUsername');
            const username = $usernameInput.val().trim();

            if (!username) {
                this.showError($usernameInput, 'Введите username для поиска');
                return;
            }

            // Имитация поиска пользователя
            this.simulateUserSearch(username);
        }

        simulateUserSearch(username) {
            const $resultsContainer = $('#userSearchResults');

            // Показываем индикатор загрузки
            $resultsContainer.html(`
                <div class="search-loading">
                    <i class="fas fa-spinner fa-spin"></i> Поиск пользователя "${username}"...
                </div>
            `).show();

            // Имитация задержки поиска
            setTimeout(() => {
                // Случайный результат для демо
                const users = this.getMockUsers(username);

                if (users.length > 0) {
                    const html = users.map(user => `
                        <div class="search-result-item">
                            <div class="user-avatar-small">${user.avatar}</div>
                            <div class="user-info-small">
                                <div class="user-name">${user.name}</div>
                                <div class="user-status-text">${user.status}</div>
                            </div>
                            <button class="invite-btn-small" data-username="${user.username}">
                                <i class="fas fa-user-plus"></i> Пригласить
                            </button>
                        </div>
                    `).join('');

                    $resultsContainer.html(html);
                } else {
                    $resultsContainer.html(`
                        <div class="search-no-results">
                            <i class="fas fa-user-slash"></i> Пользователь "${username}" не найден
                        </div>
                    `);
                }
            }, 1000);
        }

        getMockUsers(searchTerm) {
            // Моковые данные пользователей для демо
            const mockUsers = [
                {username: 'alexey', name: 'Alexey', avatar: 'A', status: 'Online'},
                {username: 'maria', name: 'Maria', avatar: 'M', status: 'Был(а) 5 мин назад'},
                {username: 'ivan', name: 'Ivan', avatar: 'I', status: 'Оффлайн'},
                {username: 'anna', name: 'Anna', avatar: 'A', status: 'Online'},
                {username: 'dmitry', name: 'Dmitry', avatar: 'D', status: 'Занят'}
            ];

            // Фильтруем по поисковому запросу
            return mockUsers.filter(user =>
                user.username.toLowerCase().includes(searchTerm.toLowerCase()) ||
                user.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
        }

        onInviteUser($button) {
            const username = $button.data('username');

            // Устанавливаем username в поле ввода
            $('#inviteUsername').val(username);

            // Показываем сообщение об успехе
            const originalText = $button.html();
            $button.html('<i class="fas fa-check"></i> Приглашен');
            $button.prop('disabled', true);

            // Скрываем результаты поиска
            setTimeout(() => {
                $('#userSearchResults').hide();
                $button.html(originalText);
                $button.prop('disabled', false);
            }, 2000);
        }

        onCreateTab() {
            // Создание нового таба с выбором режима.
            const $selectedOption = $('.tab-option.selected');
            if (!$selectedOption.length || !this.currentTabType) {
                this.showError(null, 'Выберите тип таба');
                return;
            }

            const type = this.currentTabType;
            let data = {};

            try {
                if (type === 'single') {
                    data = this.getSingleTabData();
                } else if (type === 'collaborative') {
                    data = this.getCollaborativeTabData();
                }

                this.SendingDataToServer(type, data);
                this.hide();

            } catch (error) {
                this.showError(null, error.message);
            }
        }

        getSingleTabData() {
            const fileName = $('#singleFileName').val().trim();

            if (!fileName) {
                throw new Error('Введите название файла');
            }

            return {
                name: fileName,
                template: ``
            };
        }

        async SendingDataToServer(type, data){
            let status_create = await this.web_socket.send("create_new_code_tab", {type: type, data_action: data})
            this.cls_editor.addNewTab(status_create)
        }

        getCollaborativeTabData() {
            const sessionName = $('#collabSessionName').val().trim();
            const username = $('#inviteUsername').val().trim();

            if (!sessionName) {
                throw new Error('Введите название сессии');
            }

            const data = {
                name: sessionName,
                invitedUsername: username || null
            };

            // Добавляем данные о выбранной задаче, если есть
            if (this.selectedTask) {
                data.taskId = this.selectedTask.id;
                data.taskTitle = this.selectedTask.title;
                data.taskDescription = this.selectedTask.description;
            }

            return data;
        }

        showError($inputElement, message) {
            // Убираем предыдущие ошибки
            this.clearErrors();

            // Показываем сообщение об ошибке
            const $errorElement = $(`
                <div class="form-error">
                    <i class="fas fa-exclamation-circle"></i> ${message}
                </div>
            `);

            if ($inputElement && $inputElement.length) {
                $inputElement.parent().append($errorElement);
                $inputElement.addClass('error');
                $inputElement.focus();
            } else {
                // Вставляем ошибку перед кнопками действий
                $('.modal-actions').before($errorElement);
            }

            // Удаляем ошибку через 5 секунд
            setTimeout(() => {
                $errorElement.remove();
                if ($inputElement && $inputElement.length) {
                    $inputElement.removeClass('error');
                }
            }, 5000);
        }

        clearErrors() {
            // Удаляем все сообщения об ошибках
            $('.form-error').remove();

            // Убираем класс error со всех полей
            $('.form-input.error').removeClass('error');
        }

        // Метод для получения текущего выбранного типа
        getCurrentTabType() {
            return this.currentTabType;
        }

        // Метод для предзаполнения формы
        prefillForm(type, data) {
            this.resetForm();

            // Выбираем соответствующий тип
            const $option = $(`.tab-option[data-type="${type}"]`);
            if ($option.length) {
                $option.trigger('click');

                // Заполняем данные в зависимости от типа
                if (type === 'single' && data.name) {
                    $('#singleFileName').val(data.name);
                } else if (type === 'collaborative') {
                    if (data.name) $('#collabSessionName').val(data.name);
                    if (data.username) $('#inviteUsername').val(data.username);
                    if (data.task) {
                        this.selectTask(data.task);
                    }
                }
            }
        }
    }
</script>

<style>
/* Стили для поиска задач */
.task-search-container {
    position: relative;
}

.task-search-input-wrapper {
    position: relative;
}

.task-search-input-wrapper .search-btn {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    cursor: pointer;
    color: #666;
}

.task-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-top: 4px;
}

.task-result-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: background-color 0.2s;
}

.task-result-item:hover {
    background-color: #f5f5f5;
}

.task-result-item:last-child {
    border-bottom: none;
}

.task-result-title {
    font-weight: bold;
    margin-bottom: 4px;
    color: #333;
}

.task-result-difficulty {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 12px;
    margin-bottom: 6px;
}

.task-result-difficulty.easy {
    background-color: #d4edda;
    color: #155724;
}

.task-result-difficulty.medium {
    background-color: #fff3cd;
    color: #856404;
}

.task-result-difficulty.hard {
    background-color: #f8d7da;
    color: #721c24;
}

.task-result-description {
    font-size: 13px;
    color: #666;
    line-height: 1.4;
}

.selected-task-info {
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 4px;
    padding: 12px;
    margin-top: 10px;
}

.selected-task-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.selected-task-description {
    color: #495057;
    line-height: 1.5;
}

.clear-selection-btn {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 2px;
    margin-left: auto;
}

.clear-selection-btn:hover {
    color: #dc3545;
}

.search-loading, .search-no-results, .search-error {
    padding: 20px;
    text-align: center;
    color: #6c757d;
}

.search-loading i {
    margin-right: 8px;
}
</style>