<!-- Модальное окно ожидания участников -->
<div class="modal-overlay" id="waitingModal">
    <div class="modal" style="width: 450px;">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-user-clock"></i> Ожидание участников
            </h2>
            <button class="close-modal" id="closeWaitingModal">&times;</button>
        </div>
        <div class="modal-content">
            <div class="waiting-content">
                <div class="waiting-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="waiting-message" id="waitingMessage">
                    Ожидание подключения второго участника...
                </div>

                <div class="invite-methods">
                    <div class="invite-method-tabs">
                        <button class="invite-tab active" data-method="username">
                            <i class="fas fa-user"></i> По username
                        </button>
                        <button class="invite-tab" data-method="link">
                            <i class="fas fa-link"></i> Ссылка
                        </button>
                    </div>

                    <div class="invite-method-content" id="usernameInviteMethod" style="display: block;">
                        <div class="form-group">
                            <label class="form-label">Пригласить по username:</label>
                            <div class="username-invite-container">
                                <input type="text" class="form-input" id="usernameInviteInput"
                                       placeholder="Введите username">
                                <button class="invite-send-btn" id="sendUsernameInvite">
                                    <i class="fas fa-paper-plane"></i> Отправить
                                </button>
                            </div>
                            <div class="invite-status" id="usernameInviteStatus"></div>
                        </div>
                        <div class="recent-users">
                            <div class="recent-users-title">Недавние пользователи:</div>
                            <div class="recent-users-list">
                                <div class="recent-user" data-username="alexey">
                                    <div class="recent-user-avatar">A</div>
                                    <div class="recent-user-name">Alexey</div>
                                    <button class="invite-recent-btn">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                                <div class="recent-user" data-username="maria">
                                    <div class="recent-user-avatar">M</div>
                                    <div class="recent-user-name">Maria</div>
                                    <button class="invite-recent-btn">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="invite-method-content" id="linkInviteMethod" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">Ссылка для приглашения:</label>
                            <div class="invite-link-container">
                                <input type="text" class="form-input" id="inviteLink" readonly>
                                <button class="copy-btn" id="copyInviteLink">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="participants-status">
                    <div class="participant" id="participant1">
                        <div class="participant-avatar" id="currentUserAvatar">Вы</div>
                        <div class="participant-name" id="currentUserName">Вы (Создатель)</div>
                        <div class="participant-ready-status">
                            <label class="ready-checkbox">
                                <input type="checkbox" id="creatorReadyCheckbox" checked>
                                <span class="ready-label">Готов</span>
                            </label>
                        </div>
                    </div>
                    <div class="participant" id="participant2">
                        <div class="participant-avatar">?</div>
                        <div class="participant-name">Ожидание...</div>
                        <div class="participant-ready-status">
                            <span class="ready-badge not-ready">Не готов</span>
                        </div>
                    </div>
                </div>

                <div class="collaboration-controls">
                    <button class="btn secondary" id="startWithoutPartnerBtn">
                        <i class="fas fa-play"></i> Начать в одиночку
                    </button>
                    <button class="btn primary" id="cancelSessionBtn">
                        <i class="fas fa-times"></i> Отменить сессию
                    </button>
                </div>

                <div class="timer-info" id="timerInfo" style="display: none;">
                    <i class="fas fa-clock"></i> Отсчет начнется когда оба участника будут готовы
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Модальное окно ожидания участников
    class WaitingModal {
        constructor() {
            this.modal = document.getElementById('waitingModal');
            this.session = null;
            this.countdownInterval = null;
            this.onSessionStartCallback = null;
            this.onSessionCancelCallback = null;
            this.init();
        }

        init() {
            this.bindEvents();
            this.loadRecentUsers();
        }

        bindEvents() {
            // Закрытие модального окна
            document.getElementById('closeWaitingModal').addEventListener('click', () => this.hide());

            // Клик вне модального окна
            this.modal.addEventListener('click', (e) => {
                if (e.target === this.modal) {
                    this.cancelSession();
                }
            });

            // Переключение методов приглашения
            document.querySelectorAll('.invite-tab').forEach(tab => {
                tab.addEventListener('click', (e) => this.switchInviteMethod(e));
            });

            // Отправка приглашения по username
            document.getElementById('sendUsernameInvite').addEventListener('click', () => {
                this.sendUsernameInvite();
            });

            // Приглашение из списка недавних пользователей
            document.querySelectorAll('.invite-recent-btn').forEach(btn => {
                btn.addEventListener('click', (e) => this.inviteRecentUser(e));
            });

            // Копирование ссылки
            document.getElementById('copyInviteLink').addEventListener('click', () => {
                this.copyInviteLink();
            });

            // Готовность создателя
            document.getElementById('creatorReadyCheckbox').addEventListener('change', () => {
                this.updateReadyStatus();
            });

            // Кнопка "Начать в одиночку"
            document.getElementById('startWithoutPartnerBtn').addEventListener('click', () => {
                this.startWithoutPartner();
            });

            // Кнопка "Отменить сессию"
            document.getElementById('cancelSessionBtn').addEventListener('click', () => {
                this.cancelSession();
            });

            // Автозаполнение username при клике на недавнего пользователя
            document.querySelectorAll('.recent-user').forEach(user => {
                user.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('invite-recent-btn')) {
                        this.fillUsernameFromRecent(user);
                    }
                });
            });
        }

        loadRecentUsers() {
            // Загрузка недавних пользователей из localStorage
            try {
                const recentUsers = localStorage.getItem('recentCollaborationUsers');
                if (recentUsers) {
                    const users = JSON.parse(recentUsers);
                    this.updateRecentUsersList(users);
                }
            } catch (e) {
                console.error('Ошибка загрузки недавних пользователей:', e);
            }
        }

        updateRecentUsersList(users) {
            const recentUsersList = document.querySelector('.recent-users-list');
            if (!recentUsersList) return;

            recentUsersList.innerHTML = users.map(user => `
            <div class="recent-user" data-username="${user.username}">
                <div class="recent-user-avatar">${user.avatar}</div>
                <div class="recent-user-name">${user.name}</div>
                <button class="invite-recent-btn" title="Пригласить">
                    <i class="fas fa-user-plus"></i>
                </button>
            </div>
        `).join('');

            // Перепривязываем события
            document.querySelectorAll('.invite-recent-btn').forEach(btn => {
                btn.addEventListener('click', (e) => this.inviteRecentUser(e));
            });

            document.querySelectorAll('.recent-user').forEach(user => {
                user.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('invite-recent-btn')) {
                        this.fillUsernameFromRecent(user);
                    }
                });
            });
        }

        addToRecentUsers(userData) {
            try {
                let recentUsers = [];
                const saved = localStorage.getItem('recentCollaborationUsers');

                if (saved) {
                    recentUsers = JSON.parse(saved);
                }

                // Удаляем если уже есть
                recentUsers = recentUsers.filter(u => u.username !== userData.username);

                // Добавляем в начало
                recentUsers.unshift(userData);

                // Ограничиваем количество
                if (recentUsers.length > 5) {
                    recentUsers = recentUsers.slice(0, 5);
                }

                localStorage.setItem('recentCollaborationUsers', JSON.stringify(recentUsers));
                this.updateRecentUsersList(recentUsers);
            } catch (e) {
                console.error('Ошибка сохранения недавних пользователей:', e);
            }
        }

        show(sessionData) {
            this.session = sessionData;
            this.modal.classList.add('show');
            this.resetUI();

            // Обновляем информацию о сессии
            this.updateSessionInfo();

            // Показываем метод приглашения по username по умолчанию
            this.switchInviteMethod('username');

            // Фокус на поле ввода username
            setTimeout(() => {
                document.getElementById('usernameInviteInput').focus();
            }, 300);
        }

        hide() {
            this.modal.classList.remove('show');
            this.stopCountdown();
        }

        resetUI() {
            // Сбрасываем статус второго участника
            document.getElementById('participant2').innerHTML = `
            <div class="participant-avatar">?</div>
            <div class="participant-name">Ожидание...</div>
            <div class="participant-ready-status">
                <span class="ready-badge not-ready">Не готов</span>
            </div>
        `;

            // Сбрасываем чекбокс готовности создателя
            document.getElementById('creatorReadyCheckbox').checked = true;

            // Скрываем таймер
            document.getElementById('timerInfo').style.display = 'none';

            // Сбрасываем статус приглашения
            this.clearInviteStatus();

            // Сбрасываем поле ввода
            document.getElementById('usernameInviteInput').value = '';
        }

        updateSessionInfo() {
            if (!this.session) return;

            const waitingMessage = document.getElementById('waitingMessage');
            const currentUserAvatar = document.getElementById('currentUserAvatar');
            const currentUserName = document.getElementById('currentUserName');

            // Обновляем сообщение
            if (this.session.type === 'duel') {
                waitingMessage.textContent = `Ожидание подключения второго участника для дуэли "${this.session.name}"...`;
            } else {
                waitingMessage.textContent = `Пригласите друга для совместной работы над "${this.session.name}"`;
            }

            // Обновляем информацию о текущем пользователе
            if (this.session.creator) {
                currentUserAvatar.textContent = this.session.creator.avatar || 'Вы';
                currentUserName.textContent = this.session.creator.username
                    ? `${this.session.creator.username} (Создатель)`
                    : 'Вы (Создатель)';
            }

            // Если уже есть приглашенный пользователь
            if (this.session.invitedUsername) {
                document.getElementById('usernameInviteInput').value = this.session.invitedUsername;
                this.sendUsernameInvite();
            }
        }

        switchInviteMethod(method) {
            // Если передано событие
            if (method instanceof Event) {
                method = method.currentTarget.dataset.method;
            }

            // Переключаем табы
            document.querySelectorAll('.invite-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.invite-tab[data-method="${method}"]`).classList.add('active');

            // Показываем соответствующий контент
            document.querySelectorAll('.invite-method-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`${method}InviteMethod`).style.display = 'block';

            // Генерируем ссылку если нужно
            if (method === 'link' && this.session) {
                this.generateInviteLink();
            }
        }

        generateInviteLink() {
            if (!this.session) return;

            const baseUrl = window.location.origin + window.location.pathname;
            const sessionId = this.session.id || 'demo_' + Date.now();
            const inviteLink = `${baseUrl}?invite=${sessionId}&type=${this.session.type}&name=${encodeURIComponent(this.session.name)}`;

            document.getElementById('inviteLink').value = inviteLink;
        }

        copyInviteLink() {
            const inviteLink = document.getElementById('inviteLink');

            if (!inviteLink.value) {
                this.generateInviteLink();
            }

            inviteLink.select();
            inviteLink.setSelectionRange(0, 99999); // Для мобильных устройств

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    this.showCopySuccess();
                } else {
                    this.showError('Не удалось скопировать ссылку');
                }
            } catch (err) {
                console.error('Ошибка копирования:', err);
                this.showError('Не удалось скопировать ссылку');
            }
        }

        showCopySuccess() {
            const copyBtn = document.getElementById('copyInviteLink');
            const originalHTML = copyBtn.innerHTML;

            copyBtn.innerHTML = '<i class="fas fa-check"></i>';
            copyBtn.classList.add('success');

            setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
                copyBtn.classList.remove('success');
            }, 2000);
        }

        sendUsernameInvite() {
            const usernameInput = document.getElementById('usernameInviteInput');
            const username = usernameInput.value.trim();
            const statusElement = document.getElementById('usernameInviteStatus');

            if (!username) {
                this.showError(usernameInput, 'Введите username для приглашения');
                return;
            }

            // Проверяем, не приглашаем ли мы себя
            if (this.session.creator && this.session.creator.username === username) {
                this.showError(usernameInput, 'Нельзя пригласить самого себя');
                return;
            }

            // Показываем статус отправки
            statusElement.innerHTML = `
            <span class="status-sending">
                <i class="fas fa-spinner fa-spin"></i> Отправка приглашения пользователю ${username}...
            </span>
        `;

            // Имитация отправки приглашения
            this.simulateInviteSending(username, statusElement);
        }

        simulateInviteSending(username, statusElement) {
            // Имитация задержки сети
            setTimeout(() => {
                // В 80% случаев успешно, в 20% - ошибка
                const isSuccess = Math.random() > 0.2;

                if (isSuccess) {
                    statusElement.innerHTML = `
                    <span class="status-success">
                        <i class="fas fa-check"></i> Приглашение отправлено пользователю ${username}
                    </span>
                `;

                    // Добавляем в недавние пользователи
                    this.addToRecentUsers({
                        username: username,
                        name: username.charAt(0).toUpperCase() + username.slice(1),
                        avatar: username.charAt(0).toUpperCase()
                    });

                    // Имитация ответа через 2-5 секунд
                    const responseTime = 2000 + Math.random() * 3000;
                    setTimeout(() => {
                        this.simulatePartnerResponse(username);
                    }, responseTime);

                } else {
                    statusElement.innerHTML = `
                    <span class="status-error">
                        <i class="fas fa-times"></i> Не удалось отправить приглашение
                    </span>
                `;
                }

                // Очищаем статус через 5 секунд
                setTimeout(() => {
                    statusElement.innerHTML = '';
                }, 5000);
            }, 1500);
        }

        simulatePartnerResponse(username) {
            if (!this.session) return;

            // Имитируем подключение партнера
            const partner = {
                username: username,
                avatar: username.charAt(0).toUpperCase(),
                ready: false
            };

            this.session.partner = partner;

            // Обновляем UI
            document.getElementById('participant2').innerHTML = `
            <div class="participant-avatar">${partner.avatar}</div>
            <div class="participant-name">${partner.username}</div>
            <div class="participant-ready-status">
                <label class="ready-checkbox">
                    <input type="checkbox" id="partnerReadyCheckbox">
                    <span class="ready-label">Готов</span>
                </label>
            </div>
        `;

            document.getElementById('waitingMessage').textContent =
                `${partner.username} принял приглашение. Ожидание подтверждения готовности...`;

            // Добавляем обработчик для галочки готовности партнера
            const readyCheckbox = document.getElementById('partnerReadyCheckbox');
            if (readyCheckbox) {
                readyCheckbox.addEventListener('change', () => {
                    this.session.partner.ready = readyCheckbox.checked;
                    this.updateReadyStatus();
                });
            }
        }

        inviteRecentUser(event) {
            event.stopPropagation();
            const recentUser = event.currentTarget.closest('.recent-user');
            const username = recentUser.dataset.username;

            document.getElementById('usernameInviteInput').value = username;
            this.sendUsernameInvite();
        }

        fillUsernameFromRecent(userElement) {
            const username = userElement.dataset.username;
            document.getElementById('usernameInviteInput').value = username;
            document.getElementById('usernameInviteInput').focus();
        }

        updateReadyStatus() {
            if (!this.session) return;

            const creatorReady = document.getElementById('creatorReadyCheckbox').checked;
            const partnerReady = this.session.partner ? this.session.partner.ready : false;

            // Обновляем статус создателя
            if (this.session.creator) {
                this.session.creator.ready = creatorReady;
            }

            this.session.ready = creatorReady && partnerReady;

            if (this.session.ready) {
                document.getElementById('waitingMessage').textContent = 'Оба участника готовы! Начинаем совместную работу...';
                document.getElementById('timerInfo').style.display = 'block';

                // Запускаем отсчет
                this.startCountdown();
            } else {
                document.getElementById('timerInfo').style.display = 'none';
                this.stopCountdown();
            }
        }

        startCountdown() {
            this.stopCountdown(); // Останавливаем предыдущий отсчет

            let countdown = 3;
            const timerInfo = document.getElementById('timerInfo');

            timerInfo.innerHTML = `<i class="fas fa-clock"></i> Начало через: ${countdown}...`;

            this.countdownInterval = setInterval(() => {
                countdown--;

                if (countdown > 0) {
                    timerInfo.innerHTML = `<i class="fas fa-clock"></i> Начало через: ${countdown}...`;
                } else {
                    this.stopCountdown();
                    this.startSession();
                }
            }, 1000);
        }

        stopCountdown() {
            if (this.countdownInterval) {
                clearInterval(this.countdownInterval);
                this.countdownInterval = null;
            }
        }

        startSession() {
            if (!this.session) return;

            // Вызываем callback для начала сессии
            if (this.onSessionStartCallback) {
                this.onSessionStartCallback(this.session);
            }

            this.hide();
        }

        startWithoutPartner() {
            if (!this.session) return;

            // Создаем бота как партнера
            this.session.partner = {
                username: 'Bot',
                avatar: 'B',
                ready: true
            };

            // Автоматически отмечаем готовыми
            document.getElementById('creatorReadyCheckbox').checked = true;

            // Обновляем UI
            document.getElementById('participant2').innerHTML = `
            <div class="participant-avatar">B</div>
            <div class="participant-name">Bot</div>
            <div class="participant-ready-status">
                <span class="ready-badge ready">Готов</span>
            </div>
        `;

            // Запускаем сессию
            setTimeout(() => {
                this.startSession();
            }, 1000);
        }

        cancelSession() {
            // Вызываем callback для отмены сессии
            if (this.onSessionCancelCallback) {
                this.onSessionCancelCallback(this.session);
            }

            this.hide();
        }

        setPartnerReady(isReady) {
            if (!this.session || !this.session.partner) return;

            this.session.partner.ready = isReady;

            // Обновляем чекбокс если он есть
            const partnerCheckbox = document.getElementById('partnerReadyCheckbox');
            if (partnerCheckbox) {
                partnerCheckbox.checked = isReady;
            }

            this.updateReadyStatus();
        }

        updatePartnerInfo(partnerData) {
            if (!this.session) return;

            this.session.partner = partnerData;

            // Обновляем UI
            document.getElementById('participant2').innerHTML = `
            <div class="participant-avatar">${partnerData.avatar}</div>
            <div class="participant-name">${partnerData.username}</div>
            <div class="participant-ready-status">
                <label class="ready-checkbox">
                    <input type="checkbox" id="partnerReadyCheckbox" ${partnerData.ready ? 'checked' : ''}>
                    <span class="ready-label">Готов</span>
                </label>
            </div>
        `;

            // Перепривязываем обработчик
            const readyCheckbox = document.getElementById('partnerReadyCheckbox');
            if (readyCheckbox) {
                readyCheckbox.addEventListener('change', () => {
                    this.session.partner.ready = readyCheckbox.checked;
                    this.updateReadyStatus();
                });
            }
        }

        showError(inputElement, message) {
            // Убираем предыдущие ошибки
            this.clearErrors();

            // Показываем сообщение об ошибке
            const errorElement = document.createElement('div');
            errorElement.className = 'form-error';
            errorElement.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;

            if (inputElement) {
                inputElement.parentNode.appendChild(errorElement);
                inputElement.classList.add('error');
                inputElement.focus();
            } else {
                // Вставляем ошибку перед участниками
                const participantsStatus = document.querySelector('.participants-status');
                participantsStatus.parentNode.insertBefore(errorElement, participantsStatus);
            }

            // Удаляем ошибку через 5 секунд
            setTimeout(() => {
                errorElement.remove();
                if (inputElement) {
                    inputElement.classList.remove('error');
                }
            }, 5000);
        }

        clearInviteStatus() {
            document.getElementById('usernameInviteStatus').innerHTML = '';
        }

        clearErrors() {
            // Удаляем все сообщения об ошибках
            document.querySelectorAll('.form-error').forEach(error => error.remove());

            // Убираем класс error со всех полей
            document.querySelectorAll('.form-input.error').forEach(input => {
                input.classList.remove('error');
            });
        }

        // Методы для установки callback
        setOnSessionStartCallback(callback) {
            this.onSessionStartCallback = callback;
        }

        setOnSessionCancelCallback(callback) {
            this.onSessionCancelCallback = callback;
        }

        // Получить текущую сессию
        getSession() {
            return this.session;
        }

        // Установить сессию извне
        setSession(sessionData) {
            this.session = sessionData;
            this.updateSessionInfo();
        }

        // Метод для обновления сообщения
        updateMessage(message) {
            document.getElementById('waitingMessage').textContent = message;
        }
    }

    // Инициализация модального окна при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        window.waitingModal = new WaitingModal();
    });

    // Глобальные функции для управления модальным окном
    window.showWaitingModal = function (sessionData) {
        if (window.waitingModal) {
            window.waitingModal.show(sessionData);
        }
    };

    window.hideWaitingModal = function () {
        if (window.waitingModal) {
            window.waitingModal.hide();
        }
    };

    window.updatePartnerReadyStatus = function (isReady) {
        if (window.waitingModal) {
            window.waitingModal.setPartnerReady(isReady);
        }
    };

    // Пример использования:
    /*
    // Показать модальное окно с данными сессии
    showWaitingModal({
        id: 'session_123',
        type: 'collaborative',
        name: 'Совместная работа',
        creator: {
            username: 'myusername',
            avatar: 'M',
            ready: true
        }
    });

    // Установить обработчики
    window.waitingModal.setOnSessionStartCallback((session) => {
        console.log('Начинаем сессию:', session);
        // Здесь начинаем совместное программирование
    });

    window.waitingModal.setOnSessionCancelCallback((session) => {
        console.log('Отменяем сессию:', session);
        // Здесь отменяем сессию
    });

    // Обновить информацию о партнере
    window.waitingModal.updatePartnerInfo({
        username: 'partner123',
        avatar: 'P',
        ready: false
    });
    */
</script>