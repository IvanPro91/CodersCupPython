<!DOCTYPE html>
{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeEditor - Python редактор</title>

    <!-- 1. jQuery -->
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>

    <!-- 2. Monaco Editor (с RequireJS) -->
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <!-- 3. Стили -->
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
{% include 'menu/menu.html' %}
<div class="main-container">
    <div class="main-content">
        <div class="tabs-header">
            <div class="tabs-container" id="tabsContainer"></div>
            <button class="add-tab-btn" id="addTabBtn" title="Создать новый таб">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div class="editor-container" id="editorContainer">
            {% include 'content/empty_container_file.html' %}
        </div>
    </div>
</div>

<!-- Модальные окна -->
{% include 'modal/modal_new_tab.html' %}

<!-- Scripts -->
<script>
    // Решение конфликта AMD: загружаем Socket.IO до других скриптов
    (function() {
        // Временно отключаем define для загрузки Socket.IO
        var originalDefine = window.define;
        window.define = undefined;

        var script = document.createElement('script');
        script.src = '{% static "js/socket.io.min.js" %}';
        script.onload = function() {
            // Восстанавливаем define
            window.define = originalDefine;
            console.log('Socket.IO загружен');

            // Теперь загружаем остальные скрипты
            var scripts = [
                '{% static "web_socket_code.js" %}',
                '{% static "code_editor.js" %}'
            ];

            scripts.forEach(function(src) {
                var s = document.createElement('script');
                s.src = src;
                document.body.appendChild(s);
            });
        };
        document.head.appendChild(script);
    })();
</script>

<script>
    // Перенесите этот код в отдельный файл или оставьте здесь
    const currentRoomId = '{{ user.token }}';
    let newTabModal = null;
    let codeEditor = null;

    // Ждем загрузки всех скриптов
    window.addEventListener('load', async function() {
        // Проверяем, загружен ли Socket.IO
        if (typeof io === 'undefined' && typeof window.io === 'undefined') {
            console.error('Socket.IO не загружен!');
            return;
        }

        try {
            const socket = new SocketIOCode(currentRoomId);
            await socket.connect();

            codeEditor = new CodeEditor(socket);
            newTabModal = new NewTabModal(socket, codeEditor);

            await codeEditor.renderTabs();

            $("#addTabBtn").click(function () {
                newTabModal.show();
            });

            console.log('✅ Приложение инициализировано');
        } catch (error) {
            console.error('❌ Ошибка инициализации:', error);
        }
    });
</script>
</body>
</html>