<!DOCTYPE html>
{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeEditor - Python —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/codemirror.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/monokai.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/dracula.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
{% include 'menu/menu.html' %}
<div class="main-container">
    <div class="main-content">
        <div class="tabs-header">
            <div class="tabs-container" id="tabsContainer"></div>
            <button class="add-tab-btn" id="addTabBtn" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–∞–±">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div class="editor-container" id="editorContainer">
            {% include 'content/empty_container_file.html' %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∞–±–∞ -->
{% include 'modal/modal_new_tab.html' %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
{% include 'modal/modal_waiting_user.html' %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
{% include 'modal/modal_welcome_user.html' %}

<script src="{% static 'js/codemirror.min.js' %}"></script>
<script src="{% static 'js/python.min.js' %}"></script>
<script src="{% static 'js/matchbrackets.min.js' %}"></script>
<script src="{% static 'js/active-line.min.js' %}"></script>
<script src="{% static 'js/socket.io.min.js' %}"></script>
<script src="{% static 'web_socket_code.js' %}"></script>
<script src="{% static 'code_editor.js' %}"></script>

<script>

    //
    // const wsUrl = `ws://${window.location.host}/ws/code_cup/${currentRoomId}/`;
    // let isConnected = false;
    // console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫:', wsUrl);
    //
    // socket = new WebSocket(wsUrl);
    // console.log(socket)
    //
    // socket.onopen = function () {
    //     console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!');
    //     isConnected = true;
    //     if (currentRoomId) {
    //         console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —á–∞—Ç—É'); // –ò–∑–±–µ–≥–∞–µ–º —Å–ø–∞–º–∞ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
    //     }
    // };
    //
    // socket.onmessage = function (event) {
    //     try {
    //         const data = JSON.parse(event.data);
    //         console.log('–ü–æ–ª—É—á–µ–Ω–æ:', data);
    //     } catch (e) {
    //         console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
    //     }
    // };
    //
    // socket.onclose = function (event) {
    //     console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
    //     isConnected = false;
    //     —Ç—É—Ç —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –±—ã–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –Ω–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
    //
    //
    //     –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    //     setTimeout(function () {
    //         if (!isConnected) {
    //             socket = new WebSocket(wsUrl);
    //         }
    //     }, 3000);
    // };

</script>


<script>
    const currentRoomId = '{{ user.token }}'
    let newTabModal = null
    let codeEditor = null

    async function initApp() {
        const socket = new SocketIOCode(currentRoomId);
        await socket.connect()

        codeEditor = new CodeEditor(socket);
        newTabModal = new NewTabModal(socket, codeEditor);

        await codeEditor.renderTabs()
    }

    $("#addTabBtn").click(function () {
        newTabModal.show();
    })

    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>