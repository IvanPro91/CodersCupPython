<!DOCTYPE html>
{% load static %}
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeEditor - Python —Ä–µ–¥–∞–∫—Ç–æ—Ä</title>
    <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css/codemirror.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/monokai.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
{% include 'menu/menu.html' %}
<div class="main-container">
    <div class="main-content">
        <div class="tabs-header">
            <div class="tabs-container" id="tabsContainer"></div>
            <button class="add-tab-btn" id="addTabBtn" title="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–∞–±">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <div class="editor-container" id="editorContainer">
            {% include 'content/empty_container_file.html' %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∞–±–∞ -->
{% include 'modal/modal_new_tab.html' %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
{% include 'modal/modal_waiting_user.html' %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è -->
{% include 'modal/modal_welcome_user.html' %}

<script src="{% static 'js/codemirror.min.js' %}"></script>
<script src="{% static 'js/python.min.js' %}"></script>
<script src="{% static 'js/matchbrackets.min.js' %}"></script>
<script src="{% static 'js/active-line.min.js' %}"></script>
<script src="{% static 'js/socket.io.min.js' %}"></script>

<script>
    let currentRoomId = '{{ user.token }}'
    const wsUrl = `ws://${window.location.host}/ws/code_cup/${currentRoomId}/`;
    let isConnected = false;
    console.log('üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫:', wsUrl);

    socket = new WebSocket(wsUrl);
    console.log(socket)

    socket.onopen = function () {
        console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω!');
        isConnected = true;
        if (currentRoomId) {
            console.log('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —á–∞—Ç—É'); // –ò–∑–±–µ–≥–∞–µ–º —Å–ø–∞–º–∞ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        }
    };

    socket.onmessage = function (event) {
        try {
            const data = JSON.parse(event.data);
            console.log('–ü–æ–ª—É—á–µ–Ω–æ:', data);
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
        }
    };

    socket.onclose = function (event) {
        console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
        isConnected = false;
        // —Ç—É—Ç —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –±—ã–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –Ω–∞—á–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω


        // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        // setTimeout(function () {
        //     if (!isConnected) {
        //         socket = new WebSocket(wsUrl);
        //     }
        // }, 3000);
    };

</script>


<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Tabs
    const newTabModal = new NewTabModal(socket);
    console.log(newTabModal)


    $("#addTabBtn").click(function () {
        newTabModal.show();
    })


    /*
    // –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∞—Å—Å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å –ø–æ–ª–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Socket.IO
class CodeEditor {
    constructor() {
        this.tabs = [];
        this.activeTabId = null;
        this.codeEditors = {};
        this.collaborationSession = null;
        this.currentUser = {
            username: 'user_' + Math.random().toString(36).substr(2, 5),
            avatar: 'U',
            ready: false,
            socketId: null,
            userId: null
        };

        this.tasks = {
            palindrome: {
                title: "–ü–∞–ª–∏–Ω–¥—Ä–æ–º",
                description: "–ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é is_palindrome(s: str) -> bool, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø–∞–ª–∏–Ω–¥—Ä–æ–º–æ–º. –£—á–∏—Ç—ã–≤–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã, –∏–≥–Ω–æ—Ä–∏—Ä—É–π—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã.",
                template: `def is_palindrome(s: str) -> bool:
    # –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å
    pass

# –¢–µ—Å—Ç—ã
def test():
    tests = [
        ("A man, a plan, a canal: Panama", True),
        ("race a car", False),
        ("", True),
        ("12321", True)
    ]
    for inp, exp in tests:
        result = is_palindrome(inp)
        print(f"{'‚úì' if result == exp else '‚úó'} is_palindrome('{inp}') -> {result}")

if __name__ == "__main__":
    test()`
            },
            primes: {
                title: "–ü—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–∞",
                description: "–ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é find_primes(n: int) -> list[int], –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –ø—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–∞ –æ—Ç 2 –¥–æ n –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ.",
                template: `def find_primes(n: int) -> list[int]:
    # –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å
    pass

# –¢–µ—Å—Ç—ã
def test():
    tests = [
        (10, [2, 3, 5, 7]),
        (20, [2, 3, 5, 7, 11, 13, 17, 19]),
        (1, []),
        (2, [2])
    ]
    for inp, exp in tests:
        result = find_primes(inp)
        print(f"{'‚úì' if result == exp else '‚úó'} find_primes({inp}) -> {result}")

if __name__ == "__main__":
    test()`
            },
            anagrams: {
                title: "–ê–Ω–∞–≥—Ä–∞–º–º—ã",
                description: "–ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é are_anagrams(s1: str, s2: str) -> bool, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è—é—Ç—Å—è –ª–∏ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏ –∞–Ω–∞–≥—Ä–∞–º–º–∞–º–∏.",
                template: `def are_anagrams(s1: str, s2: str) -> bool:
    # –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å
    pass

# –¢–µ—Å—Ç—ã
def test():
    tests = [
        ("listen", "silent", True),
        ("hello", "world", False),
        ("", "", True),
        ("abc", "cba", True)
    ]
    for s1, s2, exp in tests:
        result = are_anagrams(s1, s2)
        print(f"{'‚úì' if result == exp else '‚úó'} are_anagrams('{s1}', '{s2}') -> {result}")

if __name__ == "__main__":
    test()`
            },
            fibonacci: {
                title: "–ß–∏—Å–ª–∞ –§–∏–±–æ–Ω–∞—á—á–∏",
                description: "–ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é fibonacci(n: int) -> int, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç n-–Ω–æ–µ —á–∏—Å–ª–æ –§–∏–±–æ–Ω–∞—á—á–∏.",
                template: `def fibonacci(n: int) -> int:
    # –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å
    pass

# –¢–µ—Å—Ç—ã
def test():
    tests = [
        (0, 0),
        (1, 1),
        (2, 1),
        (5, 5),
        (10, 55)
    ]
    for inp, exp in tests:
        result = fibonacci(inp)
        print(f"{'‚úì' if result == exp else '‚úó'} fibonacci({inp}) -> {result}")

if __name__ == "__main__":
    test()`
            },
            unique: {
                title: "–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã",
                description: "–ù–∞–ø–∏—à–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é unique_chars(s: str) -> str, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É, —Å–æ–¥–µ—Ä–∂–∞—â—É—é —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –∏—Ö –ø–µ—Ä–≤–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è.",
                template: `def unique_chars(s: str) -> str:
    # –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å
    pass

# –¢–µ—Å—Ç—ã
def test():
    tests = [
        ("hello", "helo"),
        ("programming", "progamin"),
        ("", ""),
        ("aaaa", "a")
    ]
    for inp, exp in tests:
        result = unique_chars(inp)
        print(f"{'‚úì' if result == exp else '‚úó'} unique_chars('{inp}') -> '{result}'")

if __name__ == "__main__":
    test()`
            }
        };

        this.randomTasks = Object.values(this.tasks);

        // Socket.IO —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
        this.socket = null;
        this.isConnected = false;
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 5;
        this.reconnectDelay = 1000;

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        this.sessions = {};
        this.pendingInvitations = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        this.newTabModal = new NewTabModal();
        this.waitingModal = new WaitingModal();
        this.invitationModal = new InvitationModal();

        this.init();
    }

    init() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        this.loadUserData();

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ç–∞–±—ã
        this.loadDataFromStorage();

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Socket.IO
        this.connectSocketIO();

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        this.setupModals();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        this.initEventListeners();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±—ã
        this.renderTabs();

        // –ï—Å–ª–∏ –Ω–µ—Ç —Ç–∞–±–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if (this.tabs.length === 0) {
            this.showNoTabMessage();
        } else {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞–±
            this.activeTabId = this.tabs[0].id;
            this.renderActiveTab();
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        this.checkUrlForInvitation();
    }

    connectSocketIO() {
        console.log('[Socket.IO] –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...');

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL —Å–µ—Ä–≤–µ—Ä–∞
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const hostname = window.location.hostname;
        const port = window.location.port || (window.location.protocol === 'https:' ? '443' : '80');
        const socketUrl = `${protocol}//${hostname}:${port}`;

        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Socket.IO —Å–µ—Ä–≤–µ—Ä—É
        this.socket = io(socketUrl, {
            path: '/socket.io/',
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: this.maxReconnectAttempts,
            reconnectionDelay: this.reconnectDelay,
            reconnectionDelayMax: 5000,
            timeout: 20000,
            forceNew: true,
            query: {
                'username': this.currentUser.username,
                'avatar': this.currentUser.avatar
            }
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Socket.IO
        this.setupSocketHandlers();
    }

    setupSocketHandlers() {
        // –ë–∞–∑–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        this.socket.on('connect', () => this.handleConnect());
        this.socket.on('disconnect', (reason) => this.handleDisconnect(reason));
        this.socket.on('connect_error', (error) => this.handleConnectError(error));
        this.socket.on('reconnect', (attempt) => this.handleReconnect(attempt));
        this.socket.on('reconnecting', (attempt) => this.handleReconnecting(attempt));
        this.socket.on('reconnect_error', (error) => this.handleReconnectError(error));
        this.socket.on('reconnect_failed', () => this.handleReconnectFailed());

        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        this.socket.on('connected', (data) => this.handleConnected(data));
        this.socket.on('user_registered', (data) => this.handleUserRegistered(data));
        this.socket.on('session_created', (data) => this.handleSessionCreated(data));
        this.socket.on('invitation_received', (data) => this.handleInvitationReceived(data));
        this.socket.on('invitation_accepted', (data) => this.handleInvitationAccepted(data));
        this.socket.on('invitation_sent', (data) => this.handleInvitationSent(data));
        this.socket.on('invitation_declined', (data) => this.handleInvitationDeclined(data));
        this.socket.on('user_ready_status', (data) => this.handleUserReadyStatus(data));
        this.socket.on('code_update', (data) => this.handleCodeUpdate(data));
        this.socket.on('chat_message', (data) => this.handleChatMessage(data));
        this.socket.on('user_joined', (data) => this.handleUserJoined(data));
        this.socket.on('user_left', (data) => this.handleUserLeft(data));
        this.socket.on('user_disconnected', (data) => this.handleUserDisconnected(data));
        this.socket.on('session_started', (data) => this.handleSessionStarted(data));
        this.socket.on('session_state', (data) => this.handleSessionState(data));
        this.socket.on('session_info', (data) => this.handleSessionInfo(data));
        this.socket.on('session_cancelled', (data) => this.handleSessionCancelled(data));
        this.socket.on('error', (data) => this.handleError(data));

        // –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è
        this.socket.on('pong', (data) => this.handlePong(data));
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π Socket.IO
    handleConnect() {
        console.log('[Socket.IO] –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, ID:', this.socket.id);
        this.isConnected = true;
        this.reconnectAttempts = 0;
        this.currentUser.socketId = this.socket.id;

        this.showConnectionStatus(true);
        this.showNotification('–£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'success');

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        this.registerUser();

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
        this.restoreActiveSessions();
    }

    handleDisconnect(reason) {
        console.log('[Socket.IO] –û—Ç–∫–ª—é—á–µ–Ω:', reason);
        this.isConnected = false;

        this.showConnectionStatus(false);

        if (reason === 'io server disconnect') {
            this.showNotification('–°–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª—é—á–∏–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'warning');
            // –°–µ—Ä–≤–µ—Ä –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫–ª—é—á–∏–ª, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
            setTimeout(() => {
                this.socket.connect();
            }, 1000);
        } else {
            this.showNotification('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'warning');
        }
    }

    handleConnectError(error) {
        console.error('[Socket.IO] –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
        this.isConnected = false;
        this.reconnectAttempts++;

        this.showConnectionStatus(false);

        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
            this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        }
    }

    handleReconnect(attempt) {
        console.log('[Socket.IO] –£—Å–ø–µ—à–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –ø–æ–ø—ã—Ç–∫–∞:', attempt);
        this.isConnected = true;
        this.showNotification('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É', 'success');

        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–Ω–æ–≤–æ
        this.registerUser();

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏
        this.restoreActiveSessions();
    }

    handleReconnecting(attempt) {
        console.log('[Socket.IO] –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –ø–æ–ø—ã—Ç–∫–∞:', attempt);
        this.showNotification(`–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... (${attempt}/${this.maxReconnectAttempts})`, 'warning');
    }

    handleReconnectError(error) {
        console.error('[Socket.IO] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
    }

    handleReconnectFailed() {
        console.error('[Socket.IO] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è');
        this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ', 'error');
    }

    handleConnected(data) {
        console.log('[Socket.IO] –°–µ—Ä–≤–µ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:', data);
    }

    handleUserRegistered(data) {
        console.log('[Socket.IO] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', data);
        if (data.status === 'success' && data.userId) {
            this.currentUser.userId = data.userId;
            this.saveUserData();
        }
    }

    handleSessionCreated(data) {
        console.log('[Socket.IO] –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞:', data);

        if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
            this.collaborationSession.serverId = data.sessionId;
            this.sessions[data.sessionId] = {
                ...this.collaborationSession,
                serverId: data.sessionId
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –æ–∂–∏–¥–∞–Ω–∏—è
            this.waitingModal.setSession(this.collaborationSession);
        }
    }

    handleInvitationReceived(data) {
        console.log('[Socket.IO] –ü–æ–ª—É—á–µ–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ:', data);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
        this.pendingInvitations.push({
            ...data,
            receivedAt: new Date().toISOString()
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        this.invitationModal.show(data);
    }

    handleInvitationAccepted(data) {
        console.log('[Socket.IO] –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:', data);

        if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
            this.collaborationSession.partner = {
                username: data.user.username,
                avatar: data.user.avatar,
                ready: data.user.ready,
                socketId: data.user.socketId,
                userId: data.user.userId
            };

            // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –æ–∂–∏–¥–∞–Ω–∏—è
            this.waitingModal.updatePartnerInfo(this.collaborationSession.partner);

            this.showNotification(`${data.user.username} –ø—Ä–∏–Ω—è–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ`, 'success');
        }
    }

    handleInvitationSent(data) {
        console.log('[Socket.IO] –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', data);

        if (data.status === 'sent') {
            this.showNotification(`–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${data.to}`, 'success');
        }
    }

    handleInvitationDeclined(data) {
        console.log('[Socket.IO] –ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ:', data);

        if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
            this.showNotification(`${data.username} –æ—Ç–∫–ª–æ–Ω–∏–ª –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ`, 'warning');
        }
    }

    handleUserReadyStatus(data) {
        console.log('[Socket.IO] –û–±–Ω–æ–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏:', data);

        if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–∞—Ä—Ç–Ω–µ—Ä–∞
            if (this.collaborationSession.partner &&
                this.collaborationSession.partner.socketId === data.socketId) {

                this.collaborationSession.partner.ready = data.ready;
                this.waitingModal.setPartnerReady(data.ready);

                if (data.ready) {
                    this.showNotification(`${data.username} –≥–æ—Ç–æ–≤`, 'success');
                }
            }
        }
    }

    handleCodeUpdate(data) {
        console.log('[Socket.IO] –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞:', data);

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (data.from !== this.currentUser.userId && data.from !== this.currentUser.socketId) {
            this.updateCollaborationCode(data.sessionId, data.code, data.from);
        }
    }

    handleChatMessage(data) {
        console.log('[Socket.IO] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞:', data);

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Å–µ—Å—Å–∏–∏
        this.addChatMessage(
            data.user,
            data.message,
            data.timestamp,
            false,
            data.sessionId
        );
    }

    handleUserJoined(data) {
        console.log('[Socket.IO] –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è:', data);

        if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
            this.collaborationSession.participants = data.participants;
            this.showNotification(`${data.user.username} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —Å–µ—Å—Å–∏–∏`, 'info');
        }
    }

    handleUserLeft(data) {
        console.log('[Socket.IO] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–µ—Å—Å–∏–∏:', data);

        if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
            this.collaborationSession.participants = data.participants;
            this.showNotification(`${data.user.username} –≤—ã—à–µ–ª –∏–∑ —Å–µ—Å—Å–∏–∏`, 'warning');
        }
    }

    handleUserDisconnected(data) {
        console.log('[Socket.IO] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è:', data);

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–µ—Å—Å–∏–∏, –≥–¥–µ –±—ã–ª —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        Object.keys(this.sessions).forEach(sessionId => {
            const session = this.sessions[sessionId];
            if (session && session.participants) {
                session.participants = session.participants.filter(
                    p => p.socketId !== data.socketId
                );

                if (session.id === this.collaborationSession?.id) {
                    this.showNotification(`${data.username} –æ—Ç–∫–ª—é—á–∏–ª—Å—è`, 'error');
                }
            }
        });
    }

    handleSessionStarted(data) {
        console.log('[Socket.IO] –°–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞:', data);

        if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
            this.collaborationSession.started = true;
            this.collaborationSession.participants = data.participants;

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è –∏ –Ω–∞—á–∏–Ω–∞–µ–º —Å–µ—Å—Å–∏—é
            this.waitingModal.hide();
            this.startCollaborationSession(this.collaborationSession);
        }
    }

    handleSessionState(data) {
        console.log('[Socket.IO] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏:', data);

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        if (data.sessionId in this.sessions) {
            this.sessions[data.sessionId] = {
                ...this.sessions[data.sessionId],
                ...data
            };

            // –ï—Å–ª–∏ —ç—Ç–æ –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º UI
            if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
                this.collaborationSession = this.sessions[data.sessionId];
            }
        }
    }

    handleSessionInfo(data) {
        console.log('[Socket.IO] –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏:', data);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Å—Å–∏–∏
        this.sessions[data.sessionId] = data;
    }

    handleSessionCancelled(data) {
        console.log('[Socket.IO] –°–µ—Å—Å–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞:', data);

        if (data.sessionId in this.sessions) {
            delete this.sessions[data.sessionId];

            if (this.collaborationSession && this.collaborationSession.id === data.sessionId) {
                this.collaborationSession = null;
                this.waitingModal.hide();
                this.showNotification('–°–µ—Å—Å–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞', 'warning');
            }
        }
    }

    handleError(data) {
        console.error('[Socket.IO] –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', data);
        this.showNotification(data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ', 'error');
    }

    handlePong(data) {
        console.log('[Socket.IO] –û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
    }

    setupModals() {
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–∞–±–∞
        this.newTabModal.setOnCreateCallback((type, data) => {
            this.createNewTab(type, data);
        });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è
        this.waitingModal.setOnSessionStartCallback((session) => {
            this.startCollaborationSession(session);
        });

        this.waitingModal.setOnSessionCancelCallback((session) => {
            console.log('–°–µ—Å—Å–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞:', session);
            if (session && session.id && this.socket && this.isConnected) {
                this.socket.emit('cancel_session', { sessionId: session.id });
            }
            this.collaborationSession = null;
        });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π —á–µ—Ä–µ–∑ Socket.IO
        this.waitingModal.setOnInviteCallback((username) => {
            if (this.collaborationSession && this.collaborationSession.id) {
                this.sendInvitation(this.collaborationSession.id, username);
            }
        });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è
        this.invitationModal.setOnAcceptCallback((invitation) => {
            this.acceptInvitation(invitation);
        });

        this.invitationModal.setOnDeclineCallback((invitation) => {
            console.log('–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ:', invitation);
            if (invitation && invitation.sessionId && this.socket && this.isConnected) {
                this.socket.emit('decline_invitation', {
                    sessionId: invitation.sessionId,
                    from: invitation.fromUsername
                });
            }
        });
    }

    initEventListeners() {
        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–∞–±–∞
        document.getElementById('addTabBtn').addEventListener('click', () => {
            this.newTabModal.show();
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –≥–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
        document.addEventListener('keydown', (e) => {
            // Ctrl+S –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                this.saveCurrentTab();
            }

            // F5 –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–æ–¥–∞
            if (e.key === 'F5') {
                e.preventDefault();
                this.runCurrentCode();
            }
        });
    }

    loadUserData() {
        try {
            const savedUser = localStorage.getItem('codeEditorUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                this.currentUser.username = userData.username || this.currentUser.username;
                this.currentUser.avatar = userData.avatar || this.currentUser.avatar;
                this.currentUser.userId = userData.userId || this.currentUser.userId;
            } else {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º username —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const username = prompt('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à username –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã:', this.currentUser.username);
                if (username) {
                    this.currentUser.username = username;
                    this.currentUser.avatar = username.charAt(0).toUpperCase();
                    this.saveUserData();
                }
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
        }
    }

    saveUserData() {
        try {
            localStorage.setItem('codeEditorUser', JSON.stringify({
                username: this.currentUser.username,
                avatar: this.currentUser.avatar,
                userId: this.currentUser.userId
            }));
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', e);
        }
    }

    loadDataFromStorage() {
        try {
            const savedTabs = localStorage.getItem('pythonEditorTabs');
            if (savedTabs) {
                this.tabs = JSON.parse(savedTabs);
            }
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
        }
    }

    saveDataToStorage() {
        try {
            localStorage.setItem('pythonEditorTabs', JSON.stringify(this.tabs));
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', e);
        }
    }

    generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    createNewTab(type, data) {
        const id = this.generateId();
        let tab;

        if (type === 'single') {
            tab = {
                id: id,
                name: data.name || 'script.py',
                type: 'single',
                content: data.template || `# –ù–æ–≤—ã–π Python —Å–∫—Ä–∏–ø—Ç
def main():
    print("–ü—Ä–∏–≤–µ—Ç, –º–∏—Ä!")

if __name__ == "__main__":
    main()`,
                isDirty: false
            };

            this.tabs.push(tab);
            this.activeTabId = id;

            this.saveDataToStorage();
            this.renderTabs();
            this.renderActiveTab();
            this.hideNoTabMessage();

        } else if (type === 'duel' || type === 'collaborative') {
            // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é
            const sessionId = this.generateId();
            let task;

            if (type === 'duel' || data.taskType === 'random') {
                task = this.randomTasks[Math.floor(Math.random() * this.randomTasks.length)];
            } else if (data.taskType === 'custom') {
                task = {
                    title: "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞",
                    description: data.customTask || "–†–µ—à–∏—Ç–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É",
                    template: `# ${data.name || '–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞'}
# –ó–∞–¥–∞—á–∞: ${data.customTask || '–†–µ—à–∏—Ç–µ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É'}

def solve_problem():
    # –í–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ –∑–¥–µ—Å—å
    pass

if __name__ == "__main__":
    solve_problem()`
                };
            } else {
                task = this.tasks[data.taskType] || this.randomTasks[0];
            }

            this.collaborationSession = {
                id: sessionId,
                type: type,
                name: data.name || (type === 'duel' ? '–î—É—ç–ª—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è' : '–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞'),
                isCreator: true,
                task: task,
                creator: { ...this.currentUser, ready: true },
                partner: null,
                participants: [{ ...this.currentUser, ready: true }],
                invitedUsername: data.invitedUsername,
                ready: false,
                started: false
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
            this.sessions[sessionId] = this.collaborationSession;

            // –°–æ–∑–¥–∞–µ–º —Å–µ—Å—Å–∏—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
            if (this.socket && this.isConnected) {
                this.socket.emit('create_session', {
                    sessionId: sessionId,
                    type: type,
                    name: this.collaborationSession.name,
                    task: task,
                    creator: this.currentUser
                });
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è
            this.waitingModal.show(this.collaborationSession);

            // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω username, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ
            if (data.invitedUsername) {
                this.sendInvitation(sessionId, data.invitedUsername);
            }
        }

        return tab;
    }

    startCollaborationSession(session) {
        const id = this.generateId();

        const tab = {
            id: id,
            name: session.name,
            type: session.type,
            sessionId: session.id,
            isCreator: session.isCreator,
            task: session.task,
            content: session.task.template,
            isDirty: false,
            started: true,
            participants: session.participants || []
        };

        this.tabs.push(tab);
        this.activeTabId = id;

        this.saveDataToStorage();
        this.renderTabs();
        this.renderActiveTab();
        this.hideNoTabMessage();

        // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —Å–µ—Å—Å–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        if (this.socket && this.isConnected) {
            this.socket.emit('join_session', {
                sessionId: session.id
            });
        }

        this.collaborationSession = null;
    }

    acceptInvitation(invitation) {
        if (!this.socket || !this.isConnected) {
            this.showNotification('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
            return;
        }

        this.collaborationSession = {
            id: invitation.sessionId,
            type: 'collaborative',
            name: '–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å ' + invitation.from,
            isCreator: false,
            task: invitation.task,
            creator: {
                username: invitation.fromUsername || invitation.from,
                avatar: invitation.from.charAt(0).toUpperCase(),
                ready: true
            },
            partner: { ...this.currentUser, ready: true },
            participants: [],
            ready: true,
            started: false
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é
        this.sessions[invitation.sessionId] = this.collaborationSession;

        // –ü—Ä–∏–Ω–∏–º–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
        this.socket.emit('accept_invitation', {
            sessionId: invitation.sessionId,
            user: this.currentUser
        });

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ–∂–∏–¥–∞–Ω–∏—è
        this.waitingModal.show(this.collaborationSession);
    }

    // Socket.IO –º–µ—Ç–æ–¥—ã –æ—Ç–ø—Ä–∞–≤–∫–∏
    registerUser() {
        if (this.socket && this.isConnected) {
            this.socket.emit('register_user', {
                username: this.currentUser.username,
                avatar: this.currentUser.avatar
            });
        }
    }

    sendInvitation(sessionId, username) {
        if (this.socket && this.isConnected) {
            this.socket.emit('invite_user', {
                sessionId: sessionId,
                username: username,
                from: this.currentUser.username
            });
        } else {
            this.showNotification('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
        }
    }

    sendReadyStatus(sessionId, isReady) {
        if (this.socket && this.isConnected) {
            this.socket.emit('user_ready', {
                sessionId: sessionId,
                ready: isReady
            });
        }
    }

    sendCodeUpdate(sessionId, code) {
        if (this.socket && this.isConnected) {
            this.socket.emit('code_update', {
                sessionId: sessionId,
                code: code,
                userId: this.currentUser.userId || this.currentUser.username
            });
        }
    }

    sendChatMessage(sessionId, message) {
        if (this.socket && this.isConnected) {
            this.socket.emit('chat_message', {
                sessionId: sessionId,
                message: message,
                user: {
                    username: this.currentUser.username,
                    avatar: this.currentUser.avatar
                }
            });
        }
    }

    updateCollaborationCode(sessionId, code, fromUserId) {
        // –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É —Å —ç—Ç–æ–π —Å–µ—Å—Å–∏–µ–π
        const tab = this.tabs.find(t => t.sessionId === sessionId && t.type !== 'single');
        if (!tab || !this.activeTabId || tab.id !== this.activeTabId) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –æ—Ç –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const editorData = this.codeEditors[this.activeTabId];
        if (editorData && editorData.editor && editorData.sessionId === sessionId) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
            const cursor = editorData.editor.getCursor();
            const scroll = editorData.editor.getScrollInfo();

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            editorData.editor.setValue(code);

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∫—É—Ä—Å–æ—Ä–∞
            editorData.editor.setCursor(cursor);
            editorData.editor.scrollTo(scroll.left, scroll.top);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
            tab.content = code;
            tab.isDirty = true;
            this.saveDataToStorage();
            this.renderTabs();
        }
    }

    addChatMessage(user, message, timestamp, isOwn = false, sessionId = null) {
        // –ù–∞—Ö–æ–¥–∏–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É —Å —ç—Ç–æ–π —Å–µ—Å—Å–∏–µ–π
        let chatMessages;
        if (sessionId) {
            const tab = this.tabs.find(t => t.sessionId === sessionId);
            if (tab && this.activeTabId && tab.id === this.activeTabId) {
                chatMessages = document.getElementById('chatMessages');
            }
        } else {
            chatMessages = document.getElementById('chatMessages');
        }

        if (!chatMessages) return;

        const time = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${isOwn ? 'own' : 'other'}`;
        messageElement.innerHTML = `
            <div class="chat-message-header">
                <div class="chat-user-avatar">${user.avatar}</div>
                <div class="chat-user-name">${user.username}</div>
                <div class="chat-time">${time}</div>
            </div>
            <div class="chat-message-content">${this.escapeHtml(message)}</div>
        `;

        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    restoreActiveSessions() {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        Object.keys(this.sessions).forEach(sessionId => {
            const session = this.sessions[sessionId];
            if (session && !session.started) {
                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ —Å–µ—Å—Å–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                if (this.socket && this.isConnected) {
                    this.socket.emit('join_session', { sessionId: sessionId });
                }
            }
        });
    }

    checkUrlForInvitation() {
        const urlParams = new URLSearchParams(window.location.search);
        const inviteId = urlParams.get('invite');
        const inviteType = urlParams.get('type');
        const inviteName = urlParams.get('name');

        if (inviteId) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                const invitation = {
                    sessionId: inviteId,
                    from: inviteName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                    fromUsername: inviteName || 'user',
                    type: inviteType || 'collaborative',
                    task: {
                        title: '–°–æ–≤–º–µ—Å—Ç–Ω–æ–µ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ',
                        description: '–ü—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –ø–æ —Å—Å—ã–ª–∫–µ'
                    },
                    sessionName: '–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞'
                };

                this.invitationModal.show(invitation);
            }, 1000);
        }
    }

    // UI –º–µ—Ç–æ–¥—ã
    renderTabs() {
        const tabsContainer = document.getElementById('tabsContainer');
        if (!tabsContainer) return;

        tabsContainer.innerHTML = '';

        this.tabs.forEach(tab => {
            const tabElement = document.createElement('div');
            tabElement.className = `tab ${tab.id === this.activeTabId ? 'active' : ''} ${tab.isDirty ? 'dirty' : ''}`;
            tabElement.dataset.tabId = tab.id;

            let icon = 'fa-file-code';
            let badge = '';
            if (tab.type === 'duel') {
                icon = 'fa-user-friends';
                badge = `<span class="tab-badge">2</span>`;
            } else if (tab.type === 'collaborative') {
                icon = 'fa-users';
                badge = `<span class="tab-badge">${tab.participants ? tab.participants.length : 2}</span>`;
            }

            tabElement.innerHTML = `
                <i class="fas ${icon} tab-icon"></i>
                <span class="tab-name">${tab.name}</span>
                ${badge}
                <i class="fas fa-times tab-close"></i>
            `;

            // –°–æ–±—ã—Ç–∏–µ –∫–ª–∏–∫–∞ –Ω–∞ —Ç–∞–±
            tabElement.addEventListener('click', (e) => {
                if (!e.target.classList.contains('tab-close')) {
                    this.switchTab(tab.id);
                }
            });

            // –°–æ–±—ã—Ç–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–∞–±–∞
            const closeBtn = tabElement.querySelector('.tab-close');
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.closeTab(tab.id);
            });

            tabsContainer.appendChild(tabElement);
        });
    }

    renderActiveTab() {
        const activeTab = this.tabs.find(t => t.id === this.activeTabId);
        if (!activeTab) {
            this.showNoTabMessage();
            return;
        }

        const editorContainer = document.getElementById('editorContainer');
        if (!editorContainer) return;

        if (activeTab.type === 'single') {
            this.renderSingleEditor(activeTab, editorContainer);
        } else if (activeTab.type === 'duel' || activeTab.type === 'collaborative') {
            this.renderCollaborationEditor(activeTab, editorContainer);
        }
    }

    renderSingleEditor(tab, container) {
        container.innerHTML = `
            <div class="single-editor">
                <div class="single-header">
                    <div class="single-info">
                        <div class="single-icon">
                            <i class="fab fa-python"></i>
                        </div>
                        <div class="single-title">${tab.name}</div>
                    </div>
                    <button class="tab-run-btn" id="tabRunBtn">
                        <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å
                    </button>
                </div>
                <div class="code-mirror-wrapper">
                    <textarea id="codeEditor">${tab.content}</textarea>
                </div>
            </div>
            <div class="console-container">
                <div class="console-header">
                    <div class="console-title">
                        <i class="fas fa-terminal"></i> –ö–æ–Ω—Å–æ–ª—å
                    </div>
                    <div class="console-actions">
                        <button class="console-btn" id="clearConsoleBtn">
                            <i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </div>
                <div class="console-output" id="consoleOutput">
                    <div class="console-line info">–ì–æ—Ç–æ–≤ –∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∫–æ–¥–∞</div>
                </div>
            </div>
        `;

        this.initSingleEditor(tab);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('tabRunBtn').addEventListener('click', () => {
            this.runCode(tab.id);
        });

        document.getElementById('clearConsoleBtn').addEventListener('click', () => {
            this.clearConsole();
        });
    }

    renderCollaborationEditor(tab, container) {
        const isCurrentUserCreator = tab.isCreator ||
            (tab.participants && tab.participants[0] &&
             tab.participants[0].username === this.currentUser.username);

        container.innerHTML = `
            <div class="collaboration-editor">
                <div class="collaboration-header">
                    <div class="collaboration-info">
                        <div class="collaboration-icon">
                            <i class="fas ${tab.type === 'duel' ? 'fa-user-friends' : 'fa-users'}"></i>
                        </div>
                        <div class="collaboration-title">
                            <div>${tab.name}</div>
                            <div class="collaboration-task-title">–ó–∞–¥–∞—á–∞: ${tab.task.title}</div>
                        </div>
                        <div class="collaboration-status">
                            <span class="status-badge">${tab.type === 'duel' ? '–î—É—ç–ª—å' : '–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Ä–∞–±–æ—Ç–∞'}</span>
                            ${this.isConnected ?
                                '<span class="connection-status connected"><i class="fas fa-wifi"></i> Online</span>' :
                                '<span class="connection-status disconnected"><i class="fas fa-wifi-slash"></i> Offline</span>'}
                        </div>
                    </div>
                    <div class="collaboration-controls">
                        <div class="participants-display">
                            ${tab.participants ? tab.participants.map(p => `
                                <div class="participant-mini" title="${p.username}">
                                    <div class="participant-mini-avatar">${p.avatar}</div>
                                </div>
                            `).join('') : ''}
                        </div>
                        <button class="tab-run-btn" id="tabRunBtn">
                            <i class="fas fa-play"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ
                        </button>
                    </div>
                </div>

                <div class="task-description">
                    <div class="task-description-content">
                        <strong>–ó–∞–¥–∞—á–∞:</strong> ${tab.task.description}
                    </div>
                </div>

                <div class="collaboration-participants">
                    ${tab.participants ? tab.participants.map((participant, index) => `
                        <div class="collaboration-participant ${participant.username === this.currentUser.username ? 'current-user' : ''}">
                            <div class="participant-header">
                                <div class="participant-info">
                                    <div class="participant-avatar">${participant.avatar}</div>
                                    <div class="participant-name">
                                        ${participant.username}
                                        ${participant.username === this.currentUser.username ? ' (–í—ã)' : ''}
                                    </div>
                                </div>
                                <div class="participant-status">
                                    <span class="status-active"><i class="fas fa-circle"></i> Online</span>
                                </div>
                            </div>
                            <div class="code-mirror-wrapper">
                                <textarea class="collaboration-code-editor" id="codeEditor_${index}">
                                    ${participant.username === this.currentUser.username ? tab.content : ''}
                                </textarea>
                            </div>
                        </div>
                    `).join('') : `
                        <div class="collaboration-participant current-user">
                            <div class="participant-header">
                                <div class="participant-info">
                                    <div class="participant-avatar">${this.currentUser.avatar}</div>
                                    <div class="participant-name">
                                        ${this.currentUser.username} (–í—ã)
                                    </div>
                                </div>
                                <div class="participant-status">
                                    <span class="status-active"><i class="fas fa-circle"></i> Online</span>
                                </div>
                            </div>
                            <div class="code-mirror-wrapper">
                                <textarea class="collaboration-code-editor" id="codeEditor_0">${tab.content}</textarea>
                            </div>
                        </div>
                    `}
                </div>

                <div class="chat-section">
                    <div class="chat-header">
                        <i class="fas fa-comments"></i> –ß–∞—Ç
                        <span class="chat-counter" id="chatCounter">0</span>
                    </div>
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input">
                        <input type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." id="chatInput">
                        <button id="sendChatBtn"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>

                <div class="console-container">
                    <div class="console-header">
                        <div class="console-title">
                            <i class="fas fa-terminal"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏
                        </div>
                        <div class="console-actions">
                            <button class="console-btn" id="toggleChatBtn">
                                <i class="fas fa-comments"></i> –ß–∞—Ç
                            </button>
                            <button class="console-btn" id="clearConsoleBtn">
                                <i class="fas fa-broom"></i> –û—á–∏—Å—Ç–∏—Ç—å
                            </button>
                        </div>
                    </div>
                    <div class="console-output" id="consoleOutput">
                        <div class="console-line info">${tab.type === 'duel' ? '–î—É—ç–ª—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞—á–∞—Ç–∞' : '–°–æ–≤–º–µ—Å—Ç–Ω–∞—è —Å–µ—Å—Å–∏—è –Ω–∞—á–∞—Ç–∞'}</div>
                        <div class="console-line info">–ó–∞–¥–∞—á–∞: ${tab.task.title}</div>
                        <div class="console-line info">–£—á–∞—Å—Ç–Ω–∏–∫–∏: ${tab.participants ? tab.participants.map(p => p.username).join(', ') : this.currentUser.username}</div>
                        ${this.isConnected ?
                            '<div class="console-line success">‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É</div>' :
                            '<div class="console-line error">‚úó –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É</div>'}
                    </div>
                </div>
            </div>
        `;

        this.initCollaborationEditor(tab);

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        document.getElementById('tabRunBtn').addEventListener('click', () => {
            this.runCollaborationCode(tab.id);
        });

        document.getElementById('clearConsoleBtn').addEventListener('click', () => {
            this.clearConsole();
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —á–∞—Ç–∞
        const chatInput = document.getElementById('chatInput');
        const sendChatBtn = document.getElementById('sendChatBtn');
        const toggleChatBtn = document.getElementById('toggleChatBtn');
        const chatSection = document.querySelector('.chat-section');

        if (chatInput && sendChatBtn) {
            const sendMessage = () => {
                const message = chatInput.value.trim();
                if (message && tab.sessionId) {
                    this.sendChatMessage(tab.sessionId, message);
                    this.addChatMessage(
                        { username: this.currentUser.username, avatar: this.currentUser.avatar },
                        message,
                        new Date().toISOString(),
                        true,
                        tab.sessionId
                    );
                    chatInput.value = '';
                    this.updateChatCounter();
                }
            };

            sendChatBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        if (toggleChatBtn && chatSection) {
            toggleChatBtn.addEventListener('click', () => {
                chatSection.style.display = chatSection.style.display === 'none' ? 'block' : 'none';
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        this.updateChatCounter();
    }

    initSingleEditor(tab) {
        const textarea = document.getElementById('codeEditor');
        if (!textarea) return;

        const editor = CodeMirror.fromTextArea(textarea, {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: false,
            styleActiveLine: true,
            extraKeys: {
                "Ctrl-S": () => this.saveCurrentTab(),
                "F5": () => this.runCode(this.activeTabId)
            }
        });

        this.codeEditors[this.activeTabId] = editor;

        editor.on('change', () => {
            const tabIndex = this.tabs.findIndex(t => t.id === this.activeTabId);
            if (tabIndex !== -1) {
                this.tabs[tabIndex].content = editor.getValue();
                this.tabs[tabIndex].isDirty = true;
                this.saveDataToStorage();
                this.renderTabs();
            }
        });
    }

    initCollaborationEditor(tab) {
        const participants = tab.participants || [{ ...this.currentUser }];
        const userIndex = participants.findIndex(p => p.username === this.currentUser.username);

        if (userIndex === -1) {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–ø–∏—Å–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
            participants.push({ ...this.currentUser });
        }

        const textarea = document.getElementById(`codeEditor_${userIndex !== -1 ? userIndex : participants.length - 1}`);
        if (!textarea) return;

        const editor = CodeMirror.fromTextArea(textarea, {
            mode: 'python',
            theme: 'monokai',
            lineNumbers: true,
            matchBrackets: true,
            indentUnit: 4,
            tabSize: 4,
            lineWrapping: false,
            styleActiveLine: true,
            extraKeys: {
                "F5": () => this.runCollaborationCode(this.activeTabId)
            }
        });

        this.codeEditors[this.activeTabId] = {
            editor,
            userIndex: userIndex !== -1 ? userIndex : participants.length - 1,
            sessionId: tab.sessionId
        };

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –¥–µ–±–∞—É–Ω—Å–æ–º
        let changeTimeout = null;
        editor.on('change', () => {
            const tabIndex = this.tabs.findIndex(t => t.id === this.activeTabId);
            if (tabIndex !== -1) {
                this.tabs[tabIndex].content = editor.getValue();
                this.tabs[tabIndex].isDirty = true;
                this.saveDataToStorage();
                this.renderTabs();

                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å –¥–µ–±–∞—É–Ω—Å–æ–º
                if (tab.sessionId) {
                    clearTimeout(changeTimeout);
                    changeTimeout = setTimeout(() => {
                        this.sendCodeUpdate(tab.sessionId, editor.getValue());
                    }, 300); // –î–µ–±–∞—É–Ω—Å 300ms
                }
            }
        });

        // –î—Ä—É–≥–∏–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —á—Ç–µ–Ω–∏—è)
        participants.forEach((participant, index) => {
            if (index !== (userIndex !== -1 ? userIndex : participants.length - 1)) {
                const otherTextarea = document.getElementById(`codeEditor_${index}`);
                if (otherTextarea) {
                    CodeMirror.fromTextArea(otherTextarea, {
                        mode: 'python',
                        theme: 'monokai',
                        lineNumbers: true,
                        matchBrackets: true,
                        readOnly: true
                    });
                }
            }
        });
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    switchTab(tabId) {
        this.activeTabId = tabId;
        this.renderTabs();
        this.renderActiveTab();
    }

    closeTab(tabId) {
        const tabIndex = this.tabs.findIndex(t => t.id === tabId);
        if (tabIndex === -1) return;

        const tab = this.tabs[tabIndex];

        // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Å–µ—Å—Å–∏–∏ –µ—Å–ª–∏ —ç—Ç–æ —Å–æ–≤–º–µ—Å—Ç–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
        if (tab.sessionId && this.socket && this.isConnected) {
            this.socket.emit('leave_session', { sessionId: tab.sessionId });
        }

        this.tabs.splice(tabIndex, 1);
        delete this.codeEditors[tabId];

        if (tabId === this.activeTabId) {
            if (this.tabs.length > 0) {
                this.activeTabId = this.tabs[0].id;
                this.renderActiveTab();
            } else {
                this.activeTabId = null;
                this.showNoTabMessage();
            }
        }

        this.saveDataToStorage();
        this.renderTabs();
    }

    runCode(tabId) {
        const tab = this.tabs.find(t => t.id === tabId);
        if (!tab) return;

        let code = '';
        if (tab.type === 'single') {
            const editor = this.codeEditors[tabId];
            if (!editor) return;
            code = editor.getValue();
        }

        this.executeCode(code, false);
    }

    runCollaborationCode(tabId) {
        const tab = this.tabs.find(t => t.id === tabId);
        if (!tab) return;

        const editorData = this.codeEditors[tabId];
        if (!editorData || !editorData.editor) return;

        const code = editorData.editor.getValue();
        this.executeCode(code, true, tab.task.title);
    }

    runCurrentCode() {
        if (!this.activeTabId) return;

        const tab = this.tabs.find(t => t.id === this.activeTabId);
        if (!tab) return;

        if (tab.type === 'single') {
            this.runCode(this.activeTabId);
        } else if (tab.type === 'duel' || tab.type === 'collaborative') {
            this.runCollaborationCode(this.activeTabId);
        }
    }

    executeCode(code, isCollaboration = false, taskTitle = '') {
        const runBtn = document.getElementById('tabRunBtn');
        if (!runBtn) return;

        const originalText = runBtn.innerHTML;

        runBtn.disabled = true;
        runBtn.innerHTML = '<div class="loading"></div> –ü—Ä–æ–≤–µ—Ä–∫–∞...';

        this.addConsoleMessage('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—à–µ–Ω–∏—è...', 'info');

        // –ò–º–∏—Ç–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–¥–∞
        setTimeout(() => {
            try {
                if (isCollaboration) {
                    this.addConsoleMessage(`=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–¥–∞—á–∏ "${taskTitle}" ===`, 'success');

                    const tests = [
                        '–¢–µ—Å—Ç 1: ‚úì –ü—Ä–æ–π–¥–µ–Ω',
                        '–¢–µ—Å—Ç 2: ‚úì –ü—Ä–æ–π–¥–µ–Ω',
                        '–¢–µ—Å—Ç 3: ‚úó –ù–µ –ø—Ä–æ–π–¥–µ–Ω',
                        '–¢–µ—Å—Ç 4: ‚úì –ü—Ä–æ–π–¥–µ–Ω',
                        '–¢–µ—Å—Ç 5: ‚úì –ü—Ä–æ–π–¥–µ–Ω'
                    ];

                    tests.forEach(test => {
                        this.addConsoleMessage(test, test.includes('‚úì') ? 'success' : 'error');
                    });

                    const score = Math.floor(Math.random() * 100);
                    this.addConsoleMessage(`–†–µ–∑—É–ª—å—Ç–∞—Ç: ${score}/100 –±–∞–ª–ª–æ–≤`, 'info');

                    if (score > 70) {
                        this.addConsoleMessage('–û—Ç–ª–∏—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!', 'success');
                    } else {
                        this.addConsoleMessage('–ú–æ–∂–Ω–æ –ª—É—á—à–µ, –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Ä–∞–±–æ—Ç–∞—Ç—å!', 'warning');
                    }
                } else {
                    this.addConsoleMessage('–ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    this.addConsoleMessage('–†–µ–∑—É–ª—å—Ç–∞—Ç: 42', 'output');
                }
            } catch (error) {
                this.addConsoleMessage(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
            } finally {
                runBtn.disabled = false;
                runBtn.innerHTML = isCollaboration ?
                    '<i class="fas fa-play"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ' :
                    '<i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å';
            }
        }, 1500);
    }

    addConsoleMessage(text, type = 'info') {
        const consoleOutput = document.getElementById('consoleOutput');
        if (!consoleOutput) return;

        const line = document.createElement('div');
        line.className = `console-line ${type}`;
        line.textContent = text;
        consoleOutput.appendChild(line);

        consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    clearConsole() {
        const consoleOutput = document.getElementById('consoleOutput');
        if (!consoleOutput) return;

        consoleOutput.innerHTML = '';
        this.addConsoleMessage('–ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞', 'info');
    }

    updateChatCounter() {
        const chatCounter = document.getElementById('chatCounter');
        if (!chatCounter) return;

        const chatMessages = document.getElementById('chatMessages');
        if (!chatMessages) return;

        const messageCount = chatMessages.children.length;
        chatCounter.textContent = messageCount;
        chatCounter.style.display = messageCount > 0 ? 'inline-block' : 'none';
    }

    showNoTabMessage() {
        const editorContainer = document.getElementById('editorContainer');
        if (editorContainer) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º Django include –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        }
    }

    hideNoTabMessage() {
        const noTabMessage = document.getElementById('noTabMessage');
        if (noTabMessage) {
            noTabMessage.style.display = 'none';
        }
    }

    saveCurrentTab() {
        const tab = this.tabs.find(t => t.id === this.activeTabId);
        if (!tab) return;

        if (tab.type === 'single') {
            const editor = this.codeEditors[this.activeTabId];
            if (editor) {
                tab.content = editor.getValue();
                tab.isDirty = false;
            }
        } else if (tab.type === 'duel' || tab.type === 'collaborative') {
            const editorData = this.codeEditors[this.activeTabId];
            if (editorData && editorData.editor) {
                tab.content = editorData.editor.getValue();
                tab.isDirty = false;
            }
        }

        this.saveDataToStorage();
        this.renderTabs();

        this.addConsoleMessage('–ü—Ä–æ–≥—Ä–µ—Å—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
    }

    showConnectionStatus(isConnected) {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ UI
        const statusElements = document.querySelectorAll('.connection-status');
        statusElements.forEach(el => {
            if (isConnected) {
                el.className = 'connection-status connected';
                el.innerHTML = '<i class="fas fa-wifi"></i> Online';
            } else {
                el.className = 'connection-status disconnected';
                el.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
            }
        });
    }

    showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-circle' :
                              type === 'warning' ? 'exclamation-triangle' :
                              type === 'success' ? 'check-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        `;

        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–µ–ª–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        document.body.appendChild(notification);

        // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }

    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // –¢–µ—Å—Ç–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
    testSocketConnection() {
        if (this.socket && this.isConnected) {
            this.socket.emit('ping', { message: 'test' });
            console.log('–¢–µ—Å—Ç–æ–≤—ã–π ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
        } else {
            console.log('Socket.IO –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
        }
    }

    getSessionInfo(sessionId) {
        if (this.socket && this.isConnected) {
            this.socket.emit('get_session_info', { sessionId: sessionId });
        }
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
window.testSocket = () => {
    if (window.codeEditor) {
        window.codeEditor.testSocketConnection();
    }
};

window.getSession = (sessionId) => {
    if (window.codeEditor) {
        window.codeEditor.getSessionInfo(sessionId);
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    window.codeEditor = new CodeEditor();

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    window.debug = {
        editor: window.codeEditor,
        test: window.testSocket,
        getSession: window.getSession
    };
});

     */
</script>
</body>
</html>